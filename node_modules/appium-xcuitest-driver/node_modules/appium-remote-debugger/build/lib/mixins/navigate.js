"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _events = _interopRequireDefault(require("./events"));

var _support = require("appium/support");

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

function frameDetached() {
  this.emit(_events.default.EVENT_FRAMES_DETACHED);
}

async function pageLoad(startPageLoadTimer, pageLoadVerifyHook = _lodash.default.noop) {
  var _startPageLoadTimer;

  const timeoutMs = 500;

  if (!_lodash.default.isFunction((_startPageLoadTimer = startPageLoadTimer) === null || _startPageLoadTimer === void 0 ? void 0 : _startPageLoadTimer.getDuration)) {
    _logger.default.debug(`Page load timer not a timer. Creating new timer`);

    startPageLoadTimer = new _support.timing.Timer().start();
  }

  _logger.default.debug('Page loaded, verifying whether ready');

  this.pageLoading = true;

  const verify = async () => {
    this.pageLoadDelay = _support.util.cancellableDelay(timeoutMs);

    try {
      await this.pageLoadDelay;
    } catch (err) {
      if (err instanceof _bluebird.default.CancellationError) {
        return;
      }
    }

    if (!this.appIdKey) {
      _logger.default.debug('Not connected to an application. Ignoring page load');

      return;
    }

    if (_lodash.default.isFunction(pageLoadVerifyHook)) {
      await pageLoadVerifyHook();
    }

    const elapsedMs = startPageLoadTimer.getDuration().asMilliSeconds;

    if ((await this.checkPageIsReady()) || this.pageLoadMs > 0 && elapsedMs > this.pageLoadMs) {
      _logger.default.debug('Page is ready');

      this.pageLoading = false;
    } else {
      _logger.default.debug('Page was not ready, retrying');

      await verify();
    }
  };

  try {
    await verify();
  } finally {
    _logger.default.debug(`Page load completed in ${startPageLoadTimer.getDuration().asMilliSeconds.toFixed(0)}ms`);

    this.pageLoading = false;
  }
}

function cancelPageLoad() {
  _logger.default.debug('Unregistering from page readiness notifications');

  this.pageLoading = false;

  if (this.pageLoadDelay) {
    this.pageLoadDelay.cancel();
  }
}

async function pageUnload() {
  _logger.default.debug('Page unloading');

  await this.waitForDom();
}

async function waitForDom(startPageLoadTimer, pageLoadVerifyHook) {
  _logger.default.debug('Waiting for dom...');

  await this.pageLoad(startPageLoadTimer, pageLoadVerifyHook);
}

async function checkPageIsReady() {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey
  });

  _logger.default.debug('Checking document readyState');

  const readyCmd = 'document.readyState;';
  let readyState = 'loading';

  try {
    readyState = await _bluebird.default.resolve(this.execute(readyCmd, true)).timeout(this.pageReadyTimeout);
  } catch (err) {
    if (!(err instanceof _bluebird.default.TimeoutError)) {
      throw err;
    }

    _logger.default.debug(`Page readiness check timed out after ${this.pageReadyTimeout}ms`);

    return false;
  }

  _logger.default.debug(`Document readyState is '${readyState}'`);

  return readyState === 'complete';
}

async function navToUrl(url, pageLoadVerifyHook) {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });
  this._navigatingToPage = true;

  try {
    _logger.default.debug(`Navigating to new URL: '${url}'`);

    const waitForFramePromise = this.waitForFrameNavigated();
    await this.rpcClient.send('Page.navigate', {
      url,
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });

    if (!this.useNewSafari) {
      await _bluebird.default.delay(1000);
    }

    await waitForFramePromise;
    await this.waitForDom(new _support.timing.Timer().start(), pageLoadVerifyHook);
    await this.rpcClient.send('Console.enable', {
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });
  } finally {
    this._navigatingToPage = false;
  }
}

async function waitForFrameNavigated() {
  let navEventListener;
  return await new _bluebird.default(async resolve => {
    _logger.default.debug('Waiting for frame navigated message...');

    const start = new _support.timing.Timer().start();

    navEventListener = (err, value) => {
      _logger.default.debug(`Frame navigated in ${start.getDuration().asMilliSeconds.toFixed(0)}ms from: ${value}`);

      if (!this.allowNavigationWithoutReload && !this.pageLoading) {
        resolve(value);
      } else {
        _logger.default.debug('Frame navigated but we were warned about it, not ' + 'considering page state unloaded');

        this.allowNavigationWithoutReload = false;
      }

      if (this.navigationDelay) {
        this.navigationDelay.cancel();
      }
    };

    this.rpcClient.once('Page.frameNavigated', navEventListener);

    if (!this.useNewSafari || this.pageLoadMs >= 0) {
      const timeout = this.useNewSafari ? this.pageLoadMs : 500;
      this.navigationDelay = _support.util.cancellableDelay(timeout);

      try {
        await this.navigationDelay;
        navEventListener(null, `${timeout}ms timeout`);
      } catch (err) {}
    }
  }).finally(() => {
    if (navEventListener) {
      this.rpcClient.off('Page.frameNavigated', navEventListener);
    }
  });
}

var _default = {
  frameDetached,
  pageLoad,
  cancelPageLoad,
  pageUnload,
  waitForDom,
  checkPageIsReady,
  navToUrl,
  waitForFrameNavigated
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcmFtZURldGFjaGVkIiwiZW1pdCIsImV2ZW50cyIsIkVWRU5UX0ZSQU1FU19ERVRBQ0hFRCIsInBhZ2VMb2FkIiwic3RhcnRQYWdlTG9hZFRpbWVyIiwicGFnZUxvYWRWZXJpZnlIb29rIiwiXyIsIm5vb3AiLCJ0aW1lb3V0TXMiLCJpc0Z1bmN0aW9uIiwiZ2V0RHVyYXRpb24iLCJsb2ciLCJkZWJ1ZyIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJwYWdlTG9hZGluZyIsInZlcmlmeSIsInBhZ2VMb2FkRGVsYXkiLCJ1dGlsIiwiY2FuY2VsbGFibGVEZWxheSIsImVyciIsIkIiLCJDYW5jZWxsYXRpb25FcnJvciIsImFwcElkS2V5IiwiZWxhcHNlZE1zIiwiYXNNaWxsaVNlY29uZHMiLCJjaGVja1BhZ2VJc1JlYWR5IiwicGFnZUxvYWRNcyIsInRvRml4ZWQiLCJjYW5jZWxQYWdlTG9hZCIsImNhbmNlbCIsInBhZ2VVbmxvYWQiLCJ3YWl0Rm9yRG9tIiwiY2hlY2tQYXJhbXMiLCJyZWFkeUNtZCIsInJlYWR5U3RhdGUiLCJyZXNvbHZlIiwiZXhlY3V0ZSIsInRpbWVvdXQiLCJwYWdlUmVhZHlUaW1lb3V0IiwiVGltZW91dEVycm9yIiwibmF2VG9VcmwiLCJ1cmwiLCJwYWdlSWRLZXkiLCJfbmF2aWdhdGluZ1RvUGFnZSIsIndhaXRGb3JGcmFtZVByb21pc2UiLCJ3YWl0Rm9yRnJhbWVOYXZpZ2F0ZWQiLCJycGNDbGllbnQiLCJzZW5kIiwidXNlTmV3U2FmYXJpIiwiZGVsYXkiLCJuYXZFdmVudExpc3RlbmVyIiwidmFsdWUiLCJhbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkIiwibmF2aWdhdGlvbkRlbGF5Iiwib25jZSIsImZpbmFsbHkiLCJvZmYiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvbWl4aW5zL25hdmlnYXRlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGNoZWNrUGFyYW1zIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IGV2ZW50cyBmcm9tICcuL2V2ZW50cyc7XG5pbXBvcnQgeyB0aW1pbmcsIHV0aWwgfSBmcm9tICdhcHBpdW0vc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbmZ1bmN0aW9uIGZyYW1lRGV0YWNoZWQgKCkge1xuICB0aGlzLmVtaXQoZXZlbnRzLkVWRU5UX0ZSQU1FU19ERVRBQ0hFRCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhZ2VMb2FkIChzdGFydFBhZ2VMb2FkVGltZXIsIHBhZ2VMb2FkVmVyaWZ5SG9vayA9IF8ubm9vcCkge1xuICBjb25zdCB0aW1lb3V0TXMgPSA1MDA7XG4gIGlmICghXy5pc0Z1bmN0aW9uKHN0YXJ0UGFnZUxvYWRUaW1lcj8uZ2V0RHVyYXRpb24pKSB7XG4gICAgbG9nLmRlYnVnKGBQYWdlIGxvYWQgdGltZXIgbm90IGEgdGltZXIuIENyZWF0aW5nIG5ldyB0aW1lcmApO1xuICAgIHN0YXJ0UGFnZUxvYWRUaW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICB9XG5cbiAgbG9nLmRlYnVnKCdQYWdlIGxvYWRlZCwgdmVyaWZ5aW5nIHdoZXRoZXIgcmVhZHknKTtcbiAgdGhpcy5wYWdlTG9hZGluZyA9IHRydWU7XG5cbiAgY29uc3QgdmVyaWZ5ID0gYXN5bmMgKCkgPT4ge1xuICAgIHRoaXMucGFnZUxvYWREZWxheSA9IHV0aWwuY2FuY2VsbGFibGVEZWxheSh0aW1lb3V0TXMpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnBhZ2VMb2FkRGVsYXk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgQi5DYW5jZWxsYXRpb25FcnJvcikge1xuICAgICAgICAvLyBpZiB0aGUgcHJvbWlzZSBoYXMgYmVlbiBjYW5jZWxsZWRcbiAgICAgICAgLy8gd2Ugd2FudCB0byBza2lwIGNoZWNraW5nIHRoZSByZWFkaW5lc3NcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIHdlIGNhbiBnZXQgdGhpcyBjYWxsZWQgaW4gdGhlIG1pZGRsZSBvZiB0cnlpbmcgdG8gZmluZCBhIG5ldyBhcHBcbiAgICBpZiAoIXRoaXMuYXBwSWRLZXkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnTm90IGNvbm5lY3RlZCB0byBhbiBhcHBsaWNhdGlvbi4gSWdub3JpbmcgcGFnZSBsb2FkJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKF8uaXNGdW5jdGlvbihwYWdlTG9hZFZlcmlmeUhvb2spKSB7XG4gICAgICBhd2FpdCBwYWdlTG9hZFZlcmlmeUhvb2soKTtcbiAgICB9XG5cbiAgICAvLyBpZiB3ZSBhcmUgcmVhZHksIG9yIHdlJ3ZlIHNwZW5kIHRvbyBtdWNoIHRpbWUgb24gdGhpc1xuICAgIGNvbnN0IGVsYXBzZWRNcyA9IHN0YXJ0UGFnZUxvYWRUaW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzO1xuICAgIGlmIChhd2FpdCB0aGlzLmNoZWNrUGFnZUlzUmVhZHkoKSB8fCAodGhpcy5wYWdlTG9hZE1zID4gMCAmJiBlbGFwc2VkTXMgPiB0aGlzLnBhZ2VMb2FkTXMpKSB7XG4gICAgICBsb2cuZGVidWcoJ1BhZ2UgaXMgcmVhZHknKTtcbiAgICAgIHRoaXMucGFnZUxvYWRpbmcgPSBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKCdQYWdlIHdhcyBub3QgcmVhZHksIHJldHJ5aW5nJyk7XG4gICAgICBhd2FpdCB2ZXJpZnkoKTtcbiAgICB9XG4gIH07XG4gIHRyeSB7XG4gICAgYXdhaXQgdmVyaWZ5KCk7XG4gIH0gZmluYWxseSB7XG4gICAgbG9nLmRlYnVnKGBQYWdlIGxvYWQgY29tcGxldGVkIGluICR7c3RhcnRQYWdlTG9hZFRpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tc2ApO1xuICAgIHRoaXMucGFnZUxvYWRpbmcgPSBmYWxzZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYW5jZWxQYWdlTG9hZCAoKSB7XG4gIGxvZy5kZWJ1ZygnVW5yZWdpc3RlcmluZyBmcm9tIHBhZ2UgcmVhZGluZXNzIG5vdGlmaWNhdGlvbnMnKTtcbiAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuICBpZiAodGhpcy5wYWdlTG9hZERlbGF5KSB7XG4gICAgdGhpcy5wYWdlTG9hZERlbGF5LmNhbmNlbCgpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhZ2VVbmxvYWQgKCkge1xuICBsb2cuZGVidWcoJ1BhZ2UgdW5sb2FkaW5nJyk7XG4gIGF3YWl0IHRoaXMud2FpdEZvckRvbSgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB3YWl0Rm9yRG9tIChzdGFydFBhZ2VMb2FkVGltZXIsIHBhZ2VMb2FkVmVyaWZ5SG9vaykge1xuICBsb2cuZGVidWcoJ1dhaXRpbmcgZm9yIGRvbS4uLicpO1xuICBhd2FpdCB0aGlzLnBhZ2VMb2FkKHN0YXJ0UGFnZUxvYWRUaW1lciwgcGFnZUxvYWRWZXJpZnlIb29rKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tQYWdlSXNSZWFkeSAoKSB7XG4gIGNoZWNrUGFyYW1zKHthcHBJZEtleTogdGhpcy5hcHBJZEtleX0pO1xuXG4gIGxvZy5kZWJ1ZygnQ2hlY2tpbmcgZG9jdW1lbnQgcmVhZHlTdGF0ZScpO1xuICBjb25zdCByZWFkeUNtZCA9ICdkb2N1bWVudC5yZWFkeVN0YXRlOyc7XG4gIGxldCByZWFkeVN0YXRlID0gJ2xvYWRpbmcnO1xuICB0cnkge1xuICAgIHJlYWR5U3RhdGUgPSBhd2FpdCBCLnJlc29sdmUodGhpcy5leGVjdXRlKHJlYWR5Q21kLCB0cnVlKSkudGltZW91dCh0aGlzLnBhZ2VSZWFkeVRpbWVvdXQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoIShlcnIgaW5zdGFuY2VvZiBCLlRpbWVvdXRFcnJvcikpIHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBQYWdlIHJlYWRpbmVzcyBjaGVjayB0aW1lZCBvdXQgYWZ0ZXIgJHt0aGlzLnBhZ2VSZWFkeVRpbWVvdXR9bXNgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgbG9nLmRlYnVnKGBEb2N1bWVudCByZWFkeVN0YXRlIGlzICcke3JlYWR5U3RhdGV9J2ApO1xuXG4gIHJldHVybiByZWFkeVN0YXRlID09PSAnY29tcGxldGUnO1xufVxuXG5hc3luYyBmdW5jdGlvbiBuYXZUb1VybCAodXJsLCBwYWdlTG9hZFZlcmlmeUhvb2spIHtcbiAgY2hlY2tQYXJhbXMoe2FwcElkS2V5OiB0aGlzLmFwcElkS2V5LCBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5fSk7XG5cbiAgdGhpcy5fbmF2aWdhdGluZ1RvUGFnZSA9IHRydWU7XG5cbiAgdHJ5IHtcbiAgICBsb2cuZGVidWcoYE5hdmlnYXRpbmcgdG8gbmV3IFVSTDogJyR7dXJsfSdgKTtcblxuICAgIC8vIGJlZ2luIGxpc3RlbmluZyBmb3IgZnJhbWUgbmF2aWdhdGlvbiBldmVudCwgd2hpY2ggd2lsbCBiZSB3YWl0ZWQgZm9yIGxhdGVyXG4gICAgY29uc3Qgd2FpdEZvckZyYW1lUHJvbWlzZSA9IHRoaXMud2FpdEZvckZyYW1lTmF2aWdhdGVkKCk7XG5cbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdQYWdlLm5hdmlnYXRlJywge1xuICAgICAgdXJsLFxuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgIH0pO1xuXG4gICAgaWYgKCF0aGlzLnVzZU5ld1NhZmFyaSkge1xuICAgICAgLy8gYSBzbWFsbCBwYXVzZSBmb3IgdGhlIGJyb3dzZXIgdG8gY2F0Y2ggdXBcbiAgICAgIGF3YWl0IEIuZGVsYXkoMTAwMCk7XG4gICAgfVxuXG4gICAgLy8gd2FpdCB1bnRpbCB0aGUgcGFnZSBoYXMgYmVlbiBuYXZpZ2F0ZWRcbiAgICBhd2FpdCB3YWl0Rm9yRnJhbWVQcm9taXNlO1xuXG4gICAgYXdhaXQgdGhpcy53YWl0Rm9yRG9tKG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpLCBwYWdlTG9hZFZlcmlmeUhvb2spO1xuXG4gICAgLy8gZW5hYmxlIGNvbnNvbGUgbG9nZ2luZywgc28gd2UgZ2V0IHRoZSBldmVudHMgKG90aGVyd2lzZSB3ZSBvbmx5XG4gICAgLy8gZ2V0IG5vdGlmaWVkIHdoZW4gbmF2aWdhdGluZyB0byBhIGxvY2FsIHBhZ2VcbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdDb25zb2xlLmVuYWJsZScsIHtcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICB0aGlzLl9uYXZpZ2F0aW5nVG9QYWdlID0gZmFsc2U7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gd2FpdEZvckZyYW1lTmF2aWdhdGVkICgpIHtcbiAgbGV0IG5hdkV2ZW50TGlzdGVuZXI7XG4gIHJldHVybiBhd2FpdCBuZXcgQihhc3luYyAocmVzb2x2ZSkgPT4ge1xuICAgIGxvZy5kZWJ1ZygnV2FpdGluZyBmb3IgZnJhbWUgbmF2aWdhdGVkIG1lc3NhZ2UuLi4nKTtcbiAgICBjb25zdCBzdGFydCA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuXG4gICAgLy8gYWRkIGEgaGFuZGxlciBmb3IgdGhlIGBQYWdlLmZyYW1lTmF2aWdhdGVkYCBtZXNzYWdlXG4gICAgLy8gZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyXG4gICAgbmF2RXZlbnRMaXN0ZW5lciA9IChlcnIsIHZhbHVlKSA9PiB7XG4gICAgICBsb2cuZGVidWcoYEZyYW1lIG5hdmlnYXRlZCBpbiAke3N0YXJ0LmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tcyBmcm9tOiAke3ZhbHVlfWApO1xuICAgICAgaWYgKCF0aGlzLmFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgJiYgIXRoaXMucGFnZUxvYWRpbmcpIHtcbiAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoJ0ZyYW1lIG5hdmlnYXRlZCBidXQgd2Ugd2VyZSB3YXJuZWQgYWJvdXQgaXQsIG5vdCAnICtcbiAgICAgICAgICAgICAgICAgICdjb25zaWRlcmluZyBwYWdlIHN0YXRlIHVubG9hZGVkJyk7XG4gICAgICAgIHRoaXMuYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMubmF2aWdhdGlvbkRlbGF5KSB7XG4gICAgICAgIHRoaXMubmF2aWdhdGlvbkRlbGF5LmNhbmNlbCgpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLnJwY0NsaWVudC5vbmNlKCdQYWdlLmZyYW1lTmF2aWdhdGVkJywgbmF2RXZlbnRMaXN0ZW5lcik7XG5cbiAgICAvLyB0aW1lb3V0LCBpbiBjYXNlIHJlbW90ZSBkZWJ1Z2dlciBkb2Vzbid0IHJlc3BvbmQsXG4gICAgLy8gb3IgdGFrZXMgYSBsb25nIHRpbWVcbiAgICBpZiAoIXRoaXMudXNlTmV3U2FmYXJpIHx8IHRoaXMucGFnZUxvYWRNcyA+PSAwKSB7XG4gICAgICAvLyB1c2UgcGFnZUxvYWRNcywgb3IgYSBzbWFsbCBhbW91bnQgb2YgdGltZVxuICAgICAgY29uc3QgdGltZW91dCA9IHRoaXMudXNlTmV3U2FmYXJpID8gdGhpcy5wYWdlTG9hZE1zIDogNTAwO1xuICAgICAgdGhpcy5uYXZpZ2F0aW9uRGVsYXkgPSB1dGlsLmNhbmNlbGxhYmxlRGVsYXkodGltZW91dCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLm5hdmlnYXRpb25EZWxheTtcbiAgICAgICAgbmF2RXZlbnRMaXN0ZW5lcihudWxsLCBgJHt0aW1lb3V0fW1zIHRpbWVvdXRgKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyBub3RoaW5nIHRvIGRvOiB3ZSBvbmx5IGdldCBoZXJlIGlmIHRoZSByZW1vdGUgZGVidWdnZXJcbiAgICAgICAgLy8gYWxyZWFkeSBub3RpZmllZCBvZiBmcmFtZSBuYXZpZ2F0aW9uLCBhbmQgdGhlIGRlbGF5XG4gICAgICAgIC8vIHdhcyBjYW5jZWxsZWRcbiAgICAgIH1cbiAgICB9XG4gIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgIGlmIChuYXZFdmVudExpc3RlbmVyKSB7XG4gICAgICB0aGlzLnJwY0NsaWVudC5vZmYoJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnLCBuYXZFdmVudExpc3RlbmVyKTtcbiAgICB9XG4gIH0pO1xufVxuXG5cbmV4cG9ydCBkZWZhdWx0IHsgZnJhbWVEZXRhY2hlZCwgcGFnZUxvYWQsIGNhbmNlbFBhZ2VMb2FkLCBwYWdlVW5sb2FkLCB3YWl0Rm9yRG9tLCBjaGVja1BhZ2VJc1JlYWR5LCBuYXZUb1VybCwgd2FpdEZvckZyYW1lTmF2aWdhdGVkIH07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsU0FBU0EsYUFBVCxHQUEwQjtFQUN4QixLQUFLQyxJQUFMLENBQVVDLGVBQUEsQ0FBT0MscUJBQWpCO0FBQ0Q7O0FBRUQsZUFBZUMsUUFBZixDQUF5QkMsa0JBQXpCLEVBQTZDQyxrQkFBa0IsR0FBR0MsZUFBQSxDQUFFQyxJQUFwRSxFQUEwRTtFQUFBOztFQUN4RSxNQUFNQyxTQUFTLEdBQUcsR0FBbEI7O0VBQ0EsSUFBSSxDQUFDRixlQUFBLENBQUVHLFVBQUYsd0JBQWFMLGtCQUFiLHdEQUFhLG9CQUFvQk0sV0FBakMsQ0FBTCxFQUFvRDtJQUNsREMsZUFBQSxDQUFJQyxLQUFKLENBQVcsaURBQVg7O0lBQ0FSLGtCQUFrQixHQUFHLElBQUlTLGVBQUEsQ0FBT0MsS0FBWCxHQUFtQkMsS0FBbkIsRUFBckI7RUFDRDs7RUFFREosZUFBQSxDQUFJQyxLQUFKLENBQVUsc0NBQVY7O0VBQ0EsS0FBS0ksV0FBTCxHQUFtQixJQUFu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