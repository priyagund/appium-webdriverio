"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.WebInspectorDecoder = void 0;

require("source-map-support/register");

var _stream = _interopRequireDefault(require("stream"));

var _support = require("@appium/support");

class WebInspectorDecoder extends _stream.default.Transform {
  constructor(maxLength) {
    super({
      objectMode: true
    });
    this._frameBufferIndex = 0;
    this._frameBuffer = Buffer.allocUnsafeSlow(maxLength);
  }

  _transform(data, encoding, onData) {
    this._decode(data);

    onData();
  }

  _decode(data) {
    if (data.WIRFinalMessageKey) {
      const buffer = data.WIRFinalMessageKey;
      this._frameBufferIndex += this._readBytes(buffer, 0, this._frameBuffer, this._frameBufferIndex, buffer.length);

      const pref = _support.plist.parsePlist(this._frameBuffer.slice(0, this._frameBufferIndex));

      this.push(pref);

      this._resetBuffers();
    } else {
      const buffer = data.WIRPartialMessageKey;
      this._frameBufferIndex += this._readBytes(buffer, 0, this._frameBuffer, this._frameBufferIndex, buffer.length);
    }
  }

  _readBytes(src, srcIndex, target, targetIndex, nBytesToBeRead) {
    let availableBytes = Math.min(nBytesToBeRead, src.length - srcIndex);
    src.copy(target, targetIndex, srcIndex, srcIndex + availableBytes);
    return availableBytes;
  }

  _resetBuffers() {
    this._frameBufferIndex = 0;
  }

}

exports.WebInspectorDecoder = WebInspectorDecoder;
var _default = WebInspectorDecoder;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJXZWJJbnNwZWN0b3JEZWNvZGVyIiwiU3RyZWFtIiwiVHJhbnNmb3JtIiwiY29uc3RydWN0b3IiLCJtYXhMZW5ndGgiLCJvYmplY3RNb2RlIiwiX2ZyYW1lQnVmZmVySW5kZXgiLCJfZnJhbWVCdWZmZXIiLCJCdWZmZXIiLCJhbGxvY1Vuc2FmZVNsb3ciLCJfdHJhbnNmb3JtIiwiZGF0YSIsImVuY29kaW5nIiwib25EYXRhIiwiX2RlY29kZSIsIldJUkZpbmFsTWVzc2FnZUtleSIsImJ1ZmZlciIsIl9yZWFkQnl0ZXMiLCJsZW5ndGgiLCJwcmVmIiwicGxpc3QiLCJwYXJzZVBsaXN0Iiwic2xpY2UiLCJwdXNoIiwiX3Jlc2V0QnVmZmVycyIsIldJUlBhcnRpYWxNZXNzYWdlS2V5Iiwic3JjIiwic3JjSW5kZXgiLCJ0YXJnZXQiLCJ0YXJnZXRJbmRleCIsIm5CeXRlc1RvQmVSZWFkIiwiYXZhaWxhYmxlQnl0ZXMiLCJNYXRoIiwibWluIiwiY29weSJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi93ZWJpbnNwZWN0b3IvdHJhbnNmb3JtZXIvd2ViaW5zcGVjdG9yLWRlY29kZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFN0cmVhbSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHsgcGxpc3QgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuXG5cbmNsYXNzIFdlYkluc3BlY3RvckRlY29kZXIgZXh0ZW5kcyBTdHJlYW0uVHJhbnNmb3JtIHtcbiAgY29uc3RydWN0b3IgKG1heExlbmd0aCkge1xuICAgIHN1cGVyKHsgb2JqZWN0TW9kZTogdHJ1ZSB9KTtcbiAgICB0aGlzLl9mcmFtZUJ1ZmZlckluZGV4ID0gMDtcbiAgICB0aGlzLl9mcmFtZUJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZVNsb3cobWF4TGVuZ3RoKTtcbiAgfVxuXG4gIF90cmFuc2Zvcm0gKGRhdGEsIGVuY29kaW5nLCBvbkRhdGEpIHtcbiAgICB0aGlzLl9kZWNvZGUoZGF0YSk7XG4gICAgb25EYXRhKCk7XG4gIH1cblxuICBfZGVjb2RlIChkYXRhKSB7XG4gICAgaWYgKGRhdGEuV0lSRmluYWxNZXNzYWdlS2V5KSB7XG4gICAgICBjb25zdCBidWZmZXIgPSBkYXRhLldJUkZpbmFsTWVzc2FnZUtleTtcbiAgICAgIHRoaXMuX2ZyYW1lQnVmZmVySW5kZXggKz0gdGhpcy5fcmVhZEJ5dGVzKGJ1ZmZlciwgMCwgdGhpcy5fZnJhbWVCdWZmZXIsIHRoaXMuX2ZyYW1lQnVmZmVySW5kZXgsIGJ1ZmZlci5sZW5ndGgpO1xuICAgICAgY29uc3QgcHJlZiA9IHBsaXN0LnBhcnNlUGxpc3QodGhpcy5fZnJhbWVCdWZmZXIuc2xpY2UoMCwgdGhpcy5fZnJhbWVCdWZmZXJJbmRleCkpO1xuICAgICAgdGhpcy5wdXNoKHByZWYpO1xuICAgICAgdGhpcy5fcmVzZXRCdWZmZXJzKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGJ1ZmZlciA9IGRhdGEuV0lSUGFydGlhbE1lc3NhZ2VLZXk7XG4gICAgICB0aGlzLl9mcmFtZUJ1ZmZlckluZGV4ICs9IHRoaXMuX3JlYWRCeXRlcyhidWZmZXIsIDAsIHRoaXMuX2ZyYW1lQnVmZmVyLCB0aGlzLl9mcmFtZUJ1ZmZlckluZGV4LCBidWZmZXIubGVuZ3RoKTtcbiAgICB9XG4gIH1cblxuICBfcmVhZEJ5dGVzIChzcmMsIHNyY0luZGV4LCB0YXJnZXQsIHRhcmdldEluZGV4LCBuQnl0ZXNUb0JlUmVhZCkge1xuICAgIGxldCBhdmFpbGFibGVCeXRlcyA9IE1hdGgubWluKG5CeXRlc1RvQmVSZWFkLCBzcmMubGVuZ3RoIC0gc3JjSW5kZXgpO1xuICAgIHNyYy5jb3B5KHRhcmdldCwgdGFyZ2V0SW5kZXgsIHNyY0luZGV4LCBzcmNJbmRleCArIGF2YWlsYWJsZUJ5dGVzKTtcbiAgICByZXR1cm4gYXZhaWxhYmxlQnl0ZXM7XG4gIH1cblxuICBfcmVzZXRCdWZmZXJzICgpIHtcbiAgICB0aGlzLl9mcmFtZUJ1ZmZlckluZGV4ID0gMDtcbiAgfVxufVxuXG5leHBvcnQgeyBXZWJJbnNwZWN0b3JEZWNvZGVyIH07XG5leHBvcnQgZGVmYXVsdCBXZWJJbnNwZWN0b3JEZWNvZGVyO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUdBLE1BQU1BLG1CQUFOLFNBQWtDQyxlQUFBLENBQU9DLFNBQXpDLENBQW1EO0VBQ2pEQyxXQUFXLENBQUVDLFNBQUYsRUFBYTtJQUN0QixNQUFNO01BQUVDLFVBQVUsRUFBRTtJQUFkLENBQU47SUFDQSxLQUFLQyxpQkFBTCxHQUF5QixDQUF6QjtJQUNBLEtBQUtDLFlBQUwsR0FBb0JDLE1BQU0sQ0FBQ0MsZUFBUCxDQUF1QkwsU0FBdkIsQ0FBcEI7RUFDRDs7RUFFRE0sVUFBVSxDQUFFQyxJQUFGLEVBQVFDLFFBQVIsRUFBa0JDLE1BQWxCLEVBQTBCO0lBQ2xDLEtBQUtDLE9BQUwsQ0FBYUgsSUFBYjs7SUFDQUUsTUFBTTtFQUNQOztFQUVEQyxPQUFPLENBQUVILElBQUYsRUFBUTtJQUNiLElBQUlBLElBQUksQ0FBQ0ksa0JBQVQsRUFBNkI7TUFDM0IsTUFBTUMsTUFBTSxHQUFHTCxJQUFJLENBQUNJLGtCQUFwQjtNQUNBLEtBQUtULGlCQUFMLElBQTBCLEtBQUtXLFVBQUwsQ0FBZ0JELE1BQWhCLEVBQXdCLENBQXhCLEVBQTJCLEtBQUtULFlBQWhDLEVBQThDLEtBQUtELGlCQUFuRCxFQUFzRVUsTUFBTSxDQUFDRSxNQUE3RSxDQUExQjs7TUFDQSxNQUFNQyxJQUFJLEdBQUdDLGNBQUEsQ0FBTUMsVUFBTixDQUFpQixLQUFLZCxZQUFMLENBQWtCZSxLQUFsQixDQUF3QixDQUF4QixFQUEyQixLQUFLaEIsaUJBQWhDLENBQWpCLENBQWI7O01BQ0EsS0FBS2lCLElBQUwsQ0FBVUosSUFBVjs7TUFDQSxLQUFLSyxhQUFMO0lBQ0QsQ0FORCxNQU1PO01BQ0wsTUFBTVIsTUFBTSxHQUFHTCxJQUFJLENBQUNjLG9CQUFwQjtNQUNBLEtBQUtuQixpQkFBTCxJQUEwQixLQUFLVyxVQUFMLENBQWdCRCxNQUFoQixFQUF3QixDQUF4QixFQUEyQixLQUFLVCxZQUFoQyxFQUE4QyxLQUFLRCxpQkFBbkQsRUFBc0VVLE1BQU0sQ0FBQ0UsTUFBN0UsQ0FBMUI7SUFDRDtFQUNGOztFQUVERCxVQUFVLENBQUVTLEdBQUYsRUFBT0MsUUFBUCxFQUFpQkMsTUFBakIsRUFBeUJDLFdBQXpCLEVBQXNDQyxjQUF0QyxFQUFzRDtJQUM5RCxJQUFJQyxjQUFjLEdBQUdDLElBQUksQ0FBQ0MsR0FBTCxDQUFTSCxjQUFULEVBQXlCSixHQUFHLENBQUNSLE1BQUosR0FBYVMsUUFBdEMsQ0FBckI7SUFDQUQsR0FBRyxDQUFDUSxJQUFKLENBQVNOLE1BQVQsRUFBaUJDLFdBQWpCLEVBQThCRixRQUE5QixFQUF3Q0EsUUFBUSxHQUFHSSxjQUFuRDtJQUNBLE9BQU9BLGNBQVA7RUFDRDs7RUFFRFAsYUFBYSxHQUFJO0lBQ2YsS0FBS2xCLGlCQUFMLEdBQXlCLENBQXpCO0VBQ0Q7O0FBakNnRDs7O2VBcUNwQ04sbUIifQ==