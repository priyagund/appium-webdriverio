"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SyslogDecoder = void 0;
exports.unescape = unescape;

require("source-map-support/register");

var _stream = _interopRequireDefault(require("stream"));

const NEW_LINE_CODE = 0x0A;
const NULL_DELIMETER_CODE = 0x00;
const BACKSLASH_CODE = '\\'.codePointAt(0);
const SHIFTS_MAPPING = {
  '-': 0x80,
  '^': 0x40
};
const ESCAPE_TOKEN_LEN = 4;
const ESCAPE_TOKEN_PATTERN = /\\M(-|\^)(.)/;

function toUtf8Byte(escapedChar, modifier) {
  const shift = SHIFTS_MAPPING[modifier];
  return isNaN(shift) ? null : escapedChar.codePointAt(0) + shift;
}

function unescape(logBuffer) {
  const parseUtf8Chars = start => {
    let cursor = start;
    const token = new Uint8Array(ESCAPE_TOKEN_LEN);
    const utf8CharsAsBytes = [];

    while (cursor <= logBuffer.length - ESCAPE_TOKEN_LEN) {
      logBuffer.copy(token, 0, cursor, cursor + ESCAPE_TOKEN_LEN);
      const tokenStr = Buffer.from(token).toString('latin1');
      const tokenMatch = ESCAPE_TOKEN_PATTERN.exec(tokenStr);

      if (!tokenMatch) {
        break;
      }

      const byte = toUtf8Byte(tokenMatch[2], tokenMatch[1]);

      if (byte === null) {
        break;
      }

      utf8CharsAsBytes.push(byte);
      cursor += ESCAPE_TOKEN_LEN;
    }

    return utf8CharsAsBytes.length ? [cursor, Buffer.from(utf8CharsAsBytes).toString('utf8')] : [start, null];
  };

  let index = 0;
  let result = '';
  const bytesView = new Uint8Array(logBuffer);

  while (index < bytesView.length) {
    if (bytesView[index] === BACKSLASH_CODE) {
      const [newIndex, chars] = parseUtf8Chars(index);

      if (newIndex > index) {
        result += chars;
        index = newIndex;
        continue;
      }
    }

    result += String.fromCharCode(bytesView[index++]);
  }

  return result;
}

class SyslogDecoder extends _stream.default.Transform {
  constructor(bufferLength) {
    super({
      objectMode: true
    });
    this.bufferIndex = 0;
    this.buffer = Buffer.allocUnsafe(bufferLength);
  }

  _transform(data, encoding, onData) {
    this._decode(data);

    onData();
  }

  _decode(data) {
    for (let i = 0; i < data.length; i++) {
      if (data[i] === NULL_DELIMETER_CODE) {
        continue;
      }

      if (data[i] === NEW_LINE_CODE) {
        if (this.bufferIndex > 0) {
          const stringBuffer = Buffer.allocUnsafe(this.bufferIndex);
          this.buffer.copy(stringBuffer, 0, 0, this.bufferIndex);
          this.push(unescape(stringBuffer), 'utf8');
          this.bufferIndex = 0;
        }

        continue;
      }

      this.buffer[this.bufferIndex] = data[i];
      this.bufferIndex++;
    }
  }

}

exports.SyslogDecoder = SyslogDecoder;
var _default = SyslogDecoder;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJORVdfTElORV9DT0RFIiwiTlVMTF9ERUxJTUVURVJfQ09ERSIsIkJBQ0tTTEFTSF9DT0RFIiwiY29kZVBvaW50QXQiLCJTSElGVFNfTUFQUElORyIsIkVTQ0FQRV9UT0tFTl9MRU4iLCJFU0NBUEVfVE9LRU5fUEFUVEVSTiIsInRvVXRmOEJ5dGUiLCJlc2NhcGVkQ2hhciIsIm1vZGlmaWVyIiwic2hpZnQiLCJpc05hTiIsInVuZXNjYXBlIiwibG9nQnVmZmVyIiwicGFyc2VVdGY4Q2hhcnMiLCJzdGFydCIsImN1cnNvciIsInRva2VuIiwiVWludDhBcnJheSIsInV0ZjhDaGFyc0FzQnl0ZXMiLCJsZW5ndGgiLCJjb3B5IiwidG9rZW5TdHIiLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJ0b2tlbk1hdGNoIiwiZXhlYyIsImJ5dGUiLCJwdXNoIiwiaW5kZXgiLCJyZXN1bHQiLCJieXRlc1ZpZXciLCJuZXdJbmRleCIsImNoYXJzIiwiU3RyaW5nIiwiZnJvbUNoYXJDb2RlIiwiU3lzbG9nRGVjb2RlciIsIlN0cmVhbSIsIlRyYW5zZm9ybSIsImNvbnN0cnVjdG9yIiwiYnVmZmVyTGVuZ3RoIiwib2JqZWN0TW9kZSIsImJ1ZmZlckluZGV4IiwiYnVmZmVyIiwiYWxsb2NVbnNhZmUiLCJfdHJhbnNmb3JtIiwiZGF0YSIsImVuY29kaW5nIiwib25EYXRhIiwiX2RlY29kZSIsImkiLCJzdHJpbmdCdWZmZXIiXSwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9saWIvc3lzbG9nL3RyYW5zZm9ybWVyL3N5c2xvZy1kZWNvZGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBTdHJlYW0gZnJvbSAnc3RyZWFtJztcblxuY29uc3QgTkVXX0xJTkVfQ09ERSA9IDB4MEE7XG5jb25zdCBOVUxMX0RFTElNRVRFUl9DT0RFID0gMHgwMDtcbmNvbnN0IEJBQ0tTTEFTSF9DT0RFID0gJ1xcXFwnLmNvZGVQb2ludEF0KDApO1xuY29uc3QgU0hJRlRTX01BUFBJTkcgPSB7XG4gICctJzogMHg4MCxcbiAgJ14nOiAweDQwLFxufTtcbmNvbnN0IEVTQ0FQRV9UT0tFTl9MRU4gPSA0O1xuY29uc3QgRVNDQVBFX1RPS0VOX1BBVFRFUk4gPSAvXFxcXE0oLXxcXF4pKC4pLztcblxuXG5mdW5jdGlvbiB0b1V0ZjhCeXRlIChlc2NhcGVkQ2hhciwgbW9kaWZpZXIpIHtcbiAgY29uc3Qgc2hpZnQgPSBTSElGVFNfTUFQUElOR1ttb2RpZmllcl07XG4gIHJldHVybiBpc05hTihzaGlmdCkgPyBudWxsIDogZXNjYXBlZENoYXIuY29kZVBvaW50QXQoMCkgKyBzaGlmdDtcbn1cblxuLyoqXG4gKiBVbmVzY2FwZXMgdXRmOC1lbmNvZGVkIGNoYXJhY3RlcnMsIHNvIHRoZSBvdXRwdXQgbG9va3NcbiAqIGxpa2UgYSB2YWxpZCBzdHJpbmcuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvMTQ0NzZcbiAqIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogQHBhcmFtIHtCdWZmZXJ9IGxvZ0J1ZmZlciBBIHNpbmdsZSBlc2NhcGVkIGxvZyBsaW5lXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgdW5lc2NhcGVkIHN0cmluZyBvciB0aGUgc2FtZSBzdHJpbmcgaWYgbm8gdW5lc2NhcGluZ1xuICogaXMgbmVjZXNzYXJ5LlxuICovXG5mdW5jdGlvbiB1bmVzY2FwZSAobG9nQnVmZmVyKSB7XG4gIGNvbnN0IHBhcnNlVXRmOENoYXJzID0gKHN0YXJ0KSA9PiB7XG4gICAgbGV0IGN1cnNvciA9IHN0YXJ0O1xuICAgIGNvbnN0IHRva2VuID0gbmV3IFVpbnQ4QXJyYXkoRVNDQVBFX1RPS0VOX0xFTik7XG4gICAgY29uc3QgdXRmOENoYXJzQXNCeXRlcyA9IFtdO1xuICAgIHdoaWxlIChjdXJzb3IgPD0gbG9nQnVmZmVyLmxlbmd0aCAtIEVTQ0FQRV9UT0tFTl9MRU4pIHtcbiAgICAgIGxvZ0J1ZmZlci5jb3B5KHRva2VuLCAwLCBjdXJzb3IsIGN1cnNvciArIEVTQ0FQRV9UT0tFTl9MRU4pO1xuICAgICAgY29uc3QgdG9rZW5TdHIgPSBCdWZmZXIuZnJvbSh0b2tlbikudG9TdHJpbmcoJ2xhdGluMScpO1xuICAgICAgY29uc3QgdG9rZW5NYXRjaCA9IEVTQ0FQRV9UT0tFTl9QQVRURVJOLmV4ZWModG9rZW5TdHIpO1xuICAgICAgaWYgKCF0b2tlbk1hdGNoKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY29uc3QgYnl0ZSA9IHRvVXRmOEJ5dGUodG9rZW5NYXRjaFsyXSwgdG9rZW5NYXRjaFsxXSk7XG4gICAgICBpZiAoYnl0ZSA9PT0gbnVsbCkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIHV0ZjhDaGFyc0FzQnl0ZXMucHVzaChieXRlKTtcbiAgICAgIGN1cnNvciArPSBFU0NBUEVfVE9LRU5fTEVOO1xuICAgIH1cbiAgICByZXR1cm4gdXRmOENoYXJzQXNCeXRlcy5sZW5ndGhcbiAgICAgID8gW2N1cnNvciwgQnVmZmVyLmZyb20odXRmOENoYXJzQXNCeXRlcykudG9TdHJpbmcoJ3V0ZjgnKV1cbiAgICAgIDogW3N0YXJ0LCBudWxsXTtcbiAgfTtcblxuICBsZXQgaW5kZXggPSAwO1xuICBsZXQgcmVzdWx0ID0gJyc7XG4gIGNvbnN0IGJ5dGVzVmlldyA9IG5ldyBVaW50OEFycmF5KGxvZ0J1ZmZlcik7XG4gIHdoaWxlIChpbmRleCA8IGJ5dGVzVmlldy5sZW5ndGgpIHtcbiAgICBpZiAoYnl0ZXNWaWV3W2luZGV4XSA9PT0gQkFDS1NMQVNIX0NPREUpIHtcbiAgICAgIGNvbnN0IFtuZXdJbmRleCwgY2hhcnNdID0gcGFyc2VVdGY4Q2hhcnMoaW5kZXgpO1xuICAgICAgaWYgKG5ld0luZGV4ID4gaW5kZXgpIHtcbiAgICAgICAgcmVzdWx0ICs9IGNoYXJzO1xuICAgICAgICBpbmRleCA9IG5ld0luZGV4O1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmVzdWx0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnl0ZXNWaWV3W2luZGV4KytdKTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cblxuY2xhc3MgU3lzbG9nRGVjb2RlciBleHRlbmRzIFN0cmVhbS5UcmFuc2Zvcm0ge1xuXG4gIGNvbnN0cnVjdG9yIChidWZmZXJMZW5ndGgpIHtcbiAgICBzdXBlcih7IG9iamVjdE1vZGU6IHRydWUgfSk7XG4gICAgdGhpcy5idWZmZXJJbmRleCA9IDA7XG4gICAgdGhpcy5idWZmZXIgPSBCdWZmZXIuYWxsb2NVbnNhZmUoYnVmZmVyTGVuZ3RoKTtcbiAgfVxuXG4gIF90cmFuc2Zvcm0gKGRhdGEsIGVuY29kaW5nLCBvbkRhdGEpIHtcbiAgICB0aGlzLl9kZWNvZGUoZGF0YSk7XG4gICAgb25EYXRhKCk7XG4gIH1cblxuICBfZGVjb2RlIChkYXRhKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICAvLyBEb24ndCBzdG9yZSB0aGUgbnVsbCBkZWxpbWV0ZXIgbWVzc2FnZXNcbiAgICAgIGlmIChkYXRhW2ldID09PSBOVUxMX0RFTElNRVRFUl9DT0RFKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgLy8gUHVzaCB0aGUgZGF0YSB3aGVuIG5ldyBsaW5lIGlzIHNlbnRcbiAgICAgIGlmIChkYXRhW2ldID09PSBORVdfTElORV9DT0RFKSB7XG4gICAgICAgIGlmICh0aGlzLmJ1ZmZlckluZGV4ID4gMCkge1xuICAgICAgICAgIGNvbnN0IHN0cmluZ0J1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSh0aGlzLmJ1ZmZlckluZGV4KTtcbiAgICAgICAgICB0aGlzLmJ1ZmZlci5jb3B5KHN0cmluZ0J1ZmZlciwgMCwgMCwgdGhpcy5idWZmZXJJbmRleCk7XG4gICAgICAgICAgdGhpcy5wdXNoKHVuZXNjYXBlKHN0cmluZ0J1ZmZlciksICd1dGY4Jyk7XG4gICAgICAgICAgdGhpcy5idWZmZXJJbmRleCA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICB0aGlzLmJ1ZmZlclt0aGlzLmJ1ZmZlckluZGV4XSA9IGRhdGFbaV07XG4gICAgICB0aGlzLmJ1ZmZlckluZGV4Kys7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IFN5c2xvZ0RlY29kZXIsIHVuZXNjYXBlIH07XG5leHBvcnQgZGVmYXVsdCBTeXNsb2dEZWNvZGVyO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQTs7QUFFQSxNQUFNQSxhQUFhLEdBQUcsSUFBdEI7QUFDQSxNQUFNQyxtQkFBbUIsR0FBRyxJQUE1QjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxLQUFLQyxXQUFMLENBQWlCLENBQWpCLENBQXZCO0FBQ0EsTUFBTUMsY0FBYyxHQUFHO0VBQ3JCLEtBQUssSUFEZ0I7RUFFckIsS0FBSztBQUZnQixDQUF2QjtBQUlBLE1BQU1DLGdCQUFnQixHQUFHLENBQXpCO0FBQ0EsTUFBTUMsb0JBQW9CLEdBQUcsY0FBN0I7O0FBR0EsU0FBU0MsVUFBVCxDQUFxQkMsV0FBckIsRUFBa0NDLFFBQWxDLEVBQTRDO0VBQzFDLE1BQU1DLEtBQUssR0FBR04sY0FBYyxDQUFDSyxRQUFELENBQTVCO0VBQ0EsT0FBT0UsS0FBSyxDQUFDRCxLQUFELENBQUwsR0FBZSxJQUFmLEdBQXNCRixXQUFXLENBQUNMLFdBQVosQ0FBd0IsQ0FBeEIsSUFBNkJPLEtBQTFEO0FBQ0Q7O0FBV0QsU0FBU0UsUUFBVCxDQUFtQkMsU0FBbkIsRUFBOEI7RUFDNUIsTUFBTUMsY0FBYyxHQUFJQyxLQUFELElBQVc7SUFDaEMsSUFBSUMsTUFBTSxHQUFHRCxLQUFiO0lBQ0EsTUFBTUUsS0FBSyxHQUFHLElBQUlDLFVBQUosQ0FBZWIsZ0JBQWYsQ0FBZDtJQUNBLE1BQU1jLGdCQUFnQixHQUFHLEVBQXpCOztJQUNBLE9BQU9ILE1BQU0sSUFBSUgsU0FBUyxDQUFDTyxNQUFWLEdBQW1CZixnQkFBcEMsRUFBc0Q7TUFDcERRLFNBQVMsQ0FBQ1EsSUFBVixDQUFlSixLQUFmLEVBQXNC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