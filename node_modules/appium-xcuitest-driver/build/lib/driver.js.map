{"version":3,"file":"driver.js","names":["SHUTDOWN_OTHER_FEAT_NAME","CUSTOMIZE_RESULT_BUNDPE_PATH","SUPPORTED_EXTENSIONS","IPA_EXT","APP_EXT","MAX_ARCHIVE_SCAN_DEPTH","defaultServerCaps","webStorageEnabled","locationContextEnabled","browserName","platform","javascriptEnabled","databaseEnabled","takesScreenshot","networkConnectionEnabled","WDA_SIM_STARTUP_RETRIES","WDA_REAL_DEV_STARTUP_RETRIES","WDA_REAL_DEV_TUTORIAL_URL","WDA_STARTUP_RETRY_INTERVAL","DEFAULT_SETTINGS","nativeWebTap","nativeWebTapStrict","useJSONSource","shouldUseCompactResponses","elementResponseAttributes","mjpegServerScreenshotQuality","mjpegServerFramerate","screenshotQuality","mjpegScalingFactor","reduceMotion","SHARED_RESOURCES_GUARD","AsyncLock","WEB_ELEMENTS_CACHE_SIZE","NO_PROXY_NATIVE_LIST","NO_PROXY_WEB_LIST","concat","MEMOIZED_FUNCTIONS","XCUITestDriver","BaseDriver","constructor","opts","shouldValidateCaps","desiredCapConstraints","locatorStrategies","webLocatorStrategies","resetIos","settings","DeviceSettings","onSettingsUpdate","bind","logs","fn","_","memoize","key","value","proxyCommand","wda","device","jwpProxyActive","proxyReqRes","jwpProxyAvoid","safari","cachedWdaStatus","curWebFrames","_currentUrl","curContext","xcodeVersion","contexts","implicitWaitMs","asynclibWaitMs","pageLoadMs","landscapeWebCoordsOffset","remote","_conditionInducerService","webElementsCache","LRU","max","driverData","getStatus","driverInfo","getDriverInfo","status","build","version","mergeCliArgsToOpts","didMerge","Object","entries","cliArgs","has","log","info","createSession","args","lifecycleData","sessionId","caps","validateDesiredCaps","start","assign","udid","updateSettings","wdaSettings","mjpegScreenshotUrl","mjpegStream","mjpeg","MJpegStream","e","error","JSON","stringify","deleteSession","getDefaultUrl","isRealDevice","wdaLocalPort","address","includes","port","noReset","fullReset","printUser","iosSdkVersion","realDevice","determineDevice","simulatorDevicesSetPath","devicesSetPath","platformVersion","getPlatformVersion","normalizedVersion","normalizePlatformVersion","util","compareVersions","Error","isEmpty","webDriverAgentUrl","getAndCheckXcodeVersion","logEvent","toLower","app","undefined","processArguments","bundleId","SAFARI_BUNDLE_ID","safariInitialUrl","configureApp","checkAppPresent","extractBundleId","runReset","WebDriverAgent","retrieveDerivedDataPath","catch","debug","memoizedLogInfo","startLogCapture","skipLogCapture","result","isLogCaptureStarted","isSimulator","shutdownOtherSimulators","ensureFeatureEnabled","isSafari","safariGlobalPreferences","updateSafariGlobalSettings","localConfig","setLocaleAndPreferences","sim","shutdownSimulator","customSSLCert","doesSupportKeychainApi","certHead","truncate","length","hasCertificateLegacy","installCertificateLegacy","startSim","installCertificate","launchWithIDB","idb","IDB","connect","message","Pyidevice","installProfile","payload","installAUT","isAppInstalled","errorAndThrow","permissions","permissionsMapping","toPairs","parse","setPermissions","warn","calendarAccessAuthorized","enableCalendarAccess","disableCalendarAccess","startWda","setReduceMotion","setInitialOrientation","orientation","autoWebview","activateRecentWebview","isNil","getCurrentUrl","setUrl","setCurrentUrl","getUrl","hasValue","cleanupObsoleteProcesses","usePortForwarding","isLocalHost","wdaBaseUrl","DEVICE_CONNECTIONS_FACTORY","requestConnection","url","devicePort","wdaRemotePort","synchronizationKey","name","useXctestrunFile","isSourceFresh","derivedDataPath","path","normalize","isBusy","bootstrapPath","acquire","useNewWDA","quitAndUninstall","setupCaching","msg","resultBundlePath","startupRetries","wdaStartupRetries","startupRetryInterval","wdaStartupRetryInterval","retryCount","retryInterval","retries","major","retry","launch","err","errorMsg","originalStacktrace","startWdaSession","stack","clearSystemFiles","markSystemFilesForCleanup","fullyStarted","runRealDeviceReset","runSimulatorReset","removeAllSessionWebSocketHandlers","server","recorder","compact","_recentScreenRecorder","_audioRecorder","_trafficCapture","interrupt","cleanup","_perfRecorders","B","all","map","x","stop","mobileDisableConditionInducer","stopRemote","resetOnSessionStartOnly","enforceSimulatorShutdown","createSim","delete","shouldResetLocationServivce","resetLocationService","mobileResetLocationService","ignore","syslog","stopCapture","jwproxy","quit","releaseConnection","executeCommand","cmd","receiveAsyncResponse","appIsPackageOrBundle","test","helpers","onPostProcess","onPostConfigureApp","supportedExtensions","unzipApp","appPath","depth","rootDir","matchedPaths","findApps","basename","pluralize","matchedPath","fullPath","join","isAppBundle","supportedPlatforms","fetchSupportedAppPlatforms","some","p","isolateAppBundle","endsWith","fs","stat","isFile","rimraf","cachedAppInfo","isUrl","isPlainObject","hash","packageHash","exists","glob","cwd","strict","nosort","integrity","folder","deviceName","translateDeviceName","setupVersionCaps","getAndCheckIosSdkVersion","toLowerCase","detectUdid","getExistingSim","devicePlatform","devices","getConnectedDevices","getSimulator","ign","getRealDeviceObj","enforceFreshSimulatorCreation","runOpts","scaleFactor","connectHardwareKeyboard","pasteboardAutomaticSync","simulatorPasteboardAutomaticSync","isHeadless","tracePointer","simulatorTracePointer","devicePreferences","SimulatorWindowCenter","isInteger","simulatorStartupTimeout","startupTimeout","isString","toUpperCase","SimulatorWindowOrientation","SimulatorWindowRotationAngle","run","platformName","isTvOS","PLATFORM_NAME_TVOS","PLATFORM_NAME_IOS","launchApp","APP_LAUNCH_TIMEOUT","simctl","checkStatus","response","currentApp","bundleID","parseInt","isArray","env","language","push","locale","shouldTerminateApp","forceAppLaunch","wdaCaps","autoLaunch","arguments","environment","eventloopIdleDelaySec","wdaEventloopIdleDelay","shouldWaitForQuiescence","waitForQuiescence","shouldUseTestManagerForVisibilityDetection","simpleIsVisibleCheck","maxTypingFrequency","shouldUseSingletonTestManager","waitForIdleTimeout","elementResponseFields","disableAutomaticScreenshots","useNativeCachingStrategy","forceSimulatorSoftwareKeyboardPresence","autoAcceptAlerts","defaultAlertAction","autoDismissAlerts","capabilities","firstMatch","alwaysMatch","proxyActive","getProxyAvoidList","isWebview","canProxy","isWebContext","validateLocatorStrategy","strategy","coerceVersion","verifyProcessArgument","keychainPath","keychainPassword","commandTimeouts","normalizeCommandTimeouts","protocol","host","perms","additionalWebviewBundleIds","parseCapsArray","verifyApplicationPlatform","installToRealDevice","timeout","appPushTimeout","appInstallStrategy","installToSimulator","newSimulator","otherApps","installOtherApps","iosInstallPause","pause","delay","appsList","appPaths","otherApp","isEnabled","isBoolean","curOrientation","_getCommandTimeout","cmdName","DEFAULT_TIMEOUT_KEY","getSession","driverSession","shouldGetDeviceCaps","includeDeviceCapsToSessionInfo","deviceCaps","statusBarSize","scale","getScreenInfo","pixelRatio","statBarHeight","height","viewportRect","getViewportRect","reset","cloneDeep","shutdownHandler","resetOnUnexpectedShutdown","prototype","commands"],"sources":["../../lib/driver.js"],"sourcesContent":["import { BaseDriver, DeviceSettings } from 'appium/driver';\nimport { util, mjpeg, fs } from 'appium/support';\nimport _ from 'lodash';\nimport url from 'url';\nimport { WebDriverAgent } from 'appium-webdriveragent';\nimport LRU from 'lru-cache';\nimport {\n  createSim, getExistingSim, runSimulatorReset, installToSimulator,\n  shutdownOtherSimulators, shutdownSimulator, setLocaleAndPreferences\n} from './simulator-management';\nimport { getSimulator } from 'appium-ios-simulator';\nimport {\n  doesSupportKeychainApi, installCertificate, installCertificateLegacy,\n  hasCertificateLegacy,\n} from './cert-utils';\nimport { retryInterval, retry } from 'asyncbox';\nimport {\n  verifyApplicationPlatform, extractBundleId, SAFARI_BUNDLE_ID,\n  fetchSupportedAppPlatforms, APP_EXT, IPA_EXT,\n  isAppBundle, findApps, isolateAppBundle,\n} from './app-utils';\nimport {\n  desiredCapConstraints, PLATFORM_NAME_IOS, PLATFORM_NAME_TVOS\n} from './desired-caps';\nimport commands from './commands/index';\nimport {\n  detectUdid, getAndCheckXcodeVersion, getAndCheckIosSdkVersion,\n  checkAppPresent, getDriverInfo,\n  clearSystemFiles, translateDeviceName, normalizeCommandTimeouts,\n  DEFAULT_TIMEOUT_KEY, markSystemFilesForCleanup,\n  printUser, removeAllSessionWebSocketHandlers,\n  normalizePlatformVersion, isLocalHost\n} from './utils';\nimport {\n  getConnectedDevices, runRealDeviceReset, installToRealDevice,\n  getRealDeviceObj\n} from './real-device-management';\nimport B from 'bluebird';\nimport AsyncLock from 'async-lock';\nimport path from 'path';\nimport IDB from 'appium-idb';\nimport DEVICE_CONNECTIONS_FACTORY from './device-connections-factory';\nimport Pyidevice from './py-ios-device-client';\n\n\nconst SHUTDOWN_OTHER_FEAT_NAME = 'shutdown_other_sims';\nconst CUSTOMIZE_RESULT_BUNDPE_PATH = 'customize_result_bundle_path';\n\nconst SUPPORTED_EXTENSIONS = [IPA_EXT, APP_EXT];\nconst MAX_ARCHIVE_SCAN_DEPTH = 1;\nconst defaultServerCaps = {\n  webStorageEnabled: false,\n  locationContextEnabled: false,\n  browserName: '',\n  platform: 'MAC',\n  javascriptEnabled: true,\n  databaseEnabled: false,\n  takesScreenshot: true,\n  networkConnectionEnabled: false,\n};\nconst WDA_SIM_STARTUP_RETRIES = 2;\nconst WDA_REAL_DEV_STARTUP_RETRIES = 1;\nconst WDA_REAL_DEV_TUTORIAL_URL = 'https://github.com/appium/appium-xcuitest-driver/blob/master/docs/real-device-config.md';\nconst WDA_STARTUP_RETRY_INTERVAL = 10000;\nconst DEFAULT_SETTINGS = {\n  nativeWebTap: false,\n  nativeWebTapStrict: false,\n  useJSONSource: false,\n  shouldUseCompactResponses: true,\n  elementResponseAttributes: 'type,label',\n  // Read https://github.com/appium/WebDriverAgent/blob/master/WebDriverAgentLib/Utilities/FBConfiguration.m for following settings' values\n  mjpegServerScreenshotQuality: 25,\n  mjpegServerFramerate: 10,\n  screenshotQuality: 1,\n  mjpegScalingFactor: 100,\n  // set `reduceMotion` to `null` so that it will be verified but still set either true/false\n  reduceMotion: null,\n};\n// This lock assures, that each driver session does not\n// affect shared resources of the other parallel sessions\nconst SHARED_RESOURCES_GUARD = new AsyncLock();\nconst WEB_ELEMENTS_CACHE_SIZE = 500;\n\n/* eslint-disable no-useless-escape */\nconst NO_PROXY_NATIVE_LIST = [\n  ['DELETE', /window/],\n  ['GET', /^\\/session\\/[^\\/]+$/],\n  ['GET', /alert_text/],\n  ['GET', /alert\\/[^\\/]+/],\n  ['GET', /appium/],\n  ['GET', /attribute/],\n  ['GET', /context/],\n  ['GET', /location/],\n  ['GET', /log/],\n  ['GET', /screenshot/],\n  ['GET', /size/],\n  ['GET', /source/],\n  ['GET', /timeouts$/],\n  ['GET', /url/],\n  ['GET', /window/],\n  ['POST', /accept_alert/],\n  ['POST', /actions$/],\n  ['POST', /alert_text/],\n  ['POST', /alert\\/[^\\/]+/],\n  ['POST', /appium/],\n  ['POST', /appium\\/device\\/is_locked/],\n  ['POST', /appium\\/device\\/lock/],\n  ['POST', /appium\\/device\\/unlock/],\n  ['POST', /back/],\n  ['POST', /clear/],\n  ['POST', /context/],\n  ['POST', /dismiss_alert/],\n  ['POST', /element\\/active/], // MJSONWP get active element should proxy\n  ['POST', /element$/],\n  ['POST', /elements$/],\n  ['POST', /execute/],\n  ['POST', /keys/],\n  ['POST', /log/],\n  ['POST', /moveto/],\n  ['POST', /receive_async_response/], // always, in case context switches while waiting\n  ['POST', /session\\/[^\\/]+\\/location/], // geo location, but not element location\n  ['POST', /shake/],\n  ['POST', /timeouts/],\n  ['POST', /touch/],\n  ['POST', /url/],\n  ['POST', /value/],\n  ['POST', /window/],\n  ['DELETE', /cookie/],\n  ['GET', /cookie/],\n  ['POST', /cookie/],\n];\nconst NO_PROXY_WEB_LIST = [\n  ['GET', /attribute/],\n  ['GET', /element/],\n  ['GET', /text/],\n  ['GET', /title/],\n  ['POST', /clear/],\n  ['POST', /click/],\n  ['POST', /element/],\n  ['POST', /forward/],\n  ['POST', /frame/],\n  ['POST', /keys/],\n  ['POST', /refresh/],\n].concat(NO_PROXY_NATIVE_LIST);\n/* eslint-enable no-useless-escape */\n\nconst MEMOIZED_FUNCTIONS = [\n  'getStatusBarHeight',\n  'getDevicePixelRatio',\n  'getScreenInfo',\n];\n\n\nclass XCUITestDriver extends BaseDriver {\n  constructor (opts = {}, shouldValidateCaps = true) {\n    super(opts, shouldValidateCaps);\n\n    this.desiredCapConstraints = desiredCapConstraints;\n\n    this.locatorStrategies = [\n      'xpath',\n      'id',\n      'name',\n      'class name',\n      '-ios predicate string',\n      '-ios class chain',\n      'accessibility id',\n      'css selector',\n    ];\n    this.webLocatorStrategies = [\n      'link text',\n      'css selector',\n      'tag name',\n      'link text',\n      'partial link text',\n    ];\n    this.resetIos();\n    this.settings = new DeviceSettings(DEFAULT_SETTINGS, this.onSettingsUpdate.bind(this));\n    this.logs = {};\n\n    // memoize functions here, so that they are done on a per-instance basis\n    for (const fn of MEMOIZED_FUNCTIONS) {\n      this[fn] = _.memoize(this[fn]);\n    }\n  }\n\n  async onSettingsUpdate (key, value) {\n    if (key !== 'nativeWebTap' && key !== 'nativeWebTapStrict') {\n      return await this.proxyCommand('/appium/settings', 'POST', {\n        settings: {[key]: value}\n      });\n    }\n    this.opts[key] = !!value;\n  }\n\n  resetIos () {\n    this.opts = this.opts || {};\n    this.wda = null;\n    this.opts.device = null;\n    this.jwpProxyActive = false;\n    this.proxyReqRes = null;\n    this.jwpProxyAvoid = [];\n    this.safari = false;\n    this.cachedWdaStatus = null;\n\n    this.curWebFrames = [];\n    this._currentUrl = null;\n    this.curContext = null;\n    this.xcodeVersion = {};\n    this.contexts = [];\n    this.implicitWaitMs = 0;\n    this.asynclibWaitMs = 0;\n    this.pageLoadMs = 6000;\n    this.landscapeWebCoordsOffset = 0;\n    this.remote = null;\n    this._conditionInducerService = null;\n\n    this.webElementsCache = new LRU({\n      max: WEB_ELEMENTS_CACHE_SIZE,\n    });\n  }\n\n  get driverData () {\n    // TODO fill out resource info here\n    return {};\n  }\n\n  async getStatus () {\n    if (typeof this.driverInfo === 'undefined') {\n      this.driverInfo = await getDriverInfo();\n    }\n    let status = {build: {version: this.driverInfo.version}};\n    if (this.cachedWdaStatus) {\n      status.wda = this.cachedWdaStatus;\n    }\n    return status;\n  }\n\n  mergeCliArgsToOpts () {\n    let didMerge = false;\n    // this.cliArgs should never include anything we do not expect.\n    for (const [key, value] of Object.entries(this.cliArgs ?? {})) {\n      if (_.has(this.opts, key)) {\n        this.log.info(`CLI arg '${key}' with value '${value}' overwrites value '${this.opts[key]}' sent in via caps)`);\n        didMerge = true;\n      }\n      this.opts[key] = value;\n    }\n    return didMerge;\n  }\n\n  async createSession (...args) {\n    this.lifecycleData = {}; // this is used for keeping track of the state we start so when we delete the session we can put things back\n    try {\n      let [sessionId, caps] = await super.createSession(...args);\n      this.opts.sessionId = sessionId;\n\n      // merge cli args to opts, and if we did merge any, revalidate opts to ensure the final set\n      // is also consistent\n      if (this.mergeCliArgsToOpts()) {\n        this.validateDesiredCaps({...caps, ...this.cliArgs});\n      }\n\n      await this.start();\n\n      // merge server capabilities + desired capabilities\n      caps = Object.assign({}, defaultServerCaps, caps);\n      // update the udid with what is actually used\n      caps.udid = this.opts.udid;\n      // ensure we track nativeWebTap capability as a setting as well\n      if (_.has(this.opts, 'nativeWebTap')) {\n        await this.updateSettings({nativeWebTap: this.opts.nativeWebTap});\n      }\n      // ensure we track nativeWebTapStrict capability as a setting as well\n      if (_.has(this.opts, 'nativeWebTapStrict')) {\n        await this.updateSettings({nativeWebTapStrict: this.opts.nativeWebTapStrict});\n      }\n      // ensure we track useJSONSource capability as a setting as well\n      if (_.has(this.opts, 'useJSONSource')) {\n        await this.updateSettings({useJSONSource: this.opts.useJSONSource});\n      }\n\n      let wdaSettings = {\n        elementResponseAttributes: DEFAULT_SETTINGS.elementResponseAttributes,\n        shouldUseCompactResponses: DEFAULT_SETTINGS.shouldUseCompactResponses,\n      };\n      if (_.has(this.opts, 'elementResponseAttributes')) {\n        wdaSettings.elementResponseAttributes = this.opts.elementResponseAttributes;\n      }\n      if (_.has(this.opts, 'shouldUseCompactResponses')) {\n        wdaSettings.shouldUseCompactResponses = this.opts.shouldUseCompactResponses;\n      }\n      if (_.has(this.opts, 'mjpegServerScreenshotQuality')) {\n        wdaSettings.mjpegServerScreenshotQuality = this.opts.mjpegServerScreenshotQuality;\n      }\n      if (_.has(this.opts, 'mjpegServerFramerate')) {\n        wdaSettings.mjpegServerFramerate = this.opts.mjpegServerFramerate;\n      }\n      if (_.has(this.opts, 'screenshotQuality')) {\n        this.log.info(`Setting the quality of phone screenshot: '${this.opts.screenshotQuality}'`);\n        wdaSettings.screenshotQuality = this.opts.screenshotQuality;\n      }\n      // ensure WDA gets our defaults instead of whatever its own might be\n      await this.updateSettings(wdaSettings);\n\n      // turn on mjpeg stream reading if requested\n      if (this.opts.mjpegScreenshotUrl) {\n        this.log.info(`Starting MJPEG stream reading URL: '${this.opts.mjpegScreenshotUrl}'`);\n        this.mjpegStream = new mjpeg.MJpegStream(this.opts.mjpegScreenshotUrl);\n        await this.mjpegStream.start();\n      }\n      return [sessionId, caps];\n    } catch (e) {\n      this.log.error(JSON.stringify(e));\n      await this.deleteSession();\n      throw e;\n    }\n  }\n\n  /**\n   * Returns the default URL for Safari browser\n   * @returns {string} The default URL\n   */\n  getDefaultUrl () {\n    // Setting this to some external URL slows down Appium startup\n    return this.isRealDevice()\n      ? `http://127.0.0.1:${this.opts.wdaLocalPort || 8100}/health`\n      : `http://${\n        this.opts.address.includes(':') ? `[${this.opts.address}]` : this.opts.address\n      }:${this.opts.port}/welcome`;\n  }\n\n  async start () {\n    this.opts.noReset = !!this.opts.noReset;\n    this.opts.fullReset = !!this.opts.fullReset;\n\n    await printUser();\n\n    this.opts.iosSdkVersion = null; // For WDA and xcodebuild\n    const {device, udid, realDevice} = await this.determineDevice();\n    this.log.info(`Determining device to run tests on: udid: '${udid}', real device: ${realDevice}`);\n    this.opts.device = device;\n    this.opts.udid = udid;\n    this.opts.realDevice = realDevice;\n\n    if (this.opts.simulatorDevicesSetPath) {\n      if (realDevice) {\n        this.log.info(`The 'simulatorDevicesSetPath' capability is only supported for Simulator devices`);\n      } else {\n        this.log.info(`Setting simulator devices set path to '${this.opts.simulatorDevicesSetPath}'`);\n        this.opts.device.devicesSetPath = this.opts.simulatorDevicesSetPath;\n      }\n    }\n\n    // at this point if there is no platformVersion, get it from the device\n    if (!this.opts.platformVersion && this.opts.device) {\n      this.opts.platformVersion = await this.opts.device.getPlatformVersion();\n      this.log.info(`No platformVersion specified. Using device version: '${this.opts.platformVersion}'`);\n    }\n\n    const normalizedVersion = normalizePlatformVersion(this.opts.platformVersion);\n    if (this.opts.platformVersion !== normalizedVersion) {\n      this.log.info(`Normalized platformVersion capability value '${this.opts.platformVersion}' to '${normalizedVersion}'`);\n      this.opts.platformVersion = normalizedVersion;\n    }\n    if (util.compareVersions(this.opts.platformVersion, '<', '9.3')) {\n      throw new Error(`Platform version must be 9.3 or above. '${this.opts.platformVersion}' is not supported.`);\n    }\n\n    if (_.isEmpty(this.xcodeVersion) && (!this.opts.webDriverAgentUrl || !this.opts.realDevice)) {\n      // no `webDriverAgentUrl`, or on a simulator, so we need an Xcode version\n      this.xcodeVersion = await getAndCheckXcodeVersion();\n    }\n    this.logEvent('xcodeDetailsRetrieved');\n\n    if (_.toLower(this.opts.browserName) === 'safari') {\n      this.log.info('Safari test requested');\n      this.safari = true;\n      this.opts.app = undefined;\n      this.opts.processArguments = this.opts.processArguments || {};\n      this.opts.bundleId = SAFARI_BUNDLE_ID;\n      this._currentUrl = this.opts.safariInitialUrl || this.getDefaultUrl();\n    } else if (this.opts.app || this.opts.bundleId) {\n      await this.configureApp();\n    }\n    this.logEvent('appConfigured');\n\n    // fail very early if the app doesn't actually exist\n    // or if bundle id doesn't point to an installed app\n    if (this.opts.app) {\n      await checkAppPresent(this.opts.app);\n\n      if (!this.opts.bundleId) {\n        this.opts.bundleId = await extractBundleId(this.opts.app);\n      }\n    }\n\n    await this.runReset();\n\n    this.wda = new WebDriverAgent(this.xcodeVersion, this.opts, this.log);\n    // Derived data path retrieval is an expensive operation\n    // We could start that now in background and get the cached result\n    // whenever it is needed\n    // eslint-disable-next-line promise/prefer-await-to-then\n    this.wda.retrieveDerivedDataPath().catch((e) => this.log.debug(e));\n\n    const memoizedLogInfo = _.memoize(() => {\n      this.log.info(\"'skipLogCapture' is set. Skipping starting logs such as crash, system, safari console and safari network.\");\n    });\n    const startLogCapture = async () => {\n      if (this.opts.skipLogCapture) {\n        memoizedLogInfo();\n        return false;\n      }\n\n      const result = await this.startLogCapture();\n      if (result) {\n        this.logEvent('logCaptureStarted');\n      }\n      return result;\n    };\n    const isLogCaptureStarted = await startLogCapture();\n\n    this.log.info(`Setting up ${this.isRealDevice() ? 'real device' : 'simulator'}`);\n\n    if (this.isSimulator()) {\n      if (this.opts.shutdownOtherSimulators) {\n        this.ensureFeatureEnabled(SHUTDOWN_OTHER_FEAT_NAME);\n        await shutdownOtherSimulators(this.opts.device);\n      }\n\n      // this should be done before the simulator is started\n      // if it is already running, this cap won't work, which is documented\n      if (this.isSafari() && this.opts.safariGlobalPreferences) {\n        if (await this.opts.device.updateSafariGlobalSettings(this.opts.safariGlobalPreferences)) {\n          this.log.debug(`Safari global preferences updated`);\n        }\n      }\n\n      this.localConfig = await setLocaleAndPreferences(this.opts.device, this.opts, this.isSafari(), async (sim) => {\n        await shutdownSimulator(sim);\n\n        // we don't know if there needs to be changes a priori, so change first.\n        // sometimes the shutdown process changes the settings, so reset them,\n        // knowing that the sim is already shut\n        await setLocaleAndPreferences(sim, this.opts, this.isSafari());\n      });\n\n      if (this.opts.customSSLCert && !(await doesSupportKeychainApi(this.opts.device))) {\n        const certHead = _.truncate(this.opts.customSSLCert, {length: 20});\n        this.log.info(`Installing the custom SSL certificate '${certHead}'`);\n        if (await hasCertificateLegacy(this.opts.device, this.opts.customSSLCert)) {\n          this.log.info(`SSL certificate '${certHead}' already installed`);\n        } else {\n          this.log.info(`Making sure Simulator is shut down, ' +\n            'so that SSL certificate installation takes effect`);\n          await shutdownSimulator(this.opts.device);\n          await installCertificateLegacy(this.opts.device, this.opts.customSSLCert);\n        }\n        this.logEvent('customCertInstalled');\n      }\n\n      await this.startSim();\n\n      if (this.opts.customSSLCert && await doesSupportKeychainApi(this.opts.device)) {\n        // Simulator must be booted in order to call this helper\n        await installCertificate(this.opts.device, this.opts.customSSLCert);\n        this.logEvent('customCertInstalled');\n      }\n\n      if (this.opts.launchWithIDB && this.isSimulator()) {\n        try {\n          const idb = new IDB({udid});\n          await idb.connect();\n          this.opts.device.idb = idb;\n        } catch (e) {\n          this.log.info(`idb will not be used for Simulator interaction. Original error: ${e.message}`);\n        }\n      }\n\n      this.logEvent('simStarted');\n      if (!isLogCaptureStarted) {\n        // Retry log capture if Simulator was not running before\n        await startLogCapture();\n      }\n    } else if (this.opts.customSSLCert) {\n      await new Pyidevice(udid).installProfile({payload: this.opts.customSSLCert});\n    }\n\n    if (this.opts.app) {\n      await this.installAUT();\n      this.logEvent('appInstalled');\n    }\n\n    // if we only have bundle identifier and no app, fail if it is not already installed\n    if (!this.opts.app && this.opts.bundleId && !this.isSafari()) {\n      if (!await this.opts.device.isAppInstalled(this.opts.bundleId)) {\n        this.log.errorAndThrow(`App with bundle identifier '${this.opts.bundleId}' unknown`);\n      }\n    }\n\n    if (this.opts.permissions) {\n      if (this.isSimulator()) {\n        this.log.debug('Setting the requested permissions before WDA is started');\n        for (const [bundleId, permissionsMapping] of _.toPairs(JSON.parse(this.opts.permissions))) {\n          await this.opts.device.setPermissions(bundleId, permissionsMapping);\n        }\n      } else {\n        this.log.warn('Setting permissions is only supported on Simulator. ' +\n          'The \"permissions\" capability will be ignored.');\n      }\n    }\n\n    if (this.isSimulator()) {\n      if (this.opts.calendarAccessAuthorized) {\n        await this.opts.device.enableCalendarAccess(this.opts.bundleId);\n      } else if (this.opts.calendarAccessAuthorized === false) {\n        await this.opts.device.disableCalendarAccess(this.opts.bundleId);\n      }\n    }\n\n    await this.startWda(this.opts.sessionId, realDevice);\n\n    await this.setReduceMotion(this.opts.reduceMotion);\n\n    await this.setInitialOrientation(this.opts.orientation);\n    this.logEvent('orientationSet');\n\n    if (this.isSafari() || this.opts.autoWebview) {\n      await this.activateRecentWebview();\n    }\n    if (this.isSafari()) {\n      if (!(this.opts.safariInitialUrl === ''\n          || (this.opts.noReset && _.isNil(this.opts.safariInitialUrl)))) {\n        this.log.info(`About to set the initial Safari URL to '${this.getCurrentUrl()}'.` +\n          `Use 'safariInitialUrl' capability in order to customize it`);\n        await this.setUrl(this.getCurrentUrl());\n      } else {\n        this.setCurrentUrl(await this.getUrl());\n      }\n    }\n  }\n\n  /**\n   * Start WebDriverAgentRunner\n   * @param {string} sessionId - The id of the target session to launch WDA with.\n   * @param {boolean} realDevice - Equals to true if the test target device is a real device.\n   */\n  async startWda (sessionId, realDevice) {\n    // Don't cleanup the processes if webDriverAgentUrl is set\n    if (!util.hasValue(this.wda.webDriverAgentUrl)) {\n      await this.wda.cleanupObsoleteProcesses();\n    }\n\n    const usePortForwarding = this.isRealDevice()\n      && !this.wda.webDriverAgentUrl\n      && isLocalHost(this.wda.wdaBaseUrl);\n    await DEVICE_CONNECTIONS_FACTORY.requestConnection(this.opts.udid, this.wda.url.port, {\n      devicePort: usePortForwarding ? this.wda.wdaRemotePort : null,\n      usePortForwarding,\n    });\n\n    // Let multiple WDA binaries with different derived data folders be built in parallel\n    // Concurrent WDA builds from the same source will cause xcodebuild synchronization errors\n    let synchronizationKey = XCUITestDriver.name;\n    if (this.opts.useXctestrunFile || !(await this.wda.isSourceFresh())) {\n      // First-time compilation is an expensive operation, which is done faster if executed\n      // sequentially. Xcodebuild spreads the load caused by the clang compiler to all available CPU cores\n      const derivedDataPath = await this.wda.retrieveDerivedDataPath();\n      if (derivedDataPath) {\n        synchronizationKey = path.normalize(derivedDataPath);\n      }\n    }\n    this.log.debug(`Starting WebDriverAgent initialization with the synchronization key '${synchronizationKey}'`);\n    if (SHARED_RESOURCES_GUARD.isBusy() && !this.opts.derivedDataPath && !this.opts.bootstrapPath) {\n      this.log.debug(`Consider setting a unique 'derivedDataPath' capability value for each parallel driver instance ` +\n        `to avoid conflicts and speed up the building process`);\n    }\n    return await SHARED_RESOURCES_GUARD.acquire(synchronizationKey, async () => {\n      if (this.opts.useNewWDA) {\n        this.log.debug(`Capability 'useNewWDA' set to true, so uninstalling WDA before proceeding`);\n        await this.wda.quitAndUninstall();\n        this.logEvent('wdaUninstalled');\n      } else if (!util.hasValue(this.wda.webDriverAgentUrl)) {\n        await this.wda.setupCaching();\n      }\n\n      // local helper for the two places we need to uninstall wda and re-start it\n      const quitAndUninstall = async (msg) => {\n        this.log.debug(msg);\n        if (this.opts.webDriverAgentUrl) {\n          this.log.debug('Not quitting/uninstalling WebDriverAgent since webDriverAgentUrl capability is provided');\n          throw new Error(msg);\n        }\n        this.log.warn('Quitting and uninstalling WebDriverAgent');\n        await this.wda.quitAndUninstall();\n\n        throw new Error(msg);\n      };\n\n      // Used in the following WDA build\n      if (this.opts.resultBundlePath) {\n        this.ensureFeatureEnabled(CUSTOMIZE_RESULT_BUNDPE_PATH);\n      }\n\n      const startupRetries = this.opts.wdaStartupRetries || (this.isRealDevice() ? WDA_REAL_DEV_STARTUP_RETRIES : WDA_SIM_STARTUP_RETRIES);\n      const startupRetryInterval = this.opts.wdaStartupRetryInterval || WDA_STARTUP_RETRY_INTERVAL;\n      this.log.debug(`Trying to start WebDriverAgent ${startupRetries} times with ${startupRetryInterval}ms interval`);\n      if (!util.hasValue(this.opts.wdaStartupRetries) && !util.hasValue(this.opts.wdaStartupRetryInterval)) {\n        this.log.debug(`These values can be customized by changing wdaStartupRetries/wdaStartupRetryInterval capabilities`);\n      }\n      let retryCount = 0;\n      await retryInterval(startupRetries, startupRetryInterval, async () => {\n        this.logEvent('wdaStartAttempted');\n        if (retryCount > 0) {\n          this.log.info(`Retrying WDA startup (${retryCount + 1} of ${startupRetries})`);\n        }\n        try {\n          // on xcode 10 installd will often try to access the app from its staging\n          // directory before fully moving it there, and fail. Retrying once\n          // immediately helps\n          const retries = this.xcodeVersion.major >= 10 ? 2 : 1;\n          this.cachedWdaStatus = await retry(retries, this.wda.launch.bind(this.wda), sessionId, realDevice);\n        } catch (err) {\n          this.logEvent('wdaStartFailed');\n          retryCount++;\n          let errorMsg = `Unable to launch WebDriverAgent because of xcodebuild failure: ${err.message}`;\n          if (this.isRealDevice()) {\n            errorMsg += `. Make sure you follow the tutorial at ${WDA_REAL_DEV_TUTORIAL_URL}. ` +\n                        `Try to remove the WebDriverAgentRunner application from the device if it is installed ` +\n                        `and reboot the device.`;\n          }\n          await quitAndUninstall(errorMsg);\n        }\n\n        this.proxyReqRes = this.wda.proxyReqRes.bind(this.wda);\n        this.jwpProxyActive = true;\n\n        let originalStacktrace = null;\n        try {\n          await retryInterval(15, 1000, async () => {\n            this.logEvent('wdaSessionAttempted');\n            this.log.debug('Sending createSession command to WDA');\n            try {\n              this.cachedWdaStatus = this.cachedWdaStatus || await this.proxyCommand('/status', 'GET');\n              await this.startWdaSession(this.opts.bundleId, this.opts.processArguments);\n            } catch (err) {\n              originalStacktrace = err.stack;\n              this.log.debug(`Failed to create WDA session (${err.message}). Retrying...`);\n              throw err;\n            }\n          });\n          this.logEvent('wdaSessionStarted');\n        } catch (err) {\n          if (originalStacktrace) {\n            this.log.debug(originalStacktrace);\n          }\n          let errorMsg = `Unable to start WebDriverAgent session because of xcodebuild failure: ${err.message}`;\n          if (this.isRealDevice()) {\n            errorMsg += ` Make sure you follow the tutorial at ${WDA_REAL_DEV_TUTORIAL_URL}. ` +\n                        `Try to remove the WebDriverAgentRunner application from the device if it is installed ` +\n                        `and reboot the device.`;\n          }\n          await quitAndUninstall(errorMsg);\n        }\n\n        if (this.opts.clearSystemFiles && !this.opts.webDriverAgentUrl) {\n          await markSystemFilesForCleanup(this.wda);\n        }\n\n        // we expect certain socket errors until this point, but now\n        // mark things as fully working\n        this.wda.fullyStarted = true;\n        this.logEvent('wdaStarted');\n      });\n    });\n  }\n\n  async runReset (opts = null) {\n    this.logEvent('resetStarted');\n    if (this.isRealDevice()) {\n      await runRealDeviceReset(this.opts.device, opts || this.opts);\n    } else {\n      await runSimulatorReset(this.opts.device, opts || this.opts);\n    }\n    this.logEvent('resetComplete');\n  }\n\n  async deleteSession () {\n    await removeAllSessionWebSocketHandlers(this.server, this.sessionId);\n\n    for (const recorder of _.compact([\n      this._recentScreenRecorder, this._audioRecorder, this._trafficCapture\n    ])) {\n      await recorder.interrupt(true);\n      await recorder.cleanup();\n    }\n\n    if (!_.isEmpty(this._perfRecorders)) {\n      await B.all(this._perfRecorders.map((x) => x.stop(true)));\n      this._perfRecorders = [];\n    }\n\n    if (this._conditionInducerService) {\n      this.mobileDisableConditionInducer();\n    }\n\n    await this.stop();\n\n    if (this.wda && !this.opts.webDriverAgentUrl) {\n      if (this.opts.clearSystemFiles) {\n        let synchronizationKey = XCUITestDriver.name;\n        const derivedDataPath = await this.wda.retrieveDerivedDataPath();\n        if (derivedDataPath) {\n          synchronizationKey = path.normalize(derivedDataPath);\n        }\n        await SHARED_RESOURCES_GUARD.acquire(synchronizationKey, async () => {\n          await clearSystemFiles(this.wda);\n        });\n      } else {\n        this.log.debug('Not clearing log files. Use `clearSystemFiles` capability to turn on.');\n      }\n    }\n\n    if (this.remote) {\n      this.log.debug('Found a remote debugger session. Removing...');\n      await this.stopRemote();\n    }\n\n    if (this.opts.resetOnSessionStartOnly === false) {\n      await this.runReset(Object.assign({}, this.opts, {\n        enforceSimulatorShutdown: true,\n      }));\n    }\n\n    if (this.isSimulator() && !this.opts.noReset && !!this.opts.device) {\n      if (this.lifecycleData.createSim) {\n        this.log.debug(`Deleting simulator created for this run (udid: '${this.opts.udid}')`);\n        await shutdownSimulator(this.opts.device);\n        await this.opts.device.delete();\n      }\n    }\n\n    const shouldResetLocationServivce = this.isRealDevice() && !!this.opts.resetLocationService;\n    if (shouldResetLocationServivce) {\n      try {\n        await this.mobileResetLocationService();\n      } catch (ignore) { /* Ignore this error since mobileResetLocationService already logged the error */ }\n    }\n\n    if (!_.isEmpty(this.logs)) {\n      await this.logs.syslog.stopCapture();\n      this.logs = {};\n    }\n\n    if (this.mjpegStream) {\n      this.log.info('Closing MJPEG stream');\n      this.mjpegStream.stop();\n    }\n\n    this.resetIos();\n\n    await super.deleteSession();\n  }\n\n  async stop () {\n    this.jwpProxyActive = false;\n    this.proxyReqRes = null;\n\n\n    if (this.wda && this.wda.fullyStarted) {\n      if (this.wda.jwproxy) {\n        try {\n          await this.proxyCommand(`/session/${this.sessionId}`, 'DELETE');\n        } catch (err) {\n          // an error here should not short-circuit the rest of clean up\n          this.log.debug(`Unable to DELETE session on WDA: '${err.message}'. Continuing shutdown.`);\n        }\n      }\n      if (!this.wda.webDriverAgentUrl && this.opts.useNewWDA) {\n        await this.wda.quit();\n      }\n    }\n\n    DEVICE_CONNECTIONS_FACTORY.releaseConnection(this.opts.udid);\n  }\n\n  async executeCommand (cmd, ...args) {\n    this.log.debug(`Executing command '${cmd}'`);\n\n    if (cmd === 'receiveAsyncResponse') {\n      return await this.receiveAsyncResponse(...args);\n    }\n    // TODO: once this fix gets into base driver remove from here\n    if (cmd === 'getStatus') {\n      return await this.getStatus();\n    }\n    return await super.executeCommand(cmd, ...args);\n  }\n\n  async configureApp () {\n    function appIsPackageOrBundle (app) {\n      return (/^([a-zA-Z0-9\\-_]+\\.[a-zA-Z0-9\\-_]+)+$/).test(app);\n    }\n\n    // the app name is a bundleId assign it to the bundleId property\n    if (!this.opts.bundleId && appIsPackageOrBundle(this.opts.app)) {\n      this.opts.bundleId = this.opts.app;\n      this.opts.app = '';\n    }\n    // we have a bundle ID, but no app, or app is also a bundle\n    if ((this.opts.bundleId && appIsPackageOrBundle(this.opts.bundleId)) &&\n        (this.opts.app === '' || appIsPackageOrBundle(this.opts.app))) {\n      this.log.debug('App is an iOS bundle, will attempt to run as pre-existing');\n      return;\n    }\n\n    // check for supported build-in apps\n    switch (_.toLower(this.opts.app)) {\n      case 'settings':\n        this.opts.bundleId = 'com.apple.Preferences';\n        this.opts.app = null;\n        return;\n      case 'calendar':\n        this.opts.bundleId = 'com.apple.mobilecal';\n        this.opts.app = null;\n        return;\n    }\n\n    this.opts.app = await this.helpers.configureApp(this.opts.app, {\n      onPostProcess: this.onPostConfigureApp.bind(this),\n      supportedExtensions: SUPPORTED_EXTENSIONS\n    });\n  }\n\n  /**\n   * Unzip the given archive and find a matching .app bundle in it\n   *\n   * @param {string} appPath The path to the archive.\n   * @param {number} depth [0] the current nesting depth. App bundles whose nesting level\n   * is greater than 1 are not supported.\n   * @returns {string} Full path to the first matching .app bundle..\n   * @throws If no matching .app bundles were found in the provided archive.\n   */\n  async unzipApp (appPath, depth = 0) {\n    if (depth > MAX_ARCHIVE_SCAN_DEPTH) {\n      throw new Error('Nesting of package bundles is not supported');\n    }\n    const [rootDir, matchedPaths] = await findApps(appPath, SUPPORTED_EXTENSIONS);\n    if (_.isEmpty(matchedPaths)) {\n      this.log.debug(`'${path.basename(appPath)}' has no bundles`);\n    } else {\n      this.log.debug(\n        `Found ${util.pluralize('bundle', matchedPaths.length, true)} in ` +\n        `'${path.basename(appPath)}': ${matchedPaths}`\n      );\n    }\n    try {\n      for (const matchedPath of matchedPaths) {\n        const fullPath = path.join(rootDir, matchedPath);\n        if (await isAppBundle(fullPath)) {\n          const supportedPlatforms = await fetchSupportedAppPlatforms(fullPath);\n          if (this.isSimulator() && !supportedPlatforms.some((p) => _.includes(p, 'Simulator'))) {\n            this.log.info(`'${matchedPath}' does not have Simulator devices in the list of supported platforms ` +\n              `(${supportedPlatforms.join(',')}). Skipping it`);;\n            continue;\n          }\n          if (this.isRealDevice() && !supportedPlatforms.some((p) => _.includes(p, 'OS'))) {\n            this.log.info(`'${matchedPath}' does not have real devices in the list of supported platforms ` +\n              `(${supportedPlatforms.join(',')}). Skipping it`);;\n            continue;\n          }\n          this.log.info(`'${matchedPath}' is the resulting application bundle selected from '${appPath}'`);\n          return await isolateAppBundle(fullPath);\n        } else if (_.endsWith(_.toLower(fullPath), IPA_EXT) && (await fs.stat(fullPath)).isFile()) {\n          try {\n            return await this.unzipApp(fullPath, depth + 1);\n          } catch (e) {\n            this.log.warn(`Skipping processing of '${matchedPath}': ${e.message}`);\n          }\n        }\n      }\n    } finally {\n      await fs.rimraf(rootDir);\n    }\n    throw new Error(`${this.opts.app} did not have any matching ${APP_EXT} or ${IPA_EXT} ` +\n      `bundles. Please make sure the provided package is valid and contains at least one matching ` +\n      `application bundle which is not nested.`\n    );\n  }\n\n  async onPostConfigureApp ({cachedAppInfo, isUrl, appPath}) {\n    // Pick the previously cached entry if its integrity has been preserved\n    if (_.isPlainObject(cachedAppInfo)\n        && (await fs.stat(appPath)).isFile()\n        && await fs.hash(appPath) === cachedAppInfo.packageHash\n        && await fs.exists(cachedAppInfo.fullPath)\n        && (await fs.glob('**/*', {\n          cwd: cachedAppInfo.fullPath, strict: false, nosort: true\n        })).length === cachedAppInfo.integrity.folder) {\n      this.log.info(`Using '${cachedAppInfo.fullPath}' which was cached from '${appPath}'`);\n      return {appPath: cachedAppInfo.fullPath};\n    }\n\n    // Only local .app bundles that are available in-place should not be cached\n    if (await isAppBundle(appPath)) {\n      return false;\n    }\n\n    // Extract the app bundle and cache it\n    try {\n      return {appPath: await this.unzipApp(appPath)};\n    } finally {\n      // Cleanup previously downloaded archive\n      if (isUrl) {\n        await fs.rimraf(appPath);\n      }\n    }\n  }\n\n  async determineDevice () {\n    // in the one case where we create a sim, we will set this state\n    this.lifecycleData.createSim = false;\n\n    // if we get generic names, translate them\n    this.opts.deviceName = translateDeviceName(this.opts.platformVersion, this.opts.deviceName);\n\n    const setupVersionCaps = async () => {\n      this.opts.iosSdkVersion = await getAndCheckIosSdkVersion();\n      this.log.info(`iOS SDK Version set to '${this.opts.iosSdkVersion}'`);\n      if (!this.opts.platformVersion && this.opts.iosSdkVersion) {\n        this.log.info(`No platformVersion specified. Using the latest version Xcode supports: '${this.opts.iosSdkVersion}'. ` +\n          `This may cause problems if a simulator does not exist for this platform version.`);\n        this.opts.platformVersion = normalizePlatformVersion(this.opts.iosSdkVersion);\n      }\n    };\n\n    if (this.opts.udid) {\n      if (this.opts.udid.toLowerCase() === 'auto') {\n        try {\n          this.opts.udid = await detectUdid();\n        } catch (err) {\n          // Trying to find matching UDID for Simulator\n          this.log.warn(`Cannot detect any connected real devices. Falling back to Simulator. Original error: ${err.message}`);\n          const device = await getExistingSim(this.opts);\n          if (!device) {\n            // No matching Simulator is found. Throw an error\n            this.log.errorAndThrow(`Cannot detect udid for ${this.opts.deviceName} Simulator running iOS ${this.opts.platformVersion}`);\n          }\n\n          // Matching Simulator exists and is found. Use it\n          this.opts.udid = device.udid;\n          const devicePlatform = normalizePlatformVersion(await device.getPlatformVersion());\n          if (this.opts.platformVersion !== devicePlatform) {\n            this.opts.platformVersion = devicePlatform;\n            this.log.info(`Set platformVersion to '${devicePlatform}' to match the device with given UDID`);\n          }\n          await setupVersionCaps();\n          return {device, realDevice: false, udid: device.udid};\n        }\n      } else {\n        // make sure it is a connected device. If not, the udid passed in is invalid\n        const devices = await getConnectedDevices();\n        this.log.debug(`Available devices: ${devices.join(', ')}`);\n        if (!devices.includes(this.opts.udid)) {\n          // check for a particular simulator\n          this.log.debug(`No real device with udid '${this.opts.udid}'. Looking for simulator`);\n          try {\n            const device = await getSimulator(this.opts.udid, {\n              devicesSetPath: this.opts.simulatorDevicesSetPath,\n            });\n            return {device, realDevice: false, udid: this.opts.udid};\n          } catch (ign) {\n            throw new Error(`Unknown device or simulator UDID: '${this.opts.udid}'`);\n          }\n        }\n      }\n\n      const device = await getRealDeviceObj(this.opts.udid);\n      return {device, realDevice: true, udid: this.opts.udid};\n    }\n\n    // Now we know for sure the device will be a Simulator\n    await setupVersionCaps();\n    if (this.opts.enforceFreshSimulatorCreation) {\n      this.log.debug(`New simulator is requested. If this is not wanted, set 'enforceFreshSimulatorCreation' capability to false`);\n    } else {\n      // figure out the correct simulator to use, given the desired capabilities\n      const device = await getExistingSim(this.opts);\n\n      // check for an existing simulator\n      if (device) {\n        return {device, realDevice: false, udid: device.udid};\n      }\n\n      this.log.info('Simulator udid not provided');\n    }\n\n    // no device of this type exists, or they request new sim, so create one\n    this.log.info('Using desired caps to create a new simulator');\n    const device = await this.createSim();\n    return {device, realDevice: false, udid: device.udid};\n  }\n\n  async startSim () {\n    const runOpts = {\n      scaleFactor: this.opts.scaleFactor,\n      connectHardwareKeyboard: !!this.opts.connectHardwareKeyboard,\n      pasteboardAutomaticSync: this.opts.simulatorPasteboardAutomaticSync ?? 'off',\n      isHeadless: !!this.opts.isHeadless,\n      tracePointer: this.opts.simulatorTracePointer,\n      devicePreferences: {},\n    };\n\n    // add the window center, if it is specified\n    if (this.opts.SimulatorWindowCenter) {\n      runOpts.devicePreferences.SimulatorWindowCenter = this.opts.SimulatorWindowCenter;\n    }\n\n    if (_.isInteger(this.opts.simulatorStartupTimeout)) {\n      runOpts.startupTimeout = this.opts.simulatorStartupTimeout;\n    }\n\n    // This is to workaround XCTest bug about changing Simulator\n    // orientation is not synchronized to the actual window orientation\n    const orientation = _.isString(this.opts.orientation) && this.opts.orientation.toUpperCase();\n    switch (orientation) {\n      case 'LANDSCAPE':\n        runOpts.devicePreferences.SimulatorWindowOrientation = 'LandscapeLeft';\n        runOpts.devicePreferences.SimulatorWindowRotationAngle = 90;\n        break;\n      case 'PORTRAIT':\n        runOpts.devicePreferences.SimulatorWindowOrientation = 'Portrait';\n        runOpts.devicePreferences.SimulatorWindowRotationAngle = 0;\n        break;\n    }\n\n    await this.opts.device.run(runOpts);\n  }\n\n  async createSim () {\n    this.lifecycleData.createSim = true;\n\n    // Get platform name from const since it must be case sensitive to create a new simulator\n    const platformName = this.isTvOS() ? PLATFORM_NAME_TVOS : PLATFORM_NAME_IOS;\n\n    // create sim for caps\n    const sim = await createSim(this.opts, platformName);\n    this.log.info(`Created simulator with udid '${sim.udid}'.`);\n\n    return sim;\n  }\n\n  async launchApp () {\n    const APP_LAUNCH_TIMEOUT = 20 * 1000;\n\n    this.logEvent('appLaunchAttempted');\n    await this.opts.device.simctl.launchApp(this.opts.bundleId);\n\n    let checkStatus = async () => {\n      let response = await this.proxyCommand('/status', 'GET');\n      let currentApp = response.currentApp.bundleID;\n      if (currentApp !== this.opts.bundleId) {\n        throw new Error(`${this.opts.bundleId} not in foreground. ${currentApp} is in foreground`);\n      }\n    };\n\n    this.log.info(`Waiting for '${this.opts.bundleId}' to be in foreground`);\n    let retries = parseInt(APP_LAUNCH_TIMEOUT / 200, 10);\n    await retryInterval(retries, 200, checkStatus);\n    this.log.info(`${this.opts.bundleId} is in foreground`);\n    this.logEvent('appLaunched');\n  }\n\n  async startWdaSession (bundleId, processArguments) {\n    const args = processArguments ? (processArguments.args || []) : [];\n    if (!_.isArray(args)) {\n      throw new Error(`processArguments.args capability is expected to be an array. ` +\n        `${JSON.stringify(args)} is given instead`);\n    }\n    const env = processArguments ? (processArguments.env || {}) : {};\n    if (!_.isPlainObject(env)) {\n      throw new Error(`processArguments.env capability is expected to be a dictionary. ` +\n        `${JSON.stringify(env)} is given instead`);\n    }\n\n    if (util.hasValue(this.opts.language)) {\n      args.push('-AppleLanguages', `(${this.opts.language})`);\n      args.push('-NSLanguages', `(${this.opts.language})`);\n    }\n    if (util.hasValue(this.opts.locale)) {\n      args.push('-AppleLocale', this.opts.locale);\n    }\n\n    if (this.opts.noReset) {\n      if (_.isNil(this.opts.shouldTerminateApp)) {\n        this.opts.shouldTerminateApp = false;\n      }\n      if (_.isNil(this.opts.forceAppLaunch)) {\n        this.opts.forceAppLaunch = false;\n      }\n    }\n\n    const wdaCaps = {\n      bundleId: this.opts.autoLaunch === false ? undefined : bundleId,\n      arguments: args,\n      environment: env,\n      eventloopIdleDelaySec: this.opts.wdaEventloopIdleDelay ?? 0,\n      shouldWaitForQuiescence: this.opts.waitForQuiescence ?? true,\n      shouldUseTestManagerForVisibilityDetection: this.opts.simpleIsVisibleCheck ?? false,\n      maxTypingFrequency: this.opts.maxTypingFrequency ?? 60,\n      shouldUseSingletonTestManager: this.opts.shouldUseSingletonTestManager ?? true,\n      waitForIdleTimeout: this.opts.waitForIdleTimeout,\n      shouldUseCompactResponses: this.opts.shouldUseCompactResponses,\n      elementResponseFields: this.opts.elementResponseFields,\n      disableAutomaticScreenshots: this.opts.disableAutomaticScreenshots,\n      shouldTerminateApp: this.opts.shouldTerminateApp ?? true,\n      forceAppLaunch: this.opts.forceAppLaunch ?? true,\n      useNativeCachingStrategy: this.opts.useNativeCachingStrategy ?? true,\n      forceSimulatorSoftwareKeyboardPresence: this.opts.forceSimulatorSoftwareKeyboardPresence\n        ?? (this.opts.connectHardwareKeyboard === true ? false : true),\n    };\n    if (this.opts.autoAcceptAlerts) {\n      wdaCaps.defaultAlertAction = 'accept';\n    } else if (this.opts.autoDismissAlerts) {\n      wdaCaps.defaultAlertAction = 'dismiss';\n    }\n\n    await this.proxyCommand('/session', 'POST', {\n      capabilities: {\n        firstMatch: [wdaCaps],\n        alwaysMatch: {},\n      }\n    });\n  }\n\n  // Override Proxy methods from BaseDriver\n  proxyActive () {\n    return this.jwpProxyActive;\n  }\n\n  getProxyAvoidList () {\n    if (this.isWebview()) {\n      return NO_PROXY_WEB_LIST;\n    }\n    return NO_PROXY_NATIVE_LIST;\n  }\n\n  canProxy () {\n    return true;\n  }\n\n  isSafari () {\n    return !!this.safari;\n  }\n\n  isRealDevice () {\n    return this.opts.realDevice;\n  }\n\n  isSimulator () {\n    return !this.opts.realDevice;\n  }\n\n  isTvOS () {\n    return _.toLower(this.opts.platformName) === _.toLower(PLATFORM_NAME_TVOS);\n  }\n\n  isWebview () {\n    return this.isSafari() || this.isWebContext();\n  }\n\n  validateLocatorStrategy (strategy) {\n    super.validateLocatorStrategy(strategy, this.isWebContext());\n  }\n\n  validateDesiredCaps (caps) {\n    if (!super.validateDesiredCaps(caps)) {\n      return false;\n    }\n\n    // make sure that the capabilities have one of `app` or `bundleId`\n    if (_.toLower(caps.browserName) !== 'safari' && !caps.app && !caps.bundleId) {\n      this.log.info('The desired capabilities include neither an app nor a bundleId. ' +\n        'WebDriverAgent will be started without the default app');\n    }\n\n    if (!util.coerceVersion(caps.platformVersion, false)) {\n      this.log.warn(`'platformVersion' capability ('${caps.platformVersion}') is not a valid version number. ` +\n        `Consider fixing it or be ready to experience an inconsistent driver behavior.`);\n    }\n\n    let verifyProcessArgument = (processArguments) => {\n      const {args, env} = processArguments;\n      if (!_.isNil(args) && !_.isArray(args)) {\n        this.log.errorAndThrow('processArguments.args must be an array of strings');\n      }\n      if (!_.isNil(env) && !_.isPlainObject(env)) {\n        this.log.errorAndThrow('processArguments.env must be an object <key,value> pair {a:b, c:d}');\n      }\n    };\n\n    // `processArguments` should be JSON string or an object with arguments and/ environment details\n    if (caps.processArguments) {\n      if (_.isString(caps.processArguments)) {\n        try {\n          // try to parse the string as JSON\n          caps.processArguments = JSON.parse(caps.processArguments);\n          verifyProcessArgument(caps.processArguments);\n        } catch (err) {\n          this.log.errorAndThrow(`processArguments must be a JSON format or an object with format {args : [], env : {a:b, c:d}}. ` +\n            `Both environment and argument can be null. Error: ${err}`);\n        }\n      } else if (_.isPlainObject(caps.processArguments)) {\n        verifyProcessArgument(caps.processArguments);\n      } else {\n        this.log.errorAndThrow(`'processArguments must be an object, or a string JSON object with format {args : [], env : {a:b, c:d}}. ` +\n          `Both environment and argument can be null.`);\n      }\n    }\n\n    // there is no point in having `keychainPath` without `keychainPassword`\n    if ((caps.keychainPath && !caps.keychainPassword) || (!caps.keychainPath && caps.keychainPassword)) {\n      this.log.errorAndThrow(`If 'keychainPath' is set, 'keychainPassword' must also be set (and vice versa).`);\n    }\n\n    // `resetOnSessionStartOnly` should be set to true by default\n    this.opts.resetOnSessionStartOnly = !util.hasValue(this.opts.resetOnSessionStartOnly) || this.opts.resetOnSessionStartOnly;\n    this.opts.useNewWDA = util.hasValue(this.opts.useNewWDA) ? this.opts.useNewWDA : false;\n\n    if (caps.commandTimeouts) {\n      caps.commandTimeouts = normalizeCommandTimeouts(caps.commandTimeouts);\n    }\n\n    if (_.isString(caps.webDriverAgentUrl)) {\n      const {protocol, host} = url.parse(caps.webDriverAgentUrl);\n      if (_.isEmpty(protocol) || _.isEmpty(host)) {\n        this.log.errorAndThrow(`'webDriverAgentUrl' capability is expected to contain a valid WebDriverAgent server URL. ` +\n                          `'${caps.webDriverAgentUrl}' is given instead`);\n      }\n    }\n\n    if (caps.browserName) {\n      if (caps.bundleId) {\n        this.log.errorAndThrow(`'browserName' cannot be set together with 'bundleId' capability`);\n      }\n      // warn if the capabilities have both `app` and `browser, although this\n      // is common with selenium grid\n      if (caps.app) {\n        this.log.warn(`The capabilities should generally not include both an 'app' and a 'browserName'`);\n      }\n    }\n\n    if (caps.permissions) {\n      try {\n        for (const [bundleId, perms] of _.toPairs(JSON.parse(caps.permissions))) {\n          if (!_.isString(bundleId)) {\n            throw new Error(`'${JSON.stringify(bundleId)}' must be a string`);\n          }\n          if (!_.isPlainObject(perms)) {\n            throw new Error(`'${JSON.stringify(perms)}' must be a JSON object`);\n          }\n        }\n      } catch (e) {\n        this.log.errorAndThrow(`'${caps.permissions}' is expected to be a valid object with format ` +\n          `{\"<bundleId1>\": {\"<serviceName1>\": \"<serviceStatus1>\", ...}, ...}. Original error: ${e.message}`);\n      }\n    }\n\n    if (caps.platformVersion && !util.coerceVersion(caps.platformVersion, false)) {\n      this.log.errorAndThrow(`'platformVersion' must be a valid version number. ` +\n        `'${caps.platformVersion}' is given instead.`);\n    }\n\n    // additionalWebviewBundleIds is an array, JSON array, or string\n    if (caps.additionalWebviewBundleIds) {\n      caps.additionalWebviewBundleIds = this.helpers.parseCapsArray(caps.additionalWebviewBundleIds);\n    }\n\n    // finally, return true since the superclass check passed, as did this\n    return true;\n  }\n\n  async installAUT () {\n    if (this.isSafari()) {\n      return;\n    }\n\n    await verifyApplicationPlatform(this.opts.app, {\n      isSimulator: this.isSimulator(),\n      isTvOS: this.isTvOS(),\n    });\n\n    if (this.isRealDevice()) {\n      await installToRealDevice(this.opts.device, this.opts.app, this.opts.bundleId, {\n        noReset: this.opts.noReset,\n        timeout: this.opts.appPushTimeout,\n        strategy: this.opts.appInstallStrategy,\n      });\n    } else {\n      await installToSimulator(this.opts.device, this.opts.app, this.opts.bundleId, {\n        noReset: this.opts.noReset,\n        newSimulator: this.lifecycleData.createSim,\n      });\n    }\n    if (this.opts.otherApps) {\n      await this.installOtherApps(this.opts.otherApps);\n    }\n\n    if (util.hasValue(this.opts.iosInstallPause)) {\n      // https://github.com/appium/appium/issues/6889\n      let pause = parseInt(this.opts.iosInstallPause, 10);\n      this.log.debug(`iosInstallPause set. Pausing ${pause} ms before continuing`);\n      await B.delay(pause);\n    }\n  }\n\n  async installOtherApps (otherApps) {\n    if (this.isRealDevice()) {\n      this.log.warn('Capability otherApps is only supported for Simulators');\n      return;\n    }\n    let appsList;\n    try {\n      appsList = this.helpers.parseCapsArray(otherApps);\n    } catch (e) {\n      this.log.errorAndThrow(`Could not parse \"otherApps\" capability: ${e.message}`);\n    }\n    if (_.isEmpty(appsList)) {\n      this.log.info(`Got zero apps from 'otherApps' capability value. Doing nothing`);\n      return;\n    }\n\n    const appPaths = await B.all(appsList.map(\n      (app) => this.helpers.configureApp(app, '.app')\n    ));\n    for (const otherApp of appPaths) {\n      await installToSimulator(this.opts.device, otherApp, undefined, {\n        noReset: this.opts.noReset,\n        newSimulator: this.lifecycleData.createSim,\n      });\n    }\n  }\n\n  /**\n   * Set reduceMotion as 'isEnabled' only when the capabilities has 'reduceMotion'\n   * The call is ignored for real devices.\n   * @param {?boolean} isEnabled Wether enable reduceMotion\n   */\n  async setReduceMotion (isEnabled) {\n    if (this.isRealDevice() || !_.isBoolean(isEnabled)) {\n      return;\n    }\n\n    this.log.info(`Setting reduceMotion to ${isEnabled}`);\n    await this.updateSettings({reduceMotion: isEnabled});\n  }\n\n  async setInitialOrientation (orientation) {\n    if (!_.isString(orientation)) {\n      this.log.info('Skipping setting of the initial display orientation. ' +\n        'Set the \"orientation\" capability to either \"LANDSCAPE\" or \"PORTRAIT\", if this is an undesired behavior.');\n      return;\n    }\n    orientation = orientation.toUpperCase();\n    if (!_.includes(['LANDSCAPE', 'PORTRAIT'], orientation)) {\n      this.log.debug(`Unable to set initial orientation to '${orientation}'`);\n      return;\n    }\n    this.log.debug(`Setting initial orientation to '${orientation}'`);\n    try {\n      await this.proxyCommand('/orientation', 'POST', {orientation});\n      this.opts.curOrientation = orientation;\n    } catch (err) {\n      this.log.warn(`Setting initial orientation failed with: ${err.message}`);\n    }\n  }\n\n  _getCommandTimeout (cmdName) {\n    if (this.opts.commandTimeouts) {\n      if (cmdName && _.has(this.opts.commandTimeouts, cmdName)) {\n        return this.opts.commandTimeouts[cmdName];\n      }\n      return this.opts.commandTimeouts[DEFAULT_TIMEOUT_KEY];\n    }\n  }\n\n  /**\n   * Get session capabilities merged with what WDA reports\n   * This is a library command but needs to call 'super' so can't be on\n   * a helper object\n   */\n  async getSession () {\n    // call super to get event timings, etc...\n    const driverSession = await super.getSession();\n    if (!this.wdaCaps) {\n      this.wdaCaps = await this.proxyCommand('/', 'GET');\n    }\n\n    const shouldGetDeviceCaps = _.isBoolean(this.opts.includeDeviceCapsToSessionInfo)\n      ? this.opts.includeDeviceCapsToSessionInfo\n      : true; // Backward compatibility\n    if (shouldGetDeviceCaps && !this.deviceCaps) {\n      const {statusBarSize, scale} = await this.getScreenInfo();\n      this.deviceCaps = {\n        pixelRatio: scale,\n        statBarHeight: statusBarSize.height,\n        viewportRect: await this.getViewportRect(),\n      };\n    }\n    this.log.info('Merging WDA caps over Appium caps for session detail response');\n    return Object.assign({udid: this.opts.udid}, driverSession,\n      this.wdaCaps.capabilities, this.deviceCaps || {});\n  }\n\n  async reset () {\n    if (this.opts.noReset) {\n      // This is to make sure reset happens even if noReset is set to true\n      let opts = _.cloneDeep(this.opts);\n      opts.noReset = false;\n      opts.fullReset = false;\n      const shutdownHandler = this.resetOnUnexpectedShutdown;\n      this.resetOnUnexpectedShutdown = () => {};\n      try {\n        await this.runReset(opts);\n      } finally {\n        this.resetOnUnexpectedShutdown = shutdownHandler;\n      }\n    }\n    await super.reset();\n  }\n}\n\nObject.assign(XCUITestDriver.prototype, commands);\n\nexport default XCUITestDriver;\nexport { XCUITestDriver };\n"],"mappings":"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"}