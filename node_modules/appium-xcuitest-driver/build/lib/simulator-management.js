"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createSim = createSim;
exports.getExistingSim = getExistingSim;
exports.installToSimulator = installToSimulator;
exports.runSimulatorReset = runSimulatorReset;
exports.setLocale = setLocale;
exports.setLocaleAndPreferences = setLocaleAndPreferences;
exports.setPreferences = setPreferences;
exports.shutdownOtherSimulators = shutdownOtherSimulators;
exports.shutdownSimulator = shutdownSimulator;

require("source-map-support/register");

var _appiumIosSimulator = require("appium-ios-simulator");

var _nodeSimctl = _interopRequireDefault(require("node-simctl"));

var _appiumWebdriveragent = require("appium-webdriveragent");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _support = require("appium/support");

var _desiredCaps = require("./desired-caps");

const APPIUM_SIM_PREFIX = 'appiumTest';
const SETTINGS_CAPS = ['locationServicesEnabled', 'locationServicesAuthorized'];
const SAFARI_SETTINGS_CAPS = ['safariAllowPopups', 'safariIgnoreFraudWarning', 'safariOpenLinksInBackground'];

async function createSim(caps, platform = _desiredCaps.PLATFORM_NAME_IOS) {
  const devicesSetPath = caps.simulatorDevicesSetPath;
  const udid = await new _nodeSimctl.default({
    devicesSetPath
  }).createDevice(`${APPIUM_SIM_PREFIX}-${_support.util.uuidV4().toUpperCase()}-${caps.deviceName}`, caps.deviceName, caps.platformVersion, {
    platform
  });
  return await (0, _appiumIosSimulator.getSimulator)(udid, {
    platform,
    checkExistence: false,
    devicesSetPath
  });
}

async function getExistingSim(opts = {}) {
  const {
    platformVersion,
    deviceName,
    simulatorDevicesSetPath: devicesSetPath
  } = opts;
  let appiumTestDevice;
  const simctl = new _nodeSimctl.default({
    devicesSetPath
  });

  for (const device of _lodash.default.values(await simctl.getDevices(platformVersion))) {
    if (deviceName && device.name === deviceName || !deviceName) {
      return await (0, _appiumIosSimulator.getSimulator)(device.udid, {
        platform: device.platform,
        checkExistence: false,
        devicesSetPath
      });
    }

    if (device.name.startsWith(APPIUM_SIM_PREFIX) && (deviceName && device.name.endsWith(deviceName) || !deviceName)) {
      appiumTestDevice = device;

      if (device.state === 'Booted') {
        break;
      }
    }
  }

  if (appiumTestDevice) {
    _logger.default.warn(`Unable to find device '${deviceName}'. ` + `Found '${appiumTestDevice.name}' (udid: '${appiumTestDevice.udid}') instead`);

    return await (0, _appiumIosSimulator.getSimulator)(appiumTestDevice.udid, {
      platform: appiumTestDevice.platform,
      checkExistence: false,
      devicesSetPath
    });
  }

  return null;
}

async function shutdownSimulator(device) {
  await (0, _appiumWebdriveragent.resetTestProcesses)(device.udid, true);
  await device.shutdown();
}

async function runSimulatorReset(device, opts) {
  if (opts.noReset && !opts.fullReset) {
    _logger.default.debug('Reset: noReset is on. Leaving simulator as is');

    return;
  }

  if (!device) {
    _logger.default.debug('Reset: no device available. Skipping');

    return;
  }

  if (opts.fullReset) {
    _logger.default.debug('Reset: fullReset is on. Cleaning simulator');

    await shutdownSimulator(device);
    let isKeychainsBackupSuccessful = false;

    if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      isKeychainsBackupSuccessful = await device.backupKeychains();
    }

    await device.clean();

    if (isKeychainsBackupSuccessful) {
      await device.restoreKeychains(opts.keychainsExcludePatterns || []);

      _logger.default.info(`Successfully restored keychains after full reset`);
    } else if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      _logger.default.warn('Cannot restore keychains after full reset, because ' + 'the backup operation did not succeed');
    }
  } else if (opts.bundleId) {
    if (await device.isRunning()) {
      if (opts.enforceSimulatorShutdown) {
        await shutdownSimulator(device);
      } else {
        try {
          await device.simctl.terminateApp(opts.bundleId);
        } catch (err) {
          _logger.default.warn(`Reset: failed to terminate Simulator application with id "${opts.bundleId}"`);
        }
      }
    }

    if (opts.app) {
      _logger.default.info('Not scrubbing third party app in anticipation of uninstall');

      return;
    }

    const isSafari = (opts.browserName || '').toLowerCase() === 'safari';

    try {
      if (isSafari) {
        await device.cleanSafari();
      } else {
        await device.scrubCustomApp('', opts.bundleId);
      }
    } catch (err) {
      _logger.default.warn(err.message);

      _logger.default.warn(`Reset: could not scrub ${isSafari ? 'Safari browser' : 'application with id "' + opts.bundleId + '"'}. Leaving as is.`);
    }
  }
}

async function installToSimulator(device, app, bundleId, opts = {}) {
  if (!app) {
    _logger.default.debug('No app path is given. Nothing to install.');

    return;
  }

  const {
    noReset = true,
    newSimulator = false
  } = opts;

  if (!newSimulator && bundleId && (await device.isAppInstalled(bundleId))) {
    if (noReset) {
      _logger.default.debug(`App '${bundleId}' is already installed. No need to reinstall.`);

      return;
    }

    _logger.default.debug(`Reset requested. Removing app with id '${bundleId}' from the device`);

    await device.removeApp(bundleId);
  }

  _logger.default.debug(`Installing '${app}' on Simulator with UUID '${device.udid}'...`);

  try {
    await device.installApp(app);
  } catch (e) {
    _logger.default.info(`Got an error on '${app}' install: ${e.message}`);

    _logger.default.info('Retrying application install');

    await device.installApp(app);
  }

  _logger.default.debug('The app has been installed successfully.');
}

async function shutdownOtherSimulators(currentDevice) {
  const simctl = new _nodeSimctl.default({
    devicesSetPath: currentDevice.devicesSetPath
  });

  const allDevices = _lodash.default.flatMap(_lodash.default.values(await simctl.getDevices()));

  const otherBootedDevices = allDevices.filter(device => device.udid !== currentDevice.udid && device.state === 'Booted');

  if (_lodash.default.isEmpty(otherBootedDevices)) {
    _logger.default.info('No other running simulators have been detected');

    return;
  }

  _logger.default.info(`Detected ${otherBootedDevices.length} other running ${_support.util.pluralize('Simulator', otherBootedDevices.length)}.` + `Shutting them down...`);

  for (const {
    udid
  } of otherBootedDevices) {
    await (0, _appiumWebdriveragent.resetTestProcesses)(udid, true);
    simctl.udid = udid;
    await simctl.shutdownDevice();
  }
}

async function launchAndQuitSimulator(sim, opts = {}) {
  _logger.default.debug('No simulator directories found.');

  const {
    safari,
    timeout
  } = opts;
  return timeout ? await sim.launchAndQuit(safari, timeout) : await sim.launchAndQuit(safari);
}

function checkPreferences(settings, opts = {}) {
  for (let setting of settings) {
    if (_lodash.default.has(opts, setting)) {
      return true;
    }
  }

  return false;
}

async function setLocaleAndPreferences(sim, opts, safari = false, shutdownFn = _lodash.default.noop) {
  const localConfig = await setLocale(sim, opts, {}, safari);
  const prefsUpdated = await setPreferences(sim, opts, safari);

  if (localConfig._updated || prefsUpdated) {
    _logger.default.debug('Updated settings. Rebooting the simulator if it is already open');

    await shutdownFn(sim);
  } else {
    _logger.default.debug('Setting did not need to be updated');
  }

  delete localConfig._updated;
  return localConfig;
}

async function setLocale(sim, opts, localeConfig = {}, safari = false) {
  if (!opts.language && !opts.locale && !opts.calendarFormat) {
    _logger.default.debug('No reason to set locale');

    return {
      _updated: false
    };
  }

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, {
      safari,
      timeout: opts.simulatorStartupTimeout
    });
  }

  _logger.default.debug('Setting locale information');

  localeConfig = {
    language: opts.language || localeConfig.language,
    locale: opts.locale || localeConfig.locale,
    calendarFormat: opts.calendarFormat || localeConfig.calendarFormat,
    _updated: false
  };

  try {
    let updated = await sim.updateLocale(opts.language, opts.locale, opts.calendarFormat);

    if (updated) {
      localeConfig._updated = true;
    }
  } catch (e) {
    _logger.default.errorAndThrow(`Appium was unable to set locale info: ${e}`);
  }

  return localeConfig;
}

async function setPreferences(sim, opts, safari = false) {
  let needToSetPrefs = checkPreferences(SETTINGS_CAPS, opts);
  let needToSetSafariPrefs = checkPreferences(SAFARI_SETTINGS_CAPS, opts);

  if (!needToSetPrefs && !needToSetSafariPrefs) {
    _logger.default.debug('No iOS / app preferences to set');

    return false;
  }

  _logger.default.debug('Setting iOS and app preferences');

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, {
      safari,
      timeout: opts.simulatorStartupTimeout
    });
  }

  let updated = false;

  try {
    if (needToSetPrefs) {
      updated = await setLocServicesPrefs(sim, opts);
    }
  } catch (e) {
    _logger.default.error('Error setting location services preferences, prefs will not work');

    _logger.default.error(e);
  }

  try {
    if (needToSetSafariPrefs) {
      updated = (await setSafariPrefs(sim, opts)) || updated;
    }
  } catch (e) {
    _logger.default.error('Error setting safari preferences, prefs will not work');

    _logger.default.error(e);
  }

  return updated;
}

async function setLocServicesPrefs(sim, opts = {}) {
  let locServ = _lodash.default.find([opts.locationServicesEnabled, opts.locationServicesAuthorized], c => !_lodash.default.isUndefined(c));

  if (!_lodash.default.isUndefined(locServ)) {
    locServ = locServ ? 1 : 0;

    _logger.default.debug(`Setting location services to ${locServ}`);

    await sim.updateSettings('locationServices', {
      LocationServicesEnabled: locServ,
      'LocationServicesEnabledIn7.0': locServ,
      'LocationServicesEnabledIn8.0': locServ
    });
  }

  if (!_lodash.default.isUndefined(opts.locationServicesAuthorized)) {
    if (!opts.bundleId) {
      let msg = "Can't set location services for app without bundle ID";

      _logger.default.errorAndThrow(msg);
    }

    let locAuth = !!opts.locationServicesAuthorized;

    if (locAuth) {
      _logger.default.debug('Authorizing location services for app');
    } else {
      _logger.default.debug('De-authorizing location services for app');
    }

    await sim.updateLocationSettings(opts.bundleId, locAuth);
  }
}

async function setSafariPrefs(sim, opts = {}) {
  let safariSettings = {};

  if (_lodash.default.has(opts, 'safariAllowPopups')) {
    const val = !!opts.safariAllowPopups;

    _logger.default.debug(`Setting javascript window opening to '${val}'`);

    safariSettings.WebKitJavaScriptCanOpenWindowsAutomatically = val;
    safariSettings.JavaScriptCanOpenWindowsAutomatically = val;
  }

  if (_lodash.default.has(opts, 'safariIgnoreFraudWarning')) {
    const val = !opts.safariIgnoreFraudWarning;

    _logger.default.debug(`Setting fraudulent website warning to '${val}'`);

    safariSettings.WarnAboutFraudulentWebsites = val;
  }

  if (_lodash.default.has(opts, 'safariOpenLinksInBackground')) {
    const val = opts.safariOpenLinksInBackground ? 1 : 0;

    _logger.default.debug(`Setting opening links in background to '${!!val}'`);

    safariSettings.OpenLinksInBackground = val;
  }

  return _lodash.default.size(safariSettings) > 0 ? await sim.updateSafariSettings(safariSettings) : false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBUFBJVU1fU0lNX1BSRUZJWCIsIlNFVFRJTkdTX0NBUFMiLCJTQUZBUklfU0VUVElOR1NfQ0FQUyIsImNyZWF0ZVNpbSIsImNhcHMiLCJwbGF0Zm9ybSIsIlBMQVRGT1JNX05BTUVfSU9TIiwiZGV2aWNlc1NldFBhdGgiLCJzaW11bGF0b3JEZXZpY2VzU2V0UGF0aCIsInVkaWQiLCJTaW1jdGwiLCJjcmVhdGVEZXZpY2UiLCJ1dGlsIiwidXVpZFY0IiwidG9VcHBlckNhc2UiLCJkZXZpY2VOYW1lIiwicGxhdGZvcm1WZXJzaW9uIiwiZ2V0U2ltdWxhdG9yIiwiY2hlY2tFeGlzdGVuY2UiLCJnZXRFeGlzdGluZ1NpbSIsIm9wdHMiLCJhcHBpdW1UZXN0RGV2aWNlIiwic2ltY3RsIiwiZGV2aWNlIiwiXyIsInZhbHVlcyIsImdldERldmljZXMiLCJuYW1lIiwic3RhcnRzV2l0aCIsImVuZHNXaXRoIiwic3RhdGUiLCJsb2ciLCJ3YXJuIiwic2h1dGRvd25TaW11bGF0b3IiLCJyZXNldFRlc3RQcm9jZXNzZXMiLCJzaHV0ZG93biIsInJ1blNpbXVsYXRvclJlc2V0Iiwibm9SZXNldCIsImZ1bGxSZXNldCIsImRlYnVnIiwiaXNLZXljaGFpbnNCYWNrdXBTdWNjZXNzZnVsIiwia2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIiwia2VlcEtleUNoYWlucyIsImJhY2t1cEtleWNoYWlucyIsImNsZWFuIiwicmVzdG9yZUtleWNoYWlucyIsImluZm8iLCJidW5kbGVJZCIsImlzUnVubmluZyIsImVuZm9yY2VTaW11bGF0b3JTaHV0ZG93biIsInRlcm1pbmF0ZUFwcCIsImVyciIsImFwcCIsImlzU2FmYXJpIiwiYnJvd3Nlck5hbWUiLCJ0b0xvd2VyQ2FzZSIsImNsZWFuU2FmYXJpIiwic2NydWJDdXN0b21BcHAiLCJtZXNzYWdlIiwiaW5zdGFsbFRvU2ltdWxhdG9yIiwibmV3U2ltdWxhdG9yIiwiaXNBcHBJbnN0YWxsZWQiLCJyZW1vdmVBcHAiLCJpbnN0YWxsQXBwIiwiZSIsInNodXRkb3duT3RoZXJTaW11bGF0b3JzIiwiY3VycmVudERldmljZSIsImFsbERldmljZXMiLCJmbGF0TWFwIiwib3RoZXJCb290ZWREZXZpY2VzIiwiZmlsdGVyIiwiaXNFbXB0eSIsImxlbmd0aCIsInBsdXJhbGl6ZSIsInNodXRkb3duRGV2aWNlIiwibGF1bmNoQW5kUXVpdFNpbXVsYXRvciIsInNpbSIsInNhZmFyaSIsInRpbWVvdXQiLCJsYXVuY2hBbmRRdWl0IiwiY2hlY2tQcmVmZXJlbmNlcyIsInNldHRpbmdzIiwic2V0dGluZyIsImhhcyIsInNldExvY2FsZUFuZFByZWZlcmVuY2VzIiwic2h1dGRvd25GbiIsIm5vb3AiLCJsb2NhbENvbmZpZyIsInNldExvY2FsZSIsInByZWZzVXBkYXRlZCIsInNldFByZWZlcmVuY2VzIiwiX3VwZGF0ZWQiLCJsb2NhbGVDb25maWciLCJsYW5ndWFnZSIsImxvY2FsZSIsImNhbGVuZGFyRm9ybWF0IiwiaXNGcmVzaCIsInNpbXVsYXRvclN0YXJ0dXBUaW1lb3V0IiwidXBkYXRlZCIsInVwZGF0ZUxvY2FsZSIsImVycm9yQW5kVGhyb3ciLCJuZWVkVG9TZXRQcmVmcyIsIm5lZWRUb1NldFNhZmFyaVByZWZzIiwic2V0TG9jU2VydmljZXNQcmVmcyIsImVycm9yIiwic2V0U2FmYXJpUHJlZnMiLCJsb2NTZXJ2IiwiZmluZCIsImxvY2F0aW9uU2VydmljZXNFbmFibGVkIiwibG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQiLCJjIiwiaXNVbmRlZmluZWQiLCJ1cGRhdGVTZXR0aW5ncyIsIkxvY2F0aW9uU2VydmljZXNFbmFibGVkIiwibXNnIiwibG9jQXV0aCIsInVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MiLCJzYWZhcmlTZXR0aW5ncyIsInZhbCIsInNhZmFyaUFsbG93UG9wdXBzIiwiV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSIsIkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkiLCJzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmciLCJXYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMiLCJzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQiLCJPcGVuTGlua3NJbkJhY2tncm91bmQiLCJzaXplIiwidXBkYXRlU2FmYXJpU2V0dGluZ3MiXSwic291cmNlcyI6WyIuLi8uLi9saWIvc2ltdWxhdG9yLW1hbmFnZW1lbnQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0U2ltdWxhdG9yIH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IFNpbWN0bCBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyByZXNldFRlc3RQcm9jZXNzZXMgfSBmcm9tICdhcHBpdW0td2ViZHJpdmVyYWdlbnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IFBMQVRGT1JNX05BTUVfSU9TIH0gZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuXG5cbmNvbnN0IEFQUElVTV9TSU1fUFJFRklYID0gJ2FwcGl1bVRlc3QnO1xuY29uc3QgU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ2xvY2F0aW9uU2VydmljZXNFbmFibGVkJyxcbiAgJ2xvY2F0aW9uU2VydmljZXNBdXRob3JpemVkJyxcbl07XG5jb25zdCBTQUZBUklfU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ3NhZmFyaUFsbG93UG9wdXBzJyxcbiAgJ3NhZmFyaUlnbm9yZUZyYXVkV2FybmluZycsXG4gICdzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQnLFxuXTtcblxuLyoqXG4gKiBDYXBhYmlsaXR5IHNldCBieSBhIHVzZXJcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gZGV2aWNlTmFtZSAtIEEgbmFtZSBmb3IgdGhlIGRldmljZVxuICogQHByb3BlcnR5IHtzdHJpbmd9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSB2ZXJzaW9uIG9mIGlPUyB0byB1c2VcbiAqL1xuLyoqXG4gKiBDcmVhdGUgYSBuZXcgc2ltdWxhdG9yIHdpdGggYGFwcGl1bVRlc3QtYCBwcmVmaXggYW5kIHJldHVybiB0aGUgb2JqZWN0LlxuICpcbiAqIEBwYXJhbSB7b2JqZWN0fSBTaW1DcmVhdGlvbkNhcHMgLSBDYXBhYmlsaXR5IHNldCBieSBhIHVzZXIuIFRoZSBvcHRpb25zIGF2YWlsYWJsZSBhcmU6XG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGxhdGZvcm0gW2lPU10gLSBQbGF0Zm9ybSBuYW1lIGluIG9yZGVyIHRvIHNwZWNpZnkgcnVudGltZSBzdWNoIGFzICdpT1MnLCAndHZPUycsICd3YXRjaE9TJ1xuICogQHJldHVybnMge29iamVjdH0gU2ltdWxhdG9yIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhlIHVkaWQgcGFzc2VkIGluLlxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVTaW0gKGNhcHMsIHBsYXRmb3JtID0gUExBVEZPUk1fTkFNRV9JT1MpIHtcbiAgY29uc3QgZGV2aWNlc1NldFBhdGggPSBjYXBzLnNpbXVsYXRvckRldmljZXNTZXRQYXRoO1xuICBjb25zdCB1ZGlkID0gYXdhaXQgbmV3IFNpbWN0bCh7ZGV2aWNlc1NldFBhdGh9KS5jcmVhdGVEZXZpY2UoXG4gICAgYCR7QVBQSVVNX1NJTV9QUkVGSVh9LSR7dXRpbC51dWlkVjQoKS50b1VwcGVyQ2FzZSgpfS0ke2NhcHMuZGV2aWNlTmFtZX1gLFxuICAgIGNhcHMuZGV2aWNlTmFtZSxcbiAgICBjYXBzLnBsYXRmb3JtVmVyc2lvbixcbiAgICB7cGxhdGZvcm19LFxuICApO1xuICByZXR1cm4gYXdhaXQgZ2V0U2ltdWxhdG9yKHVkaWQsIHtcbiAgICBwbGF0Zm9ybSxcbiAgICBjaGVja0V4aXN0ZW5jZTogZmFsc2UsXG4gICAgZGV2aWNlc1NldFBhdGgsXG4gIH0pO1xufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFNpbXVsYXRvckxvb2t1cE9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nP30gZGV2aWNlTmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBkZXZpY2UgdG8gbG9va3VwXG4gKiBAcHJvcGVydHkge3N0cmluZyF9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSBwbGF0Zm9ybSB2ZXJzaW9uIHN0cmluZ1xuICogQHByb3BlcnR5IHtzdHJpbmc/fSBzaW11bGF0b3JEZXZpY2VzU2V0UGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIHNpbXVsYXRvciBkZXZpY2VzIHNldFxuICovXG5cbi8qKlxuICogR2V0IGEgc2ltdWxhdG9yIHdoaWNoIGlzIGFscmVhZHkgcnVubmluZy5cbiAqXG4gKiBAcGFyYW0ge1NpbXVsYXRvckxvb2t1cE9wdGlvbnM/fSBvcHRzXG4gKiBAcmV0dXJucyB7U2ltdWxhdG9yP30gVGhlIG1hdGNoZWQgU2ltdWxhdG9yIGluc3RhbmNlIG9yIGBudWxsYCBpZiBubyBtYXRjaGluZyAgZGV2aWNlIGlzIGZvdW5kLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRFeGlzdGluZ1NpbSAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBwbGF0Zm9ybVZlcnNpb24sXG4gICAgZGV2aWNlTmFtZSxcbiAgICBzaW11bGF0b3JEZXZpY2VzU2V0UGF0aDogZGV2aWNlc1NldFBhdGgsXG4gIH0gPSBvcHRzO1xuXG4gIGxldCBhcHBpdW1UZXN0RGV2aWNlO1xuICBjb25zdCBzaW1jdGwgPSBuZXcgU2ltY3RsKHtkZXZpY2VzU2V0UGF0aH0pO1xuICBmb3IgKGNvbnN0IGRldmljZSBvZiBfLnZhbHVlcyhhd2FpdCBzaW1jdGwuZ2V0RGV2aWNlcyhwbGF0Zm9ybVZlcnNpb24pKSkge1xuICAgIGlmICgoZGV2aWNlTmFtZSAmJiBkZXZpY2UubmFtZSA9PT0gZGV2aWNlTmFtZSkgfHwgIWRldmljZU5hbWUpIHtcbiAgICAgIHJldHVybiBhd2FpdCBnZXRTaW11bGF0b3IoZGV2aWNlLnVkaWQsIHtcbiAgICAgICAgcGxhdGZvcm06IGRldmljZS5wbGF0Zm9ybSxcbiAgICAgICAgY2hlY2tFeGlzdGVuY2U6IGZhbHNlLFxuICAgICAgICBkZXZpY2VzU2V0UGF0aCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChkZXZpY2UubmFtZS5zdGFydHNXaXRoKEFQUElVTV9TSU1fUFJFRklYKVxuICAgICAgJiYgKChkZXZpY2VOYW1lICYmIGRldmljZS5uYW1lLmVuZHNXaXRoKGRldmljZU5hbWUpKSB8fCAhZGV2aWNlTmFtZSkpIHtcbiAgICAgIGFwcGl1bVRlc3REZXZpY2UgPSBkZXZpY2U7XG4gICAgICAvLyBjaG9vc2UgdGhlIGZpcnN0IGJvb3RlZCBzaW11bGF0b3JcbiAgICAgIGlmIChkZXZpY2Uuc3RhdGUgPT09ICdCb290ZWQnKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChhcHBpdW1UZXN0RGV2aWNlKSB7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byBmaW5kIGRldmljZSAnJHtkZXZpY2VOYW1lfScuIGAgK1xuICAgICAgYEZvdW5kICcke2FwcGl1bVRlc3REZXZpY2UubmFtZX0nICh1ZGlkOiAnJHthcHBpdW1UZXN0RGV2aWNlLnVkaWR9JykgaW5zdGVhZGApO1xuICAgIHJldHVybiBhd2FpdCBnZXRTaW11bGF0b3IoYXBwaXVtVGVzdERldmljZS51ZGlkLCB7XG4gICAgICBwbGF0Zm9ybTogYXBwaXVtVGVzdERldmljZS5wbGF0Zm9ybSxcbiAgICAgIGNoZWNrRXhpc3RlbmNlOiBmYWxzZSxcbiAgICAgIGRldmljZXNTZXRQYXRoLFxuICAgIH0pO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaHV0ZG93blNpbXVsYXRvciAoZGV2aWNlKSB7XG4gIC8vIHN0b3AgWENUZXN0IHByb2Nlc3NlcyBpZiBydW5uaW5nIHRvIGF2b2lkIHVuZXhwZWN0ZWQgc2lkZSBlZmZlY3RzXG4gIGF3YWl0IHJlc2V0VGVzdFByb2Nlc3NlcyhkZXZpY2UudWRpZCwgdHJ1ZSk7XG4gIGF3YWl0IGRldmljZS5zaHV0ZG93bigpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW5TaW11bGF0b3JSZXNldCAoZGV2aWNlLCBvcHRzKSB7XG4gIGlmIChvcHRzLm5vUmVzZXQgJiYgIW9wdHMuZnVsbFJlc2V0KSB7XG4gICAgLy8gbm9SZXNldCA9PT0gdHJ1ZSAmJiBmdWxsUmVzZXQgPT09IGZhbHNlXG4gICAgbG9nLmRlYnVnKCdSZXNldDogbm9SZXNldCBpcyBvbi4gTGVhdmluZyBzaW11bGF0b3IgYXMgaXMnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoIWRldmljZSkge1xuICAgIGxvZy5kZWJ1ZygnUmVzZXQ6IG5vIGRldmljZSBhdmFpbGFibGUuIFNraXBwaW5nJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKG9wdHMuZnVsbFJlc2V0KSB7XG4gICAgbG9nLmRlYnVnKCdSZXNldDogZnVsbFJlc2V0IGlzIG9uLiBDbGVhbmluZyBzaW11bGF0b3InKTtcbiAgICBhd2FpdCBzaHV0ZG93blNpbXVsYXRvcihkZXZpY2UpO1xuICAgIGxldCBpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwgPSBmYWxzZTtcbiAgICBpZiAob3B0cy5rZXljaGFpbnNFeGNsdWRlUGF0dGVybnMgfHwgb3B0cy5rZWVwS2V5Q2hhaW5zKSB7XG4gICAgICBpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwgPSBhd2FpdCBkZXZpY2UuYmFja3VwS2V5Y2hhaW5zKCk7XG4gICAgfVxuICAgIGF3YWl0IGRldmljZS5jbGVhbigpO1xuICAgIGlmIChpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwpIHtcbiAgICAgIGF3YWl0IGRldmljZS5yZXN0b3JlS2V5Y2hhaW5zKG9wdHMua2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIHx8IFtdKTtcbiAgICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgcmVzdG9yZWQga2V5Y2hhaW5zIGFmdGVyIGZ1bGwgcmVzZXRgKTtcbiAgICB9IGVsc2UgaWYgKG9wdHMua2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIHx8IG9wdHMua2VlcEtleUNoYWlucykge1xuICAgICAgbG9nLndhcm4oJ0Nhbm5vdCByZXN0b3JlIGtleWNoYWlucyBhZnRlciBmdWxsIHJlc2V0LCBiZWNhdXNlICcgK1xuICAgICAgICAgICAgICAgJ3RoZSBiYWNrdXAgb3BlcmF0aW9uIGRpZCBub3Qgc3VjY2VlZCcpO1xuICAgIH1cbiAgfSBlbHNlIGlmIChvcHRzLmJ1bmRsZUlkKSB7XG4gICAgLy8gZmFzdFJlc2V0IG9yIG5vUmVzZXRcblxuICAgIC8vIFRlcm1pbmF0ZSB0aGUgYXBwIHVuZGVyIHRlc3QgaWYgaXQgaXMgc3RpbGwgcnVubmluZyBvbiBTaW11bGF0b3JcbiAgICAvLyBUZXJtaW5hdGlvbiBpcyBub3QgbmVlZGVkIGlmIFNpbXVsYXRvciBpcyBub3QgcnVubmluZ1xuICAgIGlmIChhd2FpdCBkZXZpY2UuaXNSdW5uaW5nKCkpIHtcbiAgICAgIGlmIChvcHRzLmVuZm9yY2VTaW11bGF0b3JTaHV0ZG93bikge1xuICAgICAgICBhd2FpdCBzaHV0ZG93blNpbXVsYXRvcihkZXZpY2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBkZXZpY2Uuc2ltY3RsLnRlcm1pbmF0ZUFwcChvcHRzLmJ1bmRsZUlkKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLndhcm4oYFJlc2V0OiBmYWlsZWQgdG8gdGVybWluYXRlIFNpbXVsYXRvciBhcHBsaWNhdGlvbiB3aXRoIGlkIFwiJHtvcHRzLmJ1bmRsZUlkfVwiYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG9wdHMuYXBwKSB7XG4gICAgICBsb2cuaW5mbygnTm90IHNjcnViYmluZyB0aGlyZCBwYXJ0eSBhcHAgaW4gYW50aWNpcGF0aW9uIG9mIHVuaW5zdGFsbCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBpc1NhZmFyaSA9IChvcHRzLmJyb3dzZXJOYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpID09PSAnc2FmYXJpJztcbiAgICB0cnkge1xuICAgICAgaWYgKGlzU2FmYXJpKSB7XG4gICAgICAgIGF3YWl0IGRldmljZS5jbGVhblNhZmFyaSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gaU9TIDgrIGRvZXMgbm90IG5lZWQgYmFzZW5hbWVcbiAgICAgICAgYXdhaXQgZGV2aWNlLnNjcnViQ3VzdG9tQXBwKCcnLCBvcHRzLmJ1bmRsZUlkKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGVyci5tZXNzYWdlKTtcbiAgICAgIGxvZy53YXJuKGBSZXNldDogY291bGQgbm90IHNjcnViICR7aXNTYWZhcmkgPyAnU2FmYXJpIGJyb3dzZXInIDogJ2FwcGxpY2F0aW9uIHdpdGggaWQgXCInICsgb3B0cy5idW5kbGVJZCArICdcIid9LiBMZWF2aW5nIGFzIGlzLmApO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEluc3RhbGxPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gbm9SZXNldCBbZmFsc2VdIFdoZXRoZXIgdG8gZGlzYWJsZSByZXNldFxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gbmV3U2ltdWxhdG9yIFtmYWxzZV0gV2hldGhlciB0aGUgc2ltdWxhdG9yIGlzIGJyYW5kIG5ld1xuICovXG5cbi8qKlxuICogQHBhcmFtIHtvYmplY3R9IGRldmljZSBUaGUgc2ltdWxhdG9yIGRldmljZSBvYmplY3RcbiAqIEBwYXJhbSB7P3N0cmluZ30gYXBwIFRoZSBhcHAgdG8gdGhlIHBhdGhcbiAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVJZCBUaGUgYnVuZGxlIGlkIHRvIGVuc3VyZSBpdCBpcyBhbHJlYWR5IGluc3RhbGxlZCBhbmQgdW5pbnN0YWxsIGl0XG4gKiBAcGFyYW0gez9JbnN0YWxsT3B0aW9uc30gb3B0c1xuICovXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsVG9TaW11bGF0b3IgKGRldmljZSwgYXBwLCBidW5kbGVJZCwgb3B0cyA9IHt9KSB7XG4gIGlmICghYXBwKSB7XG4gICAgbG9nLmRlYnVnKCdObyBhcHAgcGF0aCBpcyBnaXZlbi4gTm90aGluZyB0byBpbnN0YWxsLicpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICBub1Jlc2V0ID0gdHJ1ZSxcbiAgICBuZXdTaW11bGF0b3IgPSBmYWxzZSxcbiAgfSA9IG9wdHM7XG5cbiAgaWYgKCFuZXdTaW11bGF0b3IgJiYgYnVuZGxlSWQgJiYgYXdhaXQgZGV2aWNlLmlzQXBwSW5zdGFsbGVkKGJ1bmRsZUlkKSkge1xuICAgIGlmIChub1Jlc2V0KSB7XG4gICAgICBsb2cuZGVidWcoYEFwcCAnJHtidW5kbGVJZH0nIGlzIGFscmVhZHkgaW5zdGFsbGVkLiBObyBuZWVkIHRvIHJlaW5zdGFsbC5gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBSZXNldCByZXF1ZXN0ZWQuIFJlbW92aW5nIGFwcCB3aXRoIGlkICcke2J1bmRsZUlkfScgZnJvbSB0aGUgZGV2aWNlYCk7XG4gICAgYXdhaXQgZGV2aWNlLnJlbW92ZUFwcChidW5kbGVJZCk7XG4gIH1cblxuICBsb2cuZGVidWcoYEluc3RhbGxpbmcgJyR7YXBwfScgb24gU2ltdWxhdG9yIHdpdGggVVVJRCAnJHtkZXZpY2UudWRpZH0nLi4uYCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZGV2aWNlLmluc3RhbGxBcHAoYXBwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIGl0IHNvbWV0aW1lcyBmYWlscyBvbiBYY29kZSAxMCBiZWNhdXNlIG9mIGEgcmFjZSBjb25kaXRpb25cbiAgICBsb2cuaW5mbyhgR290IGFuIGVycm9yIG9uICcke2FwcH0nIGluc3RhbGw6ICR7ZS5tZXNzYWdlfWApO1xuICAgIGxvZy5pbmZvKCdSZXRyeWluZyBhcHBsaWNhdGlvbiBpbnN0YWxsJyk7XG4gICAgYXdhaXQgZGV2aWNlLmluc3RhbGxBcHAoYXBwKTtcbiAgfVxuICBsb2cuZGVidWcoJ1RoZSBhcHAgaGFzIGJlZW4gaW5zdGFsbGVkIHN1Y2Nlc3NmdWxseS4nKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2h1dGRvd25PdGhlclNpbXVsYXRvcnMgKGN1cnJlbnREZXZpY2UpIHtcbiAgY29uc3Qgc2ltY3RsID0gbmV3IFNpbWN0bCh7XG4gICAgZGV2aWNlc1NldFBhdGg6IGN1cnJlbnREZXZpY2UuZGV2aWNlc1NldFBhdGhcbiAgfSk7XG4gIGNvbnN0IGFsbERldmljZXMgPSBfLmZsYXRNYXAoXy52YWx1ZXMoYXdhaXQgc2ltY3RsLmdldERldmljZXMoKSkpO1xuICBjb25zdCBvdGhlckJvb3RlZERldmljZXMgPSBhbGxEZXZpY2VzLmZpbHRlcigoZGV2aWNlKSA9PiBkZXZpY2UudWRpZCAhPT0gY3VycmVudERldmljZS51ZGlkICYmIGRldmljZS5zdGF0ZSA9PT0gJ0Jvb3RlZCcpO1xuICBpZiAoXy5pc0VtcHR5KG90aGVyQm9vdGVkRGV2aWNlcykpIHtcbiAgICBsb2cuaW5mbygnTm8gb3RoZXIgcnVubmluZyBzaW11bGF0b3JzIGhhdmUgYmVlbiBkZXRlY3RlZCcpO1xuICAgIHJldHVybjtcbiAgfVxuICBsb2cuaW5mbyhgRGV0ZWN0ZWQgJHtvdGhlckJvb3RlZERldmljZXMubGVuZ3RofSBvdGhlciBydW5uaW5nICR7dXRpbC5wbHVyYWxpemUoJ1NpbXVsYXRvcicsIG90aGVyQm9vdGVkRGV2aWNlcy5sZW5ndGgpfS5gICtcbiAgICBgU2h1dHRpbmcgdGhlbSBkb3duLi4uYCk7XG4gIGZvciAoY29uc3Qge3VkaWR9IG9mIG90aGVyQm9vdGVkRGV2aWNlcykge1xuICAgIC8vIEl0IGlzIG5lY2Vzc2FyeSB0byBzdG9wIHRoZSBjb3JyZXNwb25kaW5nIHhjb2RlYnVpbGQgcHJvY2VzcyBiZWZvcmUga2lsbGluZ1xuICAgIC8vIHRoZSBzaW11bGF0b3IsIG90aGVyd2lzZSBpdCB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgcmVzdGFydGVkXG4gICAgYXdhaXQgcmVzZXRUZXN0UHJvY2Vzc2VzKHVkaWQsIHRydWUpO1xuICAgIHNpbWN0bC51ZGlkID0gdWRpZDtcbiAgICBhd2FpdCBzaW1jdGwuc2h1dGRvd25EZXZpY2UoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yIChzaW0sIG9wdHMgPSB7fSkge1xuICBsb2cuZGVidWcoJ05vIHNpbXVsYXRvciBkaXJlY3RvcmllcyBmb3VuZC4nKTtcbiAgY29uc3QgeyBzYWZhcmksIHRpbWVvdXQgfSA9IG9wdHM7XG4gIHJldHVybiB0aW1lb3V0XG4gICAgPyBhd2FpdCBzaW0ubGF1bmNoQW5kUXVpdChzYWZhcmksIHRpbWVvdXQpXG4gICAgOiBhd2FpdCBzaW0ubGF1bmNoQW5kUXVpdChzYWZhcmkpO1xufVxuXG5mdW5jdGlvbiBjaGVja1ByZWZlcmVuY2VzIChzZXR0aW5ncywgb3B0cyA9IHt9KSB7XG4gIGZvciAobGV0IHNldHRpbmcgb2Ygc2V0dGluZ3MpIHtcbiAgICBpZiAoXy5oYXMob3B0cywgc2V0dGluZykpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldExvY2FsZUFuZFByZWZlcmVuY2VzIChzaW0sIG9wdHMsIHNhZmFyaSA9IGZhbHNlLCBzaHV0ZG93bkZuID0gXy5ub29wKSB7XG4gIGNvbnN0IGxvY2FsQ29uZmlnID0gYXdhaXQgc2V0TG9jYWxlKHNpbSwgb3B0cywge30sIHNhZmFyaSk7XG4gIGNvbnN0IHByZWZzVXBkYXRlZCA9IGF3YWl0IHNldFByZWZlcmVuY2VzKHNpbSwgb3B0cywgc2FmYXJpKTtcbiAgaWYgKGxvY2FsQ29uZmlnLl91cGRhdGVkIHx8IHByZWZzVXBkYXRlZCkge1xuICAgIGxvZy5kZWJ1ZygnVXBkYXRlZCBzZXR0aW5ncy4gUmVib290aW5nIHRoZSBzaW11bGF0b3IgaWYgaXQgaXMgYWxyZWFkeSBvcGVuJyk7XG4gICAgYXdhaXQgc2h1dGRvd25GbihzaW0pO1xuICB9IGVsc2Uge1xuICAgIGxvZy5kZWJ1ZygnU2V0dGluZyBkaWQgbm90IG5lZWQgdG8gYmUgdXBkYXRlZCcpO1xuICB9XG4gIGRlbGV0ZSBsb2NhbENvbmZpZy5fdXBkYXRlZDtcbiAgcmV0dXJuIGxvY2FsQ29uZmlnO1xufVxuXG4vLyBwYXNzIGluIHRoZSBzaW11bGF0b3Igc28gdGhhdCBvdGhlciBzeXN0ZW1zIHRoYXQgdXNlIHRoZSBmdW5jdGlvbiBjYW4gc3VwcGx5XG4vLyB3aGF0ZXZlciB0aGV5IGhhdmVcbmFzeW5jIGZ1bmN0aW9uIHNldExvY2FsZSAoc2ltLCBvcHRzLCBsb2NhbGVDb25maWcgPSB7fSwgc2FmYXJpID0gZmFsc2UpIHtcbiAgaWYgKCFvcHRzLmxhbmd1YWdlICYmICFvcHRzLmxvY2FsZSAmJiAhb3B0cy5jYWxlbmRhckZvcm1hdCkge1xuICAgIGxvZy5kZWJ1ZygnTm8gcmVhc29uIHRvIHNldCBsb2NhbGUnKTtcbiAgICByZXR1cm4ge1xuICAgICAgX3VwZGF0ZWQ6IGZhbHNlLFxuICAgIH07XG4gIH1cblxuICAvLyB3ZSBuZWVkIHRoZSBzaW11bGF0b3IgdG8gaGF2ZSBpdHMgZGlyZWN0b3JpZXMgaW4gcGxhY2VcbiAgaWYgKGF3YWl0IHNpbS5pc0ZyZXNoKCkpIHtcbiAgICBhd2FpdCBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yKHNpbSwge1xuICAgICAgc2FmYXJpLFxuICAgICAgdGltZW91dDogb3B0cy5zaW11bGF0b3JTdGFydHVwVGltZW91dCxcbiAgICB9KTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygnU2V0dGluZyBsb2NhbGUgaW5mb3JtYXRpb24nKTtcbiAgbG9jYWxlQ29uZmlnID0ge1xuICAgIGxhbmd1YWdlOiBvcHRzLmxhbmd1YWdlIHx8IGxvY2FsZUNvbmZpZy5sYW5ndWFnZSxcbiAgICBsb2NhbGU6IG9wdHMubG9jYWxlIHx8IGxvY2FsZUNvbmZpZy5sb2NhbGUsXG4gICAgY2FsZW5kYXJGb3JtYXQ6IG9wdHMuY2FsZW5kYXJGb3JtYXQgfHwgbG9jYWxlQ29uZmlnLmNhbGVuZGFyRm9ybWF0LFxuICAgIF91cGRhdGVkOiBmYWxzZSxcbiAgfTtcblxuICB0cnkge1xuICAgIGxldCB1cGRhdGVkID0gYXdhaXQgc2ltLnVwZGF0ZUxvY2FsZShvcHRzLmxhbmd1YWdlLCBvcHRzLmxvY2FsZSwgb3B0cy5jYWxlbmRhckZvcm1hdCk7XG4gICAgaWYgKHVwZGF0ZWQpIHtcbiAgICAgIGxvY2FsZUNvbmZpZy5fdXBkYXRlZCA9IHRydWU7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEFwcGl1bSB3YXMgdW5hYmxlIHRvIHNldCBsb2NhbGUgaW5mbzogJHtlfWApO1xuICB9XG5cbiAgcmV0dXJuIGxvY2FsZUNvbmZpZztcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0UHJlZmVyZW5jZXMgKHNpbSwgb3B0cywgc2FmYXJpID0gZmFsc2UpIHtcbiAgbGV0IG5lZWRUb1NldFByZWZzID0gY2hlY2tQcmVmZXJlbmNlcyhTRVRUSU5HU19DQVBTLCBvcHRzKTtcbiAgbGV0IG5lZWRUb1NldFNhZmFyaVByZWZzID0gY2hlY2tQcmVmZXJlbmNlcyhTQUZBUklfU0VUVElOR1NfQ0FQUywgb3B0cyk7XG4gIGlmICghbmVlZFRvU2V0UHJlZnMgJiYgIW5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgbG9nLmRlYnVnKCdObyBpT1MgLyBhcHAgcHJlZmVyZW5jZXMgdG8gc2V0Jyk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbG9nLmRlYnVnKCdTZXR0aW5nIGlPUyBhbmQgYXBwIHByZWZlcmVuY2VzJyk7XG5cbiAgaWYgKGF3YWl0IHNpbS5pc0ZyZXNoKCkpIHtcbiAgICBhd2FpdCBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yKHNpbSwge1xuICAgICAgc2FmYXJpLFxuICAgICAgdGltZW91dDogb3B0cy5zaW11bGF0b3JTdGFydHVwVGltZW91dCxcbiAgICB9KTtcbiAgfVxuXG4gIGxldCB1cGRhdGVkID0gZmFsc2U7XG4gIHRyeSB7XG4gICAgaWYgKG5lZWRUb1NldFByZWZzKSB7XG4gICAgICB1cGRhdGVkID0gYXdhaXQgc2V0TG9jU2VydmljZXNQcmVmcyhzaW0sIG9wdHMpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvcignRXJyb3Igc2V0dGluZyBsb2NhdGlvbiBzZXJ2aWNlcyBwcmVmZXJlbmNlcywgcHJlZnMgd2lsbCBub3Qgd29yaycpO1xuICAgIGxvZy5lcnJvcihlKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgaWYgKG5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgICB1cGRhdGVkID0gYXdhaXQgc2V0U2FmYXJpUHJlZnMoc2ltLCBvcHRzKSB8fCB1cGRhdGVkO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvcignRXJyb3Igc2V0dGluZyBzYWZhcmkgcHJlZmVyZW5jZXMsIHByZWZzIHdpbGwgbm90IHdvcmsnKTtcbiAgICBsb2cuZXJyb3IoZSk7XG4gIH1cblxuICByZXR1cm4gdXBkYXRlZDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0TG9jU2VydmljZXNQcmVmcyAoc2ltLCBvcHRzID0ge30pIHtcbiAgbGV0IGxvY1NlcnYgPSBfLmZpbmQoW29wdHMubG9jYXRpb25TZXJ2aWNlc0VuYWJsZWQsIG9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWRdLCAoYykgPT4gIV8uaXNVbmRlZmluZWQoYykpO1xuICBpZiAoIV8uaXNVbmRlZmluZWQobG9jU2VydikpIHtcbiAgICBsb2NTZXJ2ID0gbG9jU2VydiA/IDEgOiAwO1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBsb2NhdGlvbiBzZXJ2aWNlcyB0byAke2xvY1NlcnZ9YCk7XG4gICAgYXdhaXQgc2ltLnVwZGF0ZVNldHRpbmdzKCdsb2NhdGlvblNlcnZpY2VzJywge1xuICAgICAgTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWQ6IGxvY1NlcnYsXG4gICAgICAnTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWRJbjcuMCc6IGxvY1NlcnYsXG4gICAgICAnTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWRJbjguMCc6IGxvY1NlcnZcbiAgICB9KTtcbiAgfVxuICBpZiAoIV8uaXNVbmRlZmluZWQob3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZCkpIHtcbiAgICBpZiAoIW9wdHMuYnVuZGxlSWQpIHtcbiAgICAgIGxldCBtc2cgPSBcIkNhbid0IHNldCBsb2NhdGlvbiBzZXJ2aWNlcyBmb3IgYXBwIHdpdGhvdXQgYnVuZGxlIElEXCI7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgIH1cbiAgICBsZXQgbG9jQXV0aCA9ICEhb3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZDtcbiAgICBpZiAobG9jQXV0aCkge1xuICAgICAgbG9nLmRlYnVnKCdBdXRob3JpemluZyBsb2NhdGlvbiBzZXJ2aWNlcyBmb3IgYXBwJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZygnRGUtYXV0aG9yaXppbmcgbG9jYXRpb24gc2VydmljZXMgZm9yIGFwcCcpO1xuICAgIH1cbiAgICBhd2FpdCBzaW0udXBkYXRlTG9jYXRpb25TZXR0aW5ncyhvcHRzLmJ1bmRsZUlkLCBsb2NBdXRoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRTYWZhcmlQcmVmcyAoc2ltLCBvcHRzID0ge30pIHtcbiAgbGV0IHNhZmFyaVNldHRpbmdzID0ge307XG5cbiAgaWYgKF8uaGFzKG9wdHMsICdzYWZhcmlBbGxvd1BvcHVwcycpKSB7XG4gICAgY29uc3QgdmFsID0gISFvcHRzLnNhZmFyaUFsbG93UG9wdXBzO1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBqYXZhc2NyaXB0IHdpbmRvdyBvcGVuaW5nIHRvICcke3ZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSA9IHZhbDtcbiAgICBzYWZhcmlTZXR0aW5ncy5KYXZhU2NyaXB0Q2FuT3BlbldpbmRvd3NBdXRvbWF0aWNhbGx5ID0gdmFsO1xuICB9XG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpSWdub3JlRnJhdWRXYXJuaW5nJykpIHtcbiAgICBjb25zdCB2YWwgPSAhb3B0cy5zYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmc7XG4gICAgbG9nLmRlYnVnKGBTZXR0aW5nIGZyYXVkdWxlbnQgd2Vic2l0ZSB3YXJuaW5nIHRvICcke3ZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuV2FybkFib3V0RnJhdWR1bGVudFdlYnNpdGVzID0gdmFsO1xuICB9XG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kJykpIHtcbiAgICBjb25zdCB2YWwgPSBvcHRzLnNhZmFyaU9wZW5MaW5rc0luQmFja2dyb3VuZCA/IDEgOiAwO1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBvcGVuaW5nIGxpbmtzIGluIGJhY2tncm91bmQgdG8gJyR7ISF2YWx9J2ApO1xuICAgIHNhZmFyaVNldHRpbmdzLk9wZW5MaW5rc0luQmFja2dyb3VuZCA9IHZhbDtcbiAgfVxuICByZXR1cm4gKF8uc2l6ZShzYWZhcmlTZXR0aW5ncykgPiAwKVxuICAgID8gYXdhaXQgc2ltLnVwZGF0ZVNhZmFyaVNldHRpbmdzKHNhZmFyaVNldHRpbmdzKVxuICAgIDogZmFsc2U7XG59XG5cbmV4cG9ydCB7XG4gIGNyZWF0ZVNpbSwgZ2V0RXhpc3RpbmdTaW0sIHJ1blNpbXVsYXRvclJlc2V0LCBpbnN0YWxsVG9TaW11bGF0b3IsXG4gIHNodXRkb3duU2ltdWxhdG9yLCBzaHV0ZG93bk90aGVyU2ltdWxhdG9ycyxcbiAgc2V0TG9jYWxlLCBzZXRQcmVmZXJlbmNlcywgc2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMsXG59O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsaUJBQWlCLEdBQUcsWUFB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