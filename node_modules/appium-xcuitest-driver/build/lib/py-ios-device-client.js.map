{"version":3,"file":"py-ios-device-client.js","names":["BINARY_NAME","Pyidevice","constructor","udid","binaryPath","assertExists","isStrict","fs","which","e","Error","execute","args","opts","cwd","format","logStdout","asynchronous","finalArgs","push","cmdStr","util","quote","log","debug","result","SubProcess","start","exec","stdout","stderr","message","listProfiles","JSON","parse","installProfile","profilePath","payload","tmpRoot","srcPath","tempDir","openDir","path","join","writeFile","rimraf","removeProfile","name","listCrashes","replace","filter","x","includes","exportCrash","dstFolder","collectPcap","dstFile"],"sources":["../../lib/py-ios-device-client.js"],"sourcesContent":["import { exec, SubProcess } from 'teen_process';\nimport { fs, util, tempDir } from 'appium/support';\nimport log from './logger';\nimport path from 'path';\n\n// https://github.com/YueChen-C/py-ios-device\n\nconst BINARY_NAME = 'pyidevice';\n\nclass Pyidevice {\n  constructor (udid) {\n    this.udid = udid;\n    this.binaryPath = null;\n  }\n\n  async assertExists (isStrict = true) {\n    if (this.binaryPath) {\n      return true;\n    }\n\n    try {\n      this.binaryPath = await fs.which(BINARY_NAME);\n      return true;\n    } catch (e) {\n      if (isStrict) {\n        throw new Error(`${BINARY_NAME} binary cannot be found in PATH. ` +\n          `Please make sure it is installed. Visit https://github.com/YueChen-C/py-ios-device for ` +\n          `more details.`);\n      }\n      return false;\n    }\n  }\n\n  async execute (args, opts = {}) {\n    await this.assertExists();\n    const {\n      cwd,\n      format = 'json',\n      logStdout = false,\n      asynchronous = false,\n    } = opts;\n\n    const finalArgs = [...args, '--udid', this.udid];\n    if (format) {\n      finalArgs.push('--format', format);\n    }\n    const cmdStr = util.quote([this.binaryPath, ...finalArgs]);\n    log.debug(`Executing ${cmdStr}`);\n    try {\n      if (asynchronous) {\n        const result = new SubProcess(this.binaryPath, finalArgs, {cwd});\n        await result.start(0);\n        return result;\n      }\n      const result = await exec(this.binaryPath, finalArgs, {cwd});\n      if (logStdout) {\n        log.debug(`Command output: ${result.stdout}`);\n      }\n      return result;\n    } catch (e) {\n      throw new Error(`'${cmdStr}' failed. Original error: ${e.stderr || e.stdout || e.message}`);\n    }\n  }\n\n  async listProfiles () {\n    const {stdout} = await this.execute(['profiles', 'list']);\n    return JSON.parse(stdout);\n  }\n\n  async installProfile ({profilePath, payload} = {}) {\n    if (!profilePath && !payload) {\n      throw new Error('Either the full path to the profile or its payload must be provided');\n    }\n\n    let tmpRoot;\n    let srcPath = profilePath;\n    try {\n      if (!srcPath) {\n        tmpRoot = await tempDir.openDir();\n        srcPath = path.join(tmpRoot, 'cert.pem');\n        await fs.writeFile(srcPath, payload, 'utf8');\n      }\n      await this.execute(['profiles', 'install', '--path', srcPath], {\n        logStdout: true\n      });\n    } finally {\n      if (tmpRoot) {\n        await fs.rimraf(tmpRoot);\n      }\n    }\n  }\n\n  async removeProfile (name) {\n    await this.execute(['profiles', 'remove', name], {logStdout: true});\n  }\n\n  async listCrashes () {\n    const {stdout} = await this.execute(['crash', 'list']);\n    return JSON.parse(stdout.replace(/'/g, '\"')).filter((x) => !['.', '..'].includes(x));\n  }\n\n  async exportCrash (name, dstFolder) {\n    await this.execute(['crash', 'export', '--name', name], {\n      logStdout: true,\n      // The tool exports crash reports to the current working dir\n      cwd: dstFolder\n    });\n  }\n\n  async collectPcap (dstFile) {\n    return await this.execute(['pcapd', dstFile], {\n      format: null,\n      asynchronous: true\n    });\n  }\n}\n\nexport { Pyidevice };\nexport default Pyidevice;\n"],"mappings":"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"}