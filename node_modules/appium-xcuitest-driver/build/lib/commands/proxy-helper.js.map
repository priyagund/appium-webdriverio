{"version":3,"file":"proxy-helper.js","names":["GET","POST","DELETE","SUPPORTED_METHODS","helpers","extensions","WDA_ROUTES","wdaRouteToCommandName","endpoint","method","proxyCommand","body","isSessionCommand","shutdownUnexpectedly","log","errorAndThrow","includes","join","wda","Error","proxy","jwproxy","noSessionProxy","cmdName","routeToCommandName","timeout","_getCommandTimeout","info","command","debug","isCommandExpired","res","B","resolve","catch","Promise","TimeoutError","cancelActiveRequests","errMsg","startUnexpectedShutdown","errors","Object","assign"],"sources":["../../../lib/commands/proxy-helper.js"],"sourcesContent":["import { errors, routeToCommandName } from 'appium/driver';\nimport B from 'bluebird';\n\n\nconst GET = 'GET';\nconst POST = 'POST';\nconst DELETE = 'DELETE';\nconst SUPPORTED_METHODS = [GET, POST, DELETE];\n\nlet helpers = {}, extensions = {};\n\nconst WDA_ROUTES = {\n  '/wda/touch/perform': {\n    POST: 'performTouch',\n  },\n  '/wda/touch/multi/perform': {\n    POST: 'performMultiAction',\n  },\n  '/wda/screen': {\n    GET: 'getScreenInfo',\n  },\n  '/wda/alert/buttons': {\n    GET: 'getAlertButtons',\n  },\n  '/wda/apps/launch': {\n    POST: 'mobileLaunchApp',\n  },\n  '/wda/apps/terminate': {\n    POST: 'mobileTerminateApp',\n  },\n  '/wda/apps/activate': {\n    POST: 'mobileActivateApp',\n  },\n  '/wda/apps/state': {\n    POST: 'mobileQueryAppState',\n  },\n  '/wda/keys': {\n    POST: 'keys',\n  },\n  '/wda/touch_id': {\n    POST: 'touchId',\n  },\n  '/wda/keyboard/dismiss': {\n    POST: 'hideKeyboard',\n  },\n  '/wda/lock': {\n    POST: 'lock',\n  },\n  '/wda/unlock': {\n    POST: 'unlock',\n  },\n  '/wda/locked': {\n    GET: 'isLocked',\n  },\n  '/wda/tap/nil': {\n    POST: 'clickCoords',\n  },\n  '/window/size': {\n    GET: 'getWindowSize',\n  },\n};\n\nfunction wdaRouteToCommandName (endpoint, method) {\n  return WDA_ROUTES[endpoint] ? WDA_ROUTES[endpoint][method] : null;\n}\n\nhelpers.proxyCommand = async function proxyCommand (endpoint, method, body, isSessionCommand = true) {\n  if (this.shutdownUnexpectedly) {\n    return;\n  }\n\n  if (!endpoint) {\n    this.log.errorAndThrow('Proxying requires an endpoint');\n  } else if (!SUPPORTED_METHODS.includes(method)) {\n    this.log.errorAndThrow(`Proxying only works for the following requests: ${SUPPORTED_METHODS.join(', ')}`);\n  }\n\n  if (!this.wda) {\n    throw new Error('Cannot call proxyCommand without WDA driver active');\n  }\n  const proxy = isSessionCommand ? this.wda.jwproxy : this.wda.noSessionProxy;\n  if (!proxy) {\n    throw new Error('Cannot call proxyCommand without WDA proxy active');\n  }\n\n  let cmdName = wdaRouteToCommandName(endpoint, method) || routeToCommandName(endpoint, method);\n  const timeout = this._getCommandTimeout(cmdName);\n  if (!cmdName) {\n    // this should never happen except when adding new routes\n    cmdName = 'Unknown'; // just for logging purposes below\n    this.log.info(`Proxying to WDA with an unknown route: ${method} ${endpoint}`);\n  }\n\n  if (!timeout) {\n    return await proxy.command(endpoint, method, body);\n  }\n\n  this.log.debug(`Setting custom timeout to ${timeout} ms for '${cmdName}' command`);\n  let isCommandExpired = false;\n  const res = await B.resolve(proxy.command(endpoint, method, body))\n                .timeout(timeout)\n                .catch(B.Promise.TimeoutError, () => {\n                  isCommandExpired = true;\n                });\n  if (isCommandExpired) {\n    proxy.cancelActiveRequests();\n    const errMsg = `Appium did not get any response from '${cmdName}' command in ${timeout} ms`;\n    await this.startUnexpectedShutdown(new errors.TimeoutError(errMsg));\n    this.log.errorAndThrow(errMsg);\n  }\n  return res;\n};\n\nObject.assign(extensions, helpers);\nexport { helpers };\nexport default extensions;\n"],"mappings":"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"}