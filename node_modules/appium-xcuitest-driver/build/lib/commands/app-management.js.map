{"version":3,"file":"app-management.js","names":["commands","requireOptions","opts","reqKeys","key","_","isString","isEmpty","errors","InvalidArgumentError","mobileInstallApp","app","timeoutMs","strategy","srcAppPath","helpers","configureApp","log","info","isRealDevice","device","udid","fs","exists","errorAndThrow","installApp","appPushTimeout","appInstallStrategy","mobileIsAppInstalled","bundleId","installed","isAppInstalled","mobileRemoveApp","removeApp","err","warn","message","mobileLaunchApp","launchOptions","arguments","isArray","environment","proxyCommand","mobileTerminateApp","mobileActivateApp","mobileKillApp","UnsupportedOperationError","terminateApp","mobileQueryAppState","appPath","isPlainObject","activateApp","Object","assign","queryAppState","mobileListApps","NotImplementedError","applicationType","service","services","startInstallationProxyService","listApplications","close"],"sources":["../../../lib/commands/app-management.js"],"sourcesContent":["import _ from 'lodash';\nimport { fs } from 'appium/support';\nimport { errors } from 'appium/driver';\nimport { services } from 'appium-ios-device';\n\nconst commands = {};\n\nfunction requireOptions (opts = {}, reqKeys = []) {\n  for (const key of reqKeys) {\n    if (!_.isString(opts[key]) || _.isEmpty(opts[key])) {\n      throw new errors.InvalidArgumentError(\n        `'${key}' is expected to be a valid string. '${opts[key]}' is given instead`\n      );\n    }\n  }\n  return opts;\n}\n\ncommands.mobileInstallApp = async function mobileInstallApp (opts = {}) {\n  const { app, timeoutMs, strategy } = requireOptions(opts, ['app']);\n  const srcAppPath = await this.helpers.configureApp(app, '.app');\n  this.log.info(`Installing '${srcAppPath}' to the ${this.isRealDevice() ? 'real device' : 'Simulator'} ` +\n    `with UDID '${this.opts.device.udid}'`);\n  if (!await fs.exists(srcAppPath)) {\n    this.log.errorAndThrow(`The application at '${srcAppPath}' does not exist or is not accessible`);\n  }\n  await this.opts.device.installApp(\n    srcAppPath, timeoutMs ?? this.opts.appPushTimeout, strategy ?? this.opts.appInstallStrategy\n  );\n  this.log.info(`Installation of '${srcAppPath}' succeeded`);\n};\n\ncommands.mobileIsAppInstalled = async function mobileIsAppInstalled (opts = {}) {\n  const {bundleId} = requireOptions(opts, ['bundleId']);\n  const installed = await this.opts.device.isAppInstalled(bundleId);\n  this.log.info(`App '${bundleId}' is${installed ? '' : ' not'} installed`);\n  return installed;\n};\n\ncommands.mobileRemoveApp = async function mobileRemoveApp (opts = {}) {\n  const {bundleId} = requireOptions(opts, ['bundleId']);\n  this.log.info(`Uninstalling the application with bundle identifier '${bundleId}' ` +\n    `from the ${this.isRealDevice() ? 'real device' : 'Simulator'} with UDID '${this.opts.device.udid}'`);\n  try {\n    await this.opts.device.removeApp(bundleId);\n    this.log.info(`Removal of '${bundleId}' succeeded`);\n    return true;\n  } catch (err) {\n    this.log.warn(`Cannot remove '${bundleId}'. Original error: ${err.message}`);\n    return false;\n  }\n};\n\ncommands.mobileLaunchApp = async function mobileLaunchApp (opts = {}) {\n  const launchOptions = requireOptions(opts, ['bundleId']);\n  if (opts.arguments) {\n    launchOptions.arguments = _.isArray(opts.arguments) ? opts.arguments : [opts.arguments];\n  }\n  if (opts.environment) {\n    launchOptions.environment = opts.environment;\n  }\n  return await this.proxyCommand('/wda/apps/launch', 'POST', launchOptions);\n};\n\ncommands.mobileTerminateApp = async function mobileTerminateApp (opts = {}) {\n  return await this.proxyCommand('/wda/apps/terminate', 'POST', requireOptions(opts, ['bundleId']));\n};\n\ncommands.mobileActivateApp = async function mobileActivateApp (opts = {}) {\n  return await this.proxyCommand('/wda/apps/activate', 'POST', requireOptions(opts, ['bundleId']));\n};\n\n/**\n * Kill the given bundle id process via instruments service.\n * https://github.com/YueChen-C/py-ios-device/blob/51f4683c5c3c385a015858ada07a5f1c62d3cf57/ios_device/cli/base.py#L220\n *\n * @param {Object} opts - Options set, which must contain `bundleId` property\n * @returns {boolean} Returns true if the bundle id process was killed. Otherwise false.\n */\ncommands.mobileKillApp = async function mobileKillApp (opts = {}) {\n  if (!this.isRealDevice()) {\n    throw new errors.UnsupportedOperationError('A real device is required');\n  }\n\n  const {bundleId} = requireOptions(opts, ['bundleId']);\n  return await this.opts.device.terminateApp(bundleId);\n};\n\n/**\n * Returns the current application state\n *\n * @param {Object} opts - Options set, which must contain `bundleId` property\n * @returns {number} The actual application state code. See\n * https://developer.apple.com/documentation/xctest/xcuiapplicationstate?language=objc\n * to get the list of possible values.\n */\ncommands.mobileQueryAppState = async function mobileQueryAppState (opts = {}) {\n  return await this.proxyCommand('/wda/apps/state', 'POST', requireOptions(opts, ['bundleId']));\n};\n\ncommands.installApp = async function installApp (appPath, opts = {}) {\n  await this.mobileInstallApp({\n    ...(_.isPlainObject(opts) ? opts : {}),\n    app: appPath,\n  });\n};\n\ncommands.activateApp = async function activateApp (bundleId, opts = {}) {\n  return await this.mobileLaunchApp(Object.assign({}, opts, {bundleId}));\n};\n\ncommands.isAppInstalled = async function isAppInstalled (bundleId) {\n  return await this.mobileIsAppInstalled({bundleId});\n};\n\ncommands.terminateApp = async function terminateApp (bundleId) {\n  return await this.mobileTerminateApp({bundleId});\n};\n\ncommands.queryAppState = async function queryAppState (bundleId) {\n  return await this.mobileQueryAppState({bundleId});\n};\n\n/**\n * @typedef {Object} ListAppsOptions\n * @property {'System'|'User'} applicationType [User] The type of applications to list\n */\n\n/**\n * List applications installed on the real device under test\n *\n * @param {ListAppsOptions} opts\n * @returns {Array<Object>} A list of apps, where each item is a map where keys are\n * bundle identifiers and values are maps of platform-specific app properties.\n */\ncommands.mobileListApps = async function mobileListApps (opts = {}) {\n  if (!this.isRealDevice()) {\n    throw new errors.NotImplementedError(`This extension is only supported on real devices`);\n  }\n\n  const {\n    applicationType = 'User',\n  } = opts;\n  const service = await services.startInstallationProxyService(this.opts.device.udid);\n  try {\n    return await service.listApplications({applicationType});\n  } finally {\n    service.close();\n  }\n};\n\nexport default commands;\n"],"mappings":";;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AAEA,MAAMA,QAAQ,GAAG,EAAjB;;AAEA,SAASC,cAAT,CAAyBC,IAAI,GAAG,EAAhC,EAAoCC,OAAO,GAAG,EAA9C,EAAkD;EAChD,KAAK,MAAMC,GAAX,IAAkBD,OAAlB,EAA2B;IACzB,IAAI,CAACE,eAAA,CAAEC,QAAF,CAAWJ,IAAI,CAACE,GAAD,CAAf,CAAD,IAA0BC,eAAA,CAAEE,OAAF,CAAUL,IAAI,CAACE,GAAD,CAAd,CAA9B,EAAoD;MAClD,MAAM,IAAII,cAAA,CAAOC,oBAAX,CACH,IAAGL,GAAI,wCAAuCF,IAAI,CAACE,GAAD,CAAM,oBADrD,CAAN;IAGD;EACF;;EACD,OAAOF,IAAP;AACD;;AAEDF,QAAQ,CAACU,gBAAT,GAA4B,eAAeA,gBAAf,CAAiCR,IAAI,GAAG,EAAxC,EAA4C;EACtE,MAAM;IAAES,GAAF;IAAOC,SAAP;IAAkBC;EAAlB,IAA+BZ,cAAc,CAACC,IAAD,EAAO,CAAC,KAAD,CAAP,CAAnD;EACA,MAAMY,UAAU,GAAG,MAAM,KAAKC,OAAL,CAAaC,YAAb,CAA0BL,GAA1B,EAA+B,MAA/B,CAAzB;EACA,KAAKM,GAAL,CAASC,IAAT,CAAe,eAAcJ,UAAW,YAAW,KAAKK,YAAL,KAAsB,aAAtB,GAAsC,WAAY,GAAvF,GACX,cAAa,KAAKjB,IAAL,CAAUkB,MAAV,CAAiBC,IAAK,GADtC;;EAEA,IAAI,EAAC,MAAMC,WAAA,CAAGC,MAAH,CAAUT,UAAV,CAAP,CAAJ,EAAkC;IAChC,KAAKG,GAAL,CAASO,aAAT,CAAwB,uBAAsBV,UAAW,uCAAzD;EACD;;EACD,MAAM,KAAKZ,IAAL,CAAUkB,MAAV,CAAiBK,UAAjB,CACJX,UADI,EACQF,SAAS,IAAI,KAAKV,IAAL,CAAUwB,cAD/B,EAC+Cb,QAAQ,IAAI,KAAKX,IAAL,CAAUyB,kBADrE,CAAN;EAGA,KAAKV,GAAL,CAASC,IAAT,CAAe,oBAAmBJ,UAAW,aAA7C;AACD,CAZD;;AAcAd,QAAQ,CAAC4B,oBAAT,GAAgC,eAAeA,oBAAf,CAAqC1B,IAAI,GAAG,EAA5C,EAAgD;EAC9E,MAAM;IAAC2B;EAAD,IAAa5B,cAAc,CAACC,IAAD,EAAO,CAAC,UAAD,CAAP,CAAjC;EACA,MAAM4B,SAAS,GAAG,MAAM,KAAK5B,IAAL,CAAUkB,MAAV,CAAiBW,cAAjB,CAAgCF,QAAhC,CAAxB;EACA,KAAKZ,GAAL,CAASC,IAAT,CAAe,QAAOW,QAAS,OAAMC,SAAS,GAAG,EAAH,GAAQ,MAAO,YAA7D;EACA,OAAOA,SAAP;AACD,CALD;;AAOA9B,QAAQ,CAACgC,eAAT,GAA2B,eAAeA,eAAf,CAAgC9B,IAAI,GAAG,EAAvC,EAA2C;EACpE,MAAM;IAAC2B;EAAD,IAAa5B,cAAc,CAACC,IAAD,EAAO,CAAC,UAAD,CAAP,CAAjC;EACA,KAAKe,GAAL,CAASC,IAAT,CAAe,wDAAuDW,QAAS,IAAjE,GACX,YAAW,KAAKV,YAAL,KAAsB,aAAtB,GAAsC,WAAY,eAAc,KAAKjB,IAAL,CAAUkB,MAAV,CAAiBC,IAAK,GADpG;;EAEA,IAAI;IACF,MAAM,KAAKnB,IAAL,CAAUkB,MAAV,CAAiBa,SAAjB,CAA2BJ,QAA3B,CAAN;IACA,KAAKZ,GAAL,CAASC,IAAT,CAAe,eAAcW,QAAS,aAAtC;IACA,OAAO,IAAP;EACD,CAJD,CAIE,OAAOK,GAAP,EAAY;IACZ,KAAKjB,GAAL,CAASkB,IAAT,CAAe,kBAAiBN,QAAS,sBAAqBK,GAAG,CAACE,OAAQ,EAA1E;IACA,OAAO,KAAP;EACD;AACF,CAZD;;AAcApC,QAAQ,CAACqC,eAAT,GAA2B,eAAeA,eAAf,CAAgCnC,IAAI,GAAG,EAAvC,EAA2C;EACpE,MAAMoC,aAAa,GAAGrC,cAAc,CAACC,IAAD,EAAO,CAAC,UAAD,CAAP,CAApC;;EACA,IAAIA,IAAI,CAACqC,SAAT,EAAoB;IAClBD,aAAa,CAACC,SAAd,GAA0BlC,eAAA,CAAEmC,OAAF,CAAUtC,IAAI,CAACqC,SAAf,IAA4BrC,IAAI,CAACqC,SAAjC,GAA6C,CAACrC,IAAI,CAACqC,SAAN,CAAvE;EACD;;EACD,IAAIrC,IAAI,CAACuC,WAAT,EAAsB;IACpBH,aAAa,CAACG,WAAd,GAA4BvC,IAAI,CAACuC,WAAjC;EACD;;EACD,OAAO,MAAM,KAAKC,YAAL,CAAkB,kBAAlB,EAAsC,MAAtC,EAA8CJ,aAA9C,CAAb;AACD,CATD;;AAWAtC,QAAQ,CAAC2C,kBAAT,GAA8B,eAAeA,kBAAf,CAAmCzC,IAAI,GAAG,EAA1C,EAA8C;EAC1E,OAAO,MAAM,KAAKwC,YAAL,CAAkB,qBAAlB,EAAyC,MAAzC,EAAiDzC,cAAc,CAACC,IAAD,EAAO,CAAC,UAAD,CAAP,CAA/D,CAAb;AACD,CAFD;;AAIAF,QAAQ,CAAC4C,iBAAT,GAA6B,eAAeA,iBAAf,CAAkC1C,IAAI,GAAG,EAAzC,EAA6C;EACxE,OAAO,MAAM,KAAKwC,YAAL,CAAkB,oBAAlB,EAAwC,MAAxC,EAAgDzC,cAAc,CAACC,IAAD,EAAO,CAAC,UAAD,CAAP,CAA9D,CAAb;AACD,CAFD;;AAWAF,QAAQ,CAAC6C,aAAT,GAAyB,eAAeA,aAAf,CAA8B3C,IAAI,GAAG,EAArC,EAAyC;EAChE,IAAI,CAAC,KAAKiB,YAAL,EAAL,EAA0B;IACxB,MAAM,IAAIX,cAAA,CAAOsC,yBAAX,CAAqC,2BAArC,CAAN;EACD;;EAED,MAAM;IAACjB;EAAD,IAAa5B,cAAc,CAACC,IAAD,EAAO,CAAC,UAAD,CAAP,CAAjC;EACA,OAAO,MAAM,KAAKA,IAAL,CAAUkB,MAAV,CAAiB2B,YAAjB,CAA8BlB,QAA9B,CAAb;AACD,CAPD;;AAiBA7B,QAAQ,CAACgD,mBAAT,GAA+B,eAAeA,mBAAf,CAAoC9C,IAAI,GAAG,EAA3C,EAA+C;EAC5E,OAAO,MAAM,KAAKwC,YAAL,CAAkB,iBAAlB,EAAqC,MAArC,EAA6CzC,cAAc,CAACC,IAAD,EAAO,CAAC,UAAD,CAAP,CAA3D,CAAb;AACD,CAFD;;AAIAF,QAAQ,CAACyB,UAAT,GAAsB,eAAeA,UAAf,CAA2BwB,OAA3B,EAAoC/C,IAAI,GAAG,EAA3C,EAA+C;EACnE,MAAM,KAAKQ,gBAAL,CAAsB,EAC1B,IAAIL,eAAA,CAAE6C,aAAF,CAAgBhD,IAAhB,IAAwBA,IAAxB,GAA+B,EAAnC,CAD0B;IAE1BS,GAAG,EAAEsC;EAFqB,CAAtB,CAAN;AAID,CALD;;AAOAjD,QAAQ,CAACmD,WAAT,GAAuB,eAAeA,WAAf,CAA4BtB,QAA5B,EAAsC3B,IAAI,GAAG,EAA7C,EAAiD;EACtE,OAAO,MAAM,KAAKmC,eAAL,CAAqBe,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBnD,IAAlB,EAAwB;IAAC2B;EAAD,CAAxB,CAArB,CAAb;AACD,CAFD;;AAIA7B,QAAQ,CAAC+B,cAAT,GAA0B,eAAeA,cAAf,CAA+BF,QAA/B,EAAyC;EACjE,OAAO,MAAM,KAAKD,oBAAL,CAA0B;IAACC;EAAD,CAA1B,CAAb;AACD,CAFD;;AAIA7B,QAAQ,CAAC+C,YAAT,GAAwB,eAAeA,YAAf,CAA6BlB,QAA7B,EAAuC;EAC7D,OAAO,MAAM,KAAKc,kBAAL,CAAwB;IAACd;EAAD,CAAxB,CAAb;AACD,CAFD;;AAIA7B,QAAQ,CAACsD,aAAT,GAAyB,eAAeA,aAAf,CAA8BzB,QAA9B,EAAwC;EAC/D,OAAO,MAAM,KAAKmB,mBAAL,CAAyB;IAACnB;EAAD,CAAzB,CAAb;AACD,CAFD;;AAgBA7B,QAAQ,CAACuD,cAAT,GAA0B,eAAeA,cAAf,CAA+BrD,IAAI,GAAG,EAAtC,EAA0C;EAClE,IAAI,CAAC,KAAKiB,YAAL,EAAL,EAA0B;IACxB,MAAM,IAAIX,cAAA,CAAOgD,mBAAX,CAAgC,kDAAhC,CAAN;EACD;;EAED,MAAM;IACJC,eAAe,GAAG;EADd,IAEFvD,IAFJ;EAGA,MAAMwD,OAAO,GAAG,MAAMC,yBAAA,CAASC,6BAAT,CAAuC,KAAK1D,IAAL,CAAUkB,MAAV,CAAiBC,IAAxD,CAAtB;;EACA,IAAI;IACF,OAAO,MAAMqC,OAAO,CAACG,gBAAR,CAAyB;MAACJ;IAAD,CAAzB,CAAb;EACD,CAFD,SAEU;IACRC,OAAO,CAACI,KAAR;EACD;AACF,CAdD;;eAgBe9D,Q"}