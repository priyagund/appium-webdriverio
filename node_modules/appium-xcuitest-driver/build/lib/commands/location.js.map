{"version":3,"file":"location.js","names":["commands","getGeoLocation","authorizationStatus","latitude","longitude","altitude","proxyCommand","log","errorAndThrow","setGeoLocation","location","util","hasValue","errors","InvalidArgumentError","isSimulator","opts","device","setGeolocation","service","services","startSimulateLocationService","udid","setLocation","e","message","close","mobileResetLocationService","NotImplementedError","resetLocation","err"],"sources":["../../../lib/commands/location.js"],"sourcesContent":["import { errors } from 'appium/driver';\nimport { services } from 'appium-ios-device';\nimport { util } from 'appium/support';\n\nconst commands = {};\n\n/**\n * @typedef {Object} LocationObject\n *\n * @property {number} latitude - The latitude of the device under test\n * @property {number} longitude - The longitude of the device under test\n * @property {number} altitude - The altitude of the device under test\n */\n\n/**\n * Returns location of the device under test.\n * The device under test must allow the location services for WDA\n * as 'Always' to get the location data correctly.\n *\n * The 'latitude', 'longitude' and 'altitude' could be zero even\n * if the Location Services are set to 'Always', because the device\n * needs some time to update the location data.\n *\n * @returns {LocationObject}\n * @throws {Error} If the device under test returns an error message.\n *                 i.e.: tvOS returns unsupported error\n */\ncommands.getGeoLocation = async function getGeoLocation () {\n  const {\n    authorizationStatus,\n    latitude,\n    longitude,\n    altitude\n  } = await this.proxyCommand('/wda/device/location', 'GET');\n\n  // '3' is 'Always' in the privacy\n  // https://developer.apple.com/documentation/corelocation/clauthorizationstatus\n  if (authorizationStatus !== 3) {\n    this.log.errorAndThrow(`Location service must be set to 'Always' in order to ` +\n      `retrive the current geolocation data. Please set it up manually via ` +\n      `'Settings > Privacy > Location Services -> WebDriverAgentRunner-Runner'`);\n  }\n\n  return {latitude, longitude, altitude};\n};\n\ncommands.setGeoLocation = async function setGeoLocation (location) {\n  let {latitude, longitude} = location;\n\n  if (!util.hasValue(latitude) || !util.hasValue(longitude)) {\n    throw new errors.InvalidArgumentError(`Both latitude and longitude should be set`);\n  }\n\n  if (this.isSimulator()) {\n    await this.opts.device.setGeolocation(`${latitude}`, `${longitude}`);\n    return;\n  }\n\n  const service = await services.startSimulateLocationService(this.opts.udid);\n  try {\n    service.setLocation(latitude, longitude);\n  } catch (e) {\n    this.log.errorAndThrow(`Can't set the location on device '${this.opts.udid}'. Original error: ${e.message}`);\n  } finally {\n    service.close();\n  }\n};\n\n/**\n * Reset the location service on real device.\n * Raises not implemented error for simulator.\n * @throws {Error} If the device is simulator, or 'resetLocation' raises an error.\n */\ncommands.mobileResetLocationService = async function mobileResetLocationService () {\n  if (this.isSimulator()) {\n    throw new errors.NotImplementedError();\n  }\n\n  const service = await services.startSimulateLocationService(this.opts.udid);\n  try {\n    service.resetLocation();\n  } catch (err) {\n    this.log.errorAndThrow(`Failed to reset the location on the device on device '${this.opts.udid}'. ` +\n      `Origianl error: ${err.message}`);\n  } finally {\n    service.close();\n  }\n};\n\nexport { commands };\nexport default commands;\n"],"mappings":";;;;;;;;;AAAA;;AACA;;AACA;;AAEA,MAAMA,QAAQ,GAAG,EAAjB;;;AAuBAA,QAAQ,CAACC,cAAT,GAA0B,eAAeA,cAAf,GAAiC;EACzD,MAAM;IACJC,mBADI;IAEJC,QAFI;IAGJC,SAHI;IAIJC;EAJI,IAKF,MAAM,KAAKC,YAAL,CAAkB,sBAAlB,EAA0C,KAA1C,CALV;;EASA,IAAIJ,mBAAmB,KAAK,CAA5B,EAA+B;IAC7B,KAAKK,GAAL,CAASC,aAAT,CAAwB,uDAAD,GACpB,sEADoB,GAEpB,yEAFH;EAGD;;EAED,OAAO;IAACL,QAAD;IAAWC,SAAX;IAAsBC;EAAtB,CAAP;AACD,CAjBD;;AAmBAL,QAAQ,CAACS,cAAT,GAA0B,eAAeA,cAAf,CAA+BC,QAA/B,EAAyC;EACjE,IAAI;IAACP,QAAD;IAAWC;EAAX,IAAwBM,QAA5B;;EAEA,IAAI,CAACC,aAAA,CAAKC,QAAL,CAAcT,QAAd,CAAD,IAA4B,CAACQ,aAAA,CAAKC,QAAL,CAAcR,SAAd,CAAjC,EAA2D;IACzD,MAAM,IAAIS,cAAA,CAAOC,oBAAX,CAAiC,2CAAjC,CAAN;EACD;;EAED,IAAI,KAAKC,WAAL,EAAJ,EAAwB;IACtB,MAAM,KAAKC,IAAL,CAAUC,MAAV,CAAiBC,cAAjB,CAAiC,GAAEf,QAAS,EAA5C,EAAgD,GAAEC,SAAU,EAA5D,CAAN;IACA;EACD;;EAED,MAAMe,OAAO,GAAG,MAAMC,yBAAA,CAASC,4BAAT,CAAsC,KAAKL,IAAL,CAAUM,IAAhD,CAAtB;;EACA,IAAI;IACFH,OAAO,CAACI,WAAR,CAAoBpB,QAApB,EAA8BC,SAA9B;EACD,CAFD,CAEE,OAAOoB,CAAP,EAAU;IACV,KAAKjB,GAAL,CAASC,aAAT,CAAwB,qCAAoC,KAAKQ,IAAL,CAAUM,IAAK,sBAAqBE,CAAC,CAACC,OAAQ,EAA1G;EACD,CAJD,SAIU;IACRN,OAAO,CAACO,KAAR;EACD;AACF,CApBD;;AA2BA1B,QAAQ,CAAC2B,0BAAT,GAAsC,eAAeA,0BAAf,GAA6C;EACjF,IAAI,KAAKZ,WAAL,EAAJ,EAAwB;IACtB,MAAM,IAAIF,cAAA,CAAOe,mBAAX,EAAN;EACD;;EAED,MAAMT,OAAO,GAAG,MAAMC,yBAAA,CAASC,4BAAT,CAAsC,KAAKL,IAAL,CAAUM,IAAhD,CAAtB;;EACA,IAAI;IACFH,OAAO,CAACU,aAAR;EACD,CAFD,CAEE,OAAOC,GAAP,EAAY;IACZ,KAAKvB,GAAL,CAASC,aAAT,CAAwB,yDAAwD,KAAKQ,IAAL,CAAUM,IAAK,KAAxE,GACpB,mBAAkBQ,GAAG,CAACL,OAAQ,EADjC;EAED,CALD,SAKU;IACRN,OAAO,CAACO,KAAR;EACD;AACF,CAdD;;eAiBe1B,Q"}