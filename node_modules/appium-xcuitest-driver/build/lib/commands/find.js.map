{"version":3,"file":"find.js","names":["MAGIC_FIRST_VIS_CHILD_SEL","MAGIC_SCROLLABLE_SEL","WDA_CLASS_CHAIN_STRATEGY","helpers","commands","extensions","findElOrEls","strategy","selector","mult","context","isWebview","findWebElementOrElements","findNativeElementOrElements","initSelector","rewroteSelector","CssConverter","toIosClassChainSelector","stripViewFromSelector","keepView","includes","indexOf","length","substr","startsWith","substring","test","getFirstVisibleChild","rewriteMagicScrollable","log","replace","str","g1","g2","g3","info","doNativeFind","util","unwrapElement","endpoint","body","using","value","method","els","implicitWaitForCondition","proxyCommand","err","_","isEmpty","message","match","errors","NoSuchElementError","Error","index","nthChild","visible","getAttribute","pred","map","t","join","Object","assign"],"sources":["../../../lib/commands/find.js"],"sourcesContent":["import _ from 'lodash';\nimport CssConverter from '../css-converter';\nimport { errors } from 'appium/driver';\nimport { util } from 'appium/support';\n\n// we override the xpath search for this first-visible-child selector, which\n// looks like /*[@firstVisible=\"true\"]\nconst MAGIC_FIRST_VIS_CHILD_SEL = /\\/\\*\\[@firstVisible\\s*=\\s*('|\")true\\1\\]/;\n\n// we likewise override xpath search to provide a shortcut for finding all\n// scrollable elements\nconst MAGIC_SCROLLABLE_SEL = /\\/\\/\\*\\[@scrollable\\s*=\\s*('|\")true\\1\\]/;\n\nconst WDA_CLASS_CHAIN_STRATEGY = 'class chain';\n\nlet helpers = {}, commands = {}, extensions = {};\n\nhelpers.findElOrEls = async function findElOrEls (strategy, selector, mult, context) {\n  if (this.isWebview()) {\n    return await this.findWebElementOrElements(strategy, selector, mult, context);\n  } else {\n    return await this.findNativeElementOrElements(strategy, selector, mult, context);\n  }\n};\n\nhelpers.findNativeElementOrElements = async function findNativeElementOrElements (strategy, selector, mult, context) {\n  const initSelector = selector;\n  let rewroteSelector = false;\n  if (strategy === '-ios predicate string') {\n    // WebDriverAgent uses 'predicate string'\n    strategy = 'predicate string';\n  } else if (strategy === '-ios class chain') {\n    // WebDriverAgent uses 'class chain'\n    strategy = WDA_CLASS_CHAIN_STRATEGY;\n  } else if (strategy === 'css selector') {\n    strategy = WDA_CLASS_CHAIN_STRATEGY;\n    selector = CssConverter.toIosClassChainSelector(selector);\n  }\n\n  // Check if the word 'View' is appended to selector and if it is, strip it out\n  function stripViewFromSelector (selector) {\n    // Don't strip it out if it's one of these 4 element types\n    // (see https://github.com/facebook/WebDriverAgent/blob/master/WebDriverAgentLib/Utilities/FBElementTypeTransformer.m for reference)\n    const keepView = [\n      'XCUIElementTypeScrollView',\n      'XCUIElementTypeCollectionView',\n      'XCUIElementTypeTextView',\n      'XCUIElementTypeWebView',\n    ].includes(selector);\n\n    if (!keepView && selector.indexOf('View') === selector.length - 4) {\n      return selector.substr(0, selector.length - 4);\n    } else {\n      return selector;\n    }\n  }\n\n  if (strategy === 'class name') {\n    // XCUITest classes have `XCUIElementType` prepended\n    // first check if there is the old `UIA` prefix\n    if (selector.startsWith('UIA')) {\n      selector = selector.substring(3);\n    }\n    // now check if we need to add `XCUIElementType`\n    if (!selector.startsWith('XCUIElementType')) {\n      selector = stripViewFromSelector(`XCUIElementType${selector}`);\n      rewroteSelector = true;\n    }\n  }\n\n  if (strategy === 'xpath' && MAGIC_FIRST_VIS_CHILD_SEL.test(selector)) {\n    return await this.getFirstVisibleChild(mult, context);\n  } else if (strategy === 'xpath' && MAGIC_SCROLLABLE_SEL.test(selector)) {\n    [strategy, selector] = rewriteMagicScrollable(mult, this.log);\n  } else if (strategy === 'xpath') {\n    // Replace UIA if it comes after a forward slash or is at the beginning of the string\n    selector = selector.replace(/(^|\\/)(UIA)([^[/]+)/g, (str, g1, g2, g3) => {\n      rewroteSelector = true;\n      return g1 + stripViewFromSelector(`XCUIElementType${g3}`);\n    });\n  }\n\n  if (rewroteSelector) {\n    this.log.info(`Rewrote incoming selector from '${initSelector}' to ` +\n             `'${selector}' to match XCUI type. You should consider ` +\n             `updating your tests to use the new selectors directly`);\n  }\n\n  return await this.doNativeFind(strategy, selector, mult, context);\n};\n\nhelpers.doNativeFind = async function doNativeFind (strategy, selector, mult, context) {\n  context = util.unwrapElement(context);\n\n  let endpoint = `/element${context ? `/${context}/element` : ''}${mult ? 's' : ''}`;\n\n  let body = {\n    using: strategy,\n    value: selector\n  };\n\n  let method = 'POST';\n\n  // This is either an array is mult === true\n  // or an object if mult === false\n  let els;\n  try {\n    await this.implicitWaitForCondition(async () => {\n      try {\n        els = await this.proxyCommand(endpoint, method, body);\n      } catch (err) {\n        els = [];\n      }\n      // we succeed if we get some elements\n      return !_.isEmpty(els);\n    });\n  } catch (err) {\n    if (err.message && err.message.match(/Condition unmet/)) {\n      // condition was not met setting res to empty array\n      els = [];\n    } else {\n      throw err;\n    }\n  }\n  if (mult) {\n    return els;\n  }\n  if (_.isEmpty(els)) {\n    throw new errors.NoSuchElementError();\n  }\n  return els;\n};\n\nhelpers.getFirstVisibleChild = async function getFirstVisibleChild (mult, context) {\n  this.log.info(`Getting first visible child`);\n  if (mult) {\n    throw new Error('Cannot get multiple first visible children!');\n  }\n  if (!context) {\n    throw new Error('Cannot get first visible child without a context element');\n  }\n  let index = 1;\n  // loop through children via class-chain finds, until we run out of children\n  // or we find a visible one. This loop looks infinite but its not, because at\n  // some point the call to doNativeFind will throw with an Element Not Found\n  // error, when the index gets higher than the number of child elements. This\n  // is what we want because that error will halt the loop and make it all the\n  // way to the client.\n  while (true) { // eslint-disable-line no-constant-condition\n    const strategy = WDA_CLASS_CHAIN_STRATEGY;\n    const selector = `*[${index}]`;\n    const nthChild = await this.doNativeFind(strategy, selector, false, context);\n    const visible = await this.getAttribute('visible', nthChild);\n    if (visible === 'true') {\n      this.log.info(`Found first visible child at position ${index}`);\n      return nthChild;\n    }\n    index++;\n  }\n};\n\nfunction rewriteMagicScrollable (mult, log = null) {\n  const pred = [\n    'ScrollView',\n    'Table',\n    'CollectionView',\n    'WebView'\n  ].map((t) => `type == \"XCUIElementType${t}\"`).join(' OR ');\n  const strategy = WDA_CLASS_CHAIN_STRATEGY;\n  let selector = '**/*[`' + pred + '`]';\n  if (!mult) {\n    selector += '[1]';\n  }\n  log?.info('Rewrote request for scrollable descendants to class chain ' +\n    `format with selector '${selector}'`);\n  return [strategy, selector];\n}\n\n\nObject.assign(extensions, commands, helpers);\nexport { commands, helpers};\nexport default extensions;\n"],"mappings":"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"}