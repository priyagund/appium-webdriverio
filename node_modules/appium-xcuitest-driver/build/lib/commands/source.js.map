{"version":3,"file":"source.js","names":["commands","helpers","extensions","APPIUM_AUT_TAG","APPIUM_SRC_XML","APPIUM_TAG_PATTERN","RegExp","getPageSource","isWebContext","script","executeAtom","settings","getSettings","useJSONSource","srcTree","mobileGetSource","format","getSourceXml","getTreeForXML","getNativePageSource","proxyCommand","test","parser","xmldom","DOMParser","tree","parseFromString","doc","documentElement","appendChild","XMLSerializer","serializeToString","opts","paramsMap","scope","excludedAttributes","excluded_attributes","query","Object","entries","map","k","v","encodeURIComponent","join","getTree","element","elementIndex","parentPath","curPath","rect","subtree","type","enabled","parseInt","isEnabled","visible","isVisible","x","y","width","height","name","label","value","i","children","length","push","jsonSource","js2xml","wrapArray","elementName","declaration","include","prettyPrinting","indentString","assign"],"sources":["../../../lib/commands/source.js"],"sourcesContent":["import xmldom from '@xmldom/xmldom';\nimport js2xml from 'js2xmlparser2';\n\n\nlet commands = {}, helpers = {}, extensions = {};\n\nconst APPIUM_AUT_TAG = 'AppiumAUT';\nconst APPIUM_SRC_XML = `<?xml version=\"1.0\" encoding=\"UTF-8\"?><${APPIUM_AUT_TAG}/>`;\nconst APPIUM_TAG_PATTERN = new RegExp(`</?${APPIUM_AUT_TAG}/?>`);\n\n\ncommands.getPageSource = async function getPageSource () {\n  if (this.isWebContext()) {\n    const script = 'return document.documentElement.outerHTML';\n    return await this.executeAtom('execute_script', [script, []]);\n  }\n\n  if ((await this.settings.getSettings()).useJSONSource) {\n    const srcTree = await this.mobileGetSource({format: 'json'});\n    return getSourceXml(getTreeForXML(srcTree));\n  }\n  return await this.getNativePageSource();\n};\n\nhelpers.getNativePageSource = async function getNativePageSource () {\n  const srcTree = await this.proxyCommand(`/source?scope=${APPIUM_AUT_TAG}`, 'GET');\n  if (APPIUM_TAG_PATTERN.test(srcTree)) {\n    return srcTree;\n  }\n  // This might only happen if the driver is using an older/cached WDA\n  // build (e.g. below 3.16.0)\n  // TODO: remove this block after a while\n  const parser = new xmldom.DOMParser();\n  const tree = parser.parseFromString(srcTree);\n  const doc = parser.parseFromString(APPIUM_SRC_XML);\n  doc.documentElement.appendChild(tree.documentElement);\n  return new xmldom.XMLSerializer().serializeToString(doc);\n};\n\nhelpers.mobileGetSource = async function mobileGetSource (opts = {}) {\n  const paramsMap = {\n    format: opts.format || 'xml',\n    scope: APPIUM_AUT_TAG,\n  };\n  if (opts.excludedAttributes) {\n    paramsMap.excluded_attributes = opts.excludedAttributes;\n  }\n  const query = Object.entries(paramsMap)\n    .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)\n    .join('&');\n  return await this.proxyCommand(`/source?${query}`, 'GET');\n};\n\n/* Will get JSON of the form:\n *   { isEnabled: '1',\n *     isVisible: '1',\n *     frame: '{{0, 0}, {375, 667}}',\n *     children:\n *      [ { isEnabled: '1',\n *          isVisible: '1',\n *          frame: '{{0, 0}, {375, 667}}',\n *          children: [],\n *          rect: { x: 0, y: 0, width: 375, height: 667 },\n *          value: null,\n *          label: null,\n *          type: 'Other',\n *          name: null,\n *          rawIdentifier: null },\n *     rect: { origin: { x: 0, y: 0 }, size: { width: 375, height: 667 } },\n *     value: null,\n *     label: 'UICatalog',\n *     type: 'Application',\n *     name: 'UICatalog',\n *     rawIdentifier: null }\n */\nfunction getTreeForXML (srcTree) {\n  function getTree (element, elementIndex, parentPath) {\n    let curPath = `${parentPath}/${elementIndex}`;\n    let rect = element.rect || {};\n    let subtree = {\n      '@': {\n        type: `XCUIElementType${element.type}`,\n        enabled: parseInt(element.isEnabled, 10) === 1,\n        visible: parseInt(element.isVisible, 10) === 1,\n        x: rect.x,\n        y: rect.y,\n        width: rect.width,\n        height: rect.height,\n      },\n      '>': []\n    };\n    if (element.name !== null) {\n      subtree['@'].name = element.name;\n    }\n    if (element.label !== null) {\n      subtree['@'].label = element.label;\n    }\n    if (element.value !== null) {\n      subtree['@'].value = element.value;\n    }\n    for (let i = 0; i < (element.children || []).length; i++) {\n      subtree['>'].push(getTree(element.children[i], i, curPath));\n    }\n    return {\n      [`XCUIElementType${element.type}`]: subtree\n    };\n  }\n  let tree = getTree(srcTree, 0, '');\n  return tree;\n}\n\nfunction getSourceXml (jsonSource) {\n  return js2xml('AppiumAUT', jsonSource, {\n    wrapArray: {enabled: false, elementName: 'element'},\n    declaration: {include: true},\n    prettyPrinting: {indentString: '  '}\n  });\n}\n\n\nObject.assign(extensions, commands, helpers);\nexport { commands, helpers };\nexport default extensions;\n"],"mappings":"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"}