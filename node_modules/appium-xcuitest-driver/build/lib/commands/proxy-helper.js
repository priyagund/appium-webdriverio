"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.helpers = exports.default = void 0;

require("source-map-support/register");

var _driver = require("appium/driver");

var _bluebird = _interopRequireDefault(require("bluebird"));

const GET = 'GET';
const POST = 'POST';
const DELETE = 'DELETE';
const SUPPORTED_METHODS = [GET, POST, DELETE];
let helpers = {},
    extensions = {};
exports.helpers = helpers;
const WDA_ROUTES = {
  '/wda/touch/perform': {
    POST: 'performTouch'
  },
  '/wda/touch/multi/perform': {
    POST: 'performMultiAction'
  },
  '/wda/screen': {
    GET: 'getScreenInfo'
  },
  '/wda/alert/buttons': {
    GET: 'getAlertButtons'
  },
  '/wda/apps/launch': {
    POST: 'mobileLaunchApp'
  },
  '/wda/apps/terminate': {
    POST: 'mobileTerminateApp'
  },
  '/wda/apps/activate': {
    POST: 'mobileActivateApp'
  },
  '/wda/apps/state': {
    POST: 'mobileQueryAppState'
  },
  '/wda/keys': {
    POST: 'keys'
  },
  '/wda/touch_id': {
    POST: 'touchId'
  },
  '/wda/keyboard/dismiss': {
    POST: 'hideKeyboard'
  },
  '/wda/lock': {
    POST: 'lock'
  },
  '/wda/unlock': {
    POST: 'unlock'
  },
  '/wda/locked': {
    GET: 'isLocked'
  },
  '/wda/tap/nil': {
    POST: 'clickCoords'
  },
  '/window/size': {
    GET: 'getWindowSize'
  }
};

function wdaRouteToCommandName(endpoint, method) {
  return WDA_ROUTES[endpoint] ? WDA_ROUTES[endpoint][method] : null;
}

helpers.proxyCommand = async function proxyCommand(endpoint, method, body, isSessionCommand = true) {
  if (this.shutdownUnexpectedly) {
    return;
  }

  if (!endpoint) {
    this.log.errorAndThrow('Proxying requires an endpoint');
  } else if (!SUPPORTED_METHODS.includes(method)) {
    this.log.errorAndThrow(`Proxying only works for the following requests: ${SUPPORTED_METHODS.join(', ')}`);
  }

  if (!this.wda) {
    throw new Error('Cannot call proxyCommand without WDA driver active');
  }

  const proxy = isSessionCommand ? this.wda.jwproxy : this.wda.noSessionProxy;

  if (!proxy) {
    throw new Error('Cannot call proxyCommand without WDA proxy active');
  }

  let cmdName = wdaRouteToCommandName(endpoint, method) || (0, _driver.routeToCommandName)(endpoint, method);

  const timeout = this._getCommandTimeout(cmdName);

  if (!cmdName) {
    cmdName = 'Unknown';
    this.log.info(`Proxying to WDA with an unknown route: ${method} ${endpoint}`);
  }

  if (!timeout) {
    return await proxy.command(endpoint, method, body);
  }

  this.log.debug(`Setting custom timeout to ${timeout} ms for '${cmdName}' command`);
  let isCommandExpired = false;
  const res = await _bluebird.default.resolve(proxy.command(endpoint, method, body)).timeout(timeout).catch(_bluebird.default.Promise.TimeoutError, () => {
    isCommandExpired = true;
  });

  if (isCommandExpired) {
    proxy.cancelActiveRequests();
    const errMsg = `Appium did not get any response from '${cmdName}' command in ${timeout} ms`;
    await this.startUnexpectedShutdown(new _driver.errors.TimeoutError(errMsg));
    this.log.errorAndThrow(errMsg);
  }

  return res;
};

Object.assign(extensions, helpers);
var _default = extensions;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJHRVQiLCJQT1NUIiwiREVMRVRFIiwiU1VQUE9SVEVEX01FVEhPRFMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIldEQV9ST1VURVMiLCJ3ZGFSb3V0ZVRvQ29tbWFuZE5hbWUiLCJlbmRwb2ludCIsIm1ldGhvZCIsInByb3h5Q29tbWFuZCIsImJvZHkiLCJpc1Nlc3Npb25Db21tYW5kIiwic2h1dGRvd25VbmV4cGVjdGVkbHkiLCJsb2ciLCJlcnJvckFuZFRocm93IiwiaW5jbHVkZXMiLCJqb2luIiwid2RhIiwiRXJyb3IiLCJwcm94eSIsImp3cHJveHkiLCJub1Nlc3Npb25Qcm94eSIsImNtZE5hbWUiLCJyb3V0ZVRvQ29tbWFuZE5hbWUiLCJ0aW1lb3V0IiwiX2dldENvbW1hbmRUaW1lb3V0IiwiaW5mbyIsImNvbW1hbmQiLCJkZWJ1ZyIsImlzQ29tbWFuZEV4cGlyZWQiLCJyZXMiLCJCIiwicmVzb2x2ZSIsImNhdGNoIiwiUHJvbWlzZSIsIlRpbWVvdXRFcnJvciIsImNhbmNlbEFjdGl2ZVJlcXVlc3RzIiwiZXJyTXNnIiwic3RhcnRVbmV4cGVjdGVkU2h1dGRvd24iLCJlcnJvcnMiLCJPYmplY3QiLCJhc3NpZ24iXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvY29tbWFuZHMvcHJveHktaGVscGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycywgcm91dGVUb0NvbW1hbmROYW1lIH0gZnJvbSAnYXBwaXVtL2RyaXZlcic7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cblxuY29uc3QgR0VUID0gJ0dFVCc7XG5jb25zdCBQT1NUID0gJ1BPU1QnO1xuY29uc3QgREVMRVRFID0gJ0RFTEVURSc7XG5jb25zdCBTVVBQT1JURURfTUVUSE9EUyA9IFtHRVQsIFBPU1QsIERFTEVURV07XG5cbmxldCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgV0RBX1JPVVRFUyA9IHtcbiAgJy93ZGEvdG91Y2gvcGVyZm9ybSc6IHtcbiAgICBQT1NUOiAncGVyZm9ybVRvdWNoJyxcbiAgfSxcbiAgJy93ZGEvdG91Y2gvbXVsdGkvcGVyZm9ybSc6IHtcbiAgICBQT1NUOiAncGVyZm9ybU11bHRpQWN0aW9uJyxcbiAgfSxcbiAgJy93ZGEvc2NyZWVuJzoge1xuICAgIEdFVDogJ2dldFNjcmVlbkluZm8nLFxuICB9LFxuICAnL3dkYS9hbGVydC9idXR0b25zJzoge1xuICAgIEdFVDogJ2dldEFsZXJ0QnV0dG9ucycsXG4gIH0sXG4gICcvd2RhL2FwcHMvbGF1bmNoJzoge1xuICAgIFBPU1Q6ICdtb2JpbGVMYXVuY2hBcHAnLFxuICB9LFxuICAnL3dkYS9hcHBzL3Rlcm1pbmF0ZSc6IHtcbiAgICBQT1NUOiAnbW9iaWxlVGVybWluYXRlQXBwJyxcbiAgfSxcbiAgJy93ZGEvYXBwcy9hY3RpdmF0ZSc6IHtcbiAgICBQT1NUOiAnbW9iaWxlQWN0aXZhdGVBcHAnLFxuICB9LFxuICAnL3dkYS9hcHBzL3N0YXRlJzoge1xuICAgIFBPU1Q6ICdtb2JpbGVRdWVyeUFwcFN0YXRlJyxcbiAgfSxcbiAgJy93ZGEva2V5cyc6IHtcbiAgICBQT1NUOiAna2V5cycsXG4gIH0sXG4gICcvd2RhL3RvdWNoX2lkJzoge1xuICAgIFBPU1Q6ICd0b3VjaElkJyxcbiAgfSxcbiAgJy93ZGEva2V5Ym9hcmQvZGlzbWlzcyc6IHtcbiAgICBQT1NUOiAnaGlkZUtleWJvYXJkJyxcbiAgfSxcbiAgJy93ZGEvbG9jayc6IHtcbiAgICBQT1NUOiAnbG9jaycsXG4gIH0sXG4gICcvd2RhL3VubG9jayc6IHtcbiAgICBQT1NUOiAndW5sb2NrJyxcbiAgfSxcbiAgJy93ZGEvbG9ja2VkJzoge1xuICAgIEdFVDogJ2lzTG9ja2VkJyxcbiAgfSxcbiAgJy93ZGEvdGFwL25pbCc6IHtcbiAgICBQT1NUOiAnY2xpY2tDb29yZHMnLFxuICB9LFxuICAnL3dpbmRvdy9zaXplJzoge1xuICAgIEdFVDogJ2dldFdpbmRvd1NpemUnLFxuICB9LFxufTtcblxuZnVuY3Rpb24gd2RhUm91dGVUb0NvbW1hbmROYW1lIChlbmRwb2ludCwgbWV0aG9kKSB7XG4gIHJldHVybiBXREFfUk9VVEVTW2VuZHBvaW50XSA/IFdEQV9ST1VURVNbZW5kcG9pbnRdW21ldGhvZF0gOiBudWxsO1xufVxuXG5oZWxwZXJzLnByb3h5Q29tbWFuZCA9IGFzeW5jIGZ1bmN0aW9uIHByb3h5Q29tbWFuZCAoZW5kcG9pbnQsIG1ldGhvZCwgYm9keSwgaXNTZXNzaW9uQ29tbWFuZCA9IHRydWUpIHtcbiAgaWYgKHRoaXMuc2h1dGRvd25VbmV4cGVjdGVkbHkpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoIWVuZHBvaW50KSB7XG4gICAgdGhpcy5sb2cuZXJyb3JBbmRUaHJvdygnUHJveHlpbmcgcmVxdWlyZXMgYW4gZW5kcG9pbnQnKTtcbiAgfSBlbHNlIGlmICghU1VQUE9SVEVEX01FVEhPRFMuaW5jbHVkZXMobWV0aG9kKSkge1xuICAgIHRoaXMubG9nLmVycm9yQW5kVGhyb3coYFByb3h5aW5nIG9ubHkgd29ya3MgZm9yIHRoZSBmb2xsb3dpbmcgcmVxdWVzdHM6ICR7U1VQUE9SVEVEX01FVEhPRFMuam9pbignLCAnKX1gKTtcbiAgfVxuXG4gIGlmICghdGhpcy53ZGEpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBjYWxsIHByb3h5Q29tbWFuZCB3aXRob3V0IFdEQSBkcml2ZXIgYWN0aXZlJyk7XG4gIH1cbiAgY29uc3QgcHJveHkgPSBpc1Nlc3Npb25Db21tYW5kID8gdGhpcy53ZGEuandwcm94eSA6IHRoaXMud2RhLm5vU2Vzc2lvblByb3h5O1xuICBpZiAoIXByb3h5KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgY2FsbCBwcm94eUNvbW1hbmQgd2l0aG91dCBXREEgcHJveHkgYWN0aXZlJyk7XG4gIH1cblxuICBsZXQgY21kTmFtZSA9IHdkYVJvdXRlVG9Db21tYW5kTmFtZShlbmRwb2ludCwgbWV0aG9kKSB8fCByb3V0ZVRvQ29tbWFuZE5hbWUoZW5kcG9pbnQsIG1ldGhvZCk7XG4gIGNvbnN0IHRpbWVvdXQgPSB0aGlzLl9nZXRDb21tYW5kVGltZW91dChjbWROYW1lKTtcbiAgaWYgKCFjbWROYW1lKSB7XG4gICAgLy8gdGhpcyBzaG91bGQgbmV2ZXIgaGFwcGVuIGV4Y2VwdCB3aGVuIGFkZGluZyBuZXcgcm91dGVzXG4gICAgY21kTmFtZSA9ICdVbmtub3duJzsgLy8ganVzdCBmb3IgbG9nZ2luZyBwdXJwb3NlcyBiZWxvd1xuICAgIHRoaXMubG9nLmluZm8oYFByb3h5aW5nIHRvIFdEQSB3aXRoIGFuIHVua25vd24gcm91dGU6ICR7bWV0aG9kfSAke2VuZHBvaW50fWApO1xuICB9XG5cbiAgaWYgKCF0aW1lb3V0KSB7XG4gICAgcmV0dXJuIGF3YWl0IHByb3h5LmNvbW1hbmQoZW5kcG9pbnQsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICB0aGlzLmxvZy5kZWJ1ZyhgU2V0dGluZyBjdXN0b20gdGltZW91dCB0byAke3RpbWVvdXR9IG1zIGZvciAnJHtjbWROYW1lfScgY29tbWFuZGApO1xuICBsZXQgaXNDb21tYW5kRXhwaXJlZCA9IGZhbHNlO1xuICBjb25zdCByZXMgPSBhd2FpdCBCLnJlc29sdmUocHJveHkuY29tbWFuZChlbmRwb2ludCwgbWV0aG9kLCBib2R5KSlcbiAgICAgICAgICAgICAgICAudGltZW91dCh0aW1lb3V0KVxuICAgICAgICAgICAgICAgIC5jYXRjaChCLlByb21pc2UuVGltZW91dEVycm9yLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpc0NvbW1hbmRFeHBpcmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgaWYgKGlzQ29tbWFuZEV4cGlyZWQpIHtcbiAgICBwcm94eS5jYW5jZWxBY3RpdmVSZXF1ZXN0cygpO1xuICAgIGNvbnN0IGVyck1zZyA9IGBBcHBpdW0gZGlkIG5vdCBnZXQgYW55IHJlc3BvbnNlIGZyb20gJyR7Y21kTmFtZX0nIGNvbW1hbmQgaW4gJHt0aW1lb3V0fSBtc2A7XG4gICAgYXdhaXQgdGhpcy5zdGFydFVuZXhwZWN0ZWRTaHV0ZG93bihuZXcgZXJyb3JzLlRpbWVvdXRFcnJvcihlcnJNc2cpKTtcbiAgICB0aGlzLmxvZy5lcnJvckFuZFRocm93KGVyck1zZyk7XG4gIH1cbiAgcmV0dXJuIHJlcztcbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgaGVscGVycyk7XG5leHBvcnQgeyBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUdBLE1BQU1BLEdBQUcsR0FBRyxLQUFaO0FBQ0EsTUFBTUMsSUFBSSxHQUFHLE1BQWI7QUFDQSxNQUFNQyxNQUFNLEdBQUcsUUFBZjtBQUNBLE1BQU1DLGlCQUFpQixHQUFHLENBQUNILEdBQUQsRUFBTUMsSUFBTixFQUFZQyxNQUFaLENBQTFCO0FBRUEsSUFBSUUsT0FBTyxHQUFHLEVBQWQ7QUFBQSxJQUFrQkMsVUFBVSxHQUFHLEVBQS9COztBQUVBLE1BQU1DLFVBQVUsR0FBRztFQUNqQixzQkFBc0I7SUFDcEJMLElBQUksRUFBRTtFQURjLENBREw7RUFJakIsNEJBQTRCO0lBQzFCQSxJQUFJLEVBQUU7RUFEb0IsQ0FKWDtFQU9qQixlQUFlO0lBQ2JELEdBQUcsRUFBRTtFQURRLENBUEU7RUFVakIsc0JBQXNCO0lBQ3BCQSxHQUFHLEVBQUU7RUFEZSxDQVZMO0VBYWpCLG9CQUFvQjtJQUNsQkMsSUFBSSxFQUFFO0VBRFksQ0FiSDtFQWdCakIsdUJBQXVCO0lBQ3JCQSxJQUFJLEVBQUU7RUFEZSxDQWhCTjtFQW1CakIsc0JBQXNCO0lBQ3BCQSxJQUFJLEVBQUU7RUFEYyxDQW5CTDtFQXNCakIsbUJBQW1CO0lBQ2pCQSxJQUFJLEVBQUU7RUFEVyxDQXRCRjtFQXlCakIsYUFBYTtJQUNYQSxJQUFJLEVBQUU7RUFESyxDQXpCSTtFQTRCakIsaUJBQWlCO0lBQ2ZBLElBQUksRUFBRTtFQURTLENBNUJBO0VBK0JqQix5QkFBeUI7SUFDdkJBLElBQUksRUFB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