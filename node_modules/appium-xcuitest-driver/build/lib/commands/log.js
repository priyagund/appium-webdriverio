"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _driver = require("appium/driver");

var _iosCrashLog = require("../device-log/ios-crash-log");

var _iosSimulatorLog = require("../device-log/ios-simulator-log");

var _iosDeviceLog = require("../device-log/ios-device-log");

var _logger = _interopRequireDefault(require("../logger"));

var _ws = _interopRequireDefault(require("ws"));

var _safariConsoleLog = _interopRequireDefault(require("../device-log/safari-console-log"));

var _safariNetworkLog = _interopRequireDefault(require("../device-log/safari-network-log"));

const extensions = {};

const WEBSOCKET_ENDPOINT = sessionId => `${_driver.DEFAULT_WS_PATHNAME_PREFIX}/session/${sessionId}/appium/device/syslog`;

const GET_SERVER_LOGS_FEATURE = 'get_server_logs';

extensions.extractLogs = async function extractLogs(logType, logsContainer = {}) {
  if (_lodash.default.isEmpty(logsContainer)) {
    throw new Error('No logs currently available. Is the device/simulator started?');
  }

  const logObject = logsContainer[logType];
  const logs = logObject ? await logObject.getLogs() : null;

  if (logs) {
    return logs;
  }

  throw new Error(`No logs of type '${logType}' found.`);
};

extensions.supportedLogTypes = {
  syslog: {
    description: 'System Logs - Device logs for iOS applications on real devices and simulators',
    getter: async self => await self.extractLogs('syslog', self.logs)
  },
  crashlog: {
    description: 'Crash Logs - Crash reports for iOS applications on real devices and simulators',
    getter: async self => await self.extractLogs('crashlog', self.logs)
  },
  performance: {
    description: 'Performance Logs - Debug Timelines on real devices and simulators',
    getter: async self => await self.extractLogs('performance', self.logs)
  },
  safariConsole: {
    description: 'Safari Console Logs - data written to the JS console in Safari',
    getter: async self => await self.extractLogs('safariConsole', self.logs)
  },
  safariNetwork: {
    description: 'Safari Network Logs - information about network operations undertaken by Safari',
    getter: async self => await self.extractLogs('safariNetwork', self.logs)
  },
  server: {
    description: 'Appium server logs',
    getter: self => {
      self.ensureFeatureEnabled(GET_SERVER_LOGS_FEATURE);
      return _logger.default.unwrap().record.map(function (x) {
        return {
          timestamp: Date.now(),
          level: 'ALL',
          message: _lodash.default.isEmpty(x.prefix) ? x.message : `[${x.prefix}] ${x.message}`
        };
      });
    }
  }
};

extensions.startLogCapture = async function startLogCapture() {
  this.logs = this.logs || {};

  if (!_lodash.default.isUndefined(this.logs.syslog) && this.logs.syslog.isCapturing) {
    _logger.default.warn('Trying to start iOS log capture but it has already started!');

    return true;
  }

  if (_lodash.default.isUndefined(this.logs.syslog)) {
    this.logs.crashlog = new _iosCrashLog.IOSCrashLog({
      sim: this.opts.device,
      udid: this.isRealDevice() ? this.opts.udid : undefined
    });

    if (this.isRealDevice()) {
      this.logs.syslog = new _iosDeviceLog.IOSDeviceLog({
        udid: this.opts.udid,
        showLogs: this.opts.showIOSLog
      });
    } else {
      this.logs.syslog = new _iosSimulatorLog.IOSSimulatorLog({
        sim: this.opts.device,
        showLogs: this.opts.showIOSLog,
        xcodeVersion: this.xcodeVersion,
        iosSimulatorLogsPredicate: this.opts.iosSimulatorLogsPredicate
      });
    }

    this.logs.safariConsole = new _safariConsoleLog.default(!!this.opts.showSafariConsoleLog);
    this.logs.safariNetwork = new _safariNetworkLog.default(!!this.opts.showSafariNetworkLog);
  }

  try {
    await this.logs.syslog.startCapture();
  } catch (err) {
    _logger.default.warn(`Continuing without capturing device logs: ${err.message}`);

    return false;
  }

  await this.logs.crashlog.startCapture();
  await this.logs.safariConsole.startCapture();
  await this.logs.safariNetwork.startCapture();
  return true;
};

extensions.mobileStartLogsBroadcast = async function mobileStartLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (!_lodash.default.isEmpty(await this.server.getWebSocketHandlers(pathname))) {
    _logger.default.debug(`The system logs broadcasting web socket server is already listening at ${pathname}`);

    return;
  }

  _logger.default.info(`Assigning system logs broadcasting web socket server to ${pathname}`);

  const wss = new _ws.default.Server({
    noServer: true
  });
  wss.on('connection', (ws, req) => {
    if (req) {
      var _req$connection;

      const remoteIp = _lodash.default.isEmpty(req.headers['x-forwarded-for']) ? (_req$connection = req.connection) === null || _req$connection === void 0 ? void 0 : _req$connection.remoteAddress : req.headers['x-forwarded-for'];

      _logger.default.debug(`Established a new system logs listener web socket connection from ${remoteIp}`);
    } else {
      _logger.default.debug('Established a new system logs listener web socket connection');
    }

    if (_lodash.default.isEmpty(this._syslogWebsocketListener)) {
      this._syslogWebsocketListener = logRecord => {
        if ((ws === null || ws === void 0 ? void 0 : ws.readyState) === _ws.default.OPEN) {
          ws.send(logRecord.message);
        }
      };
    }

    this.logs.syslog.on('output', this._syslogWebsocketListener);
    ws.on('close', (code, reason) => {
      if (!_lodash.default.isEmpty(this._syslogWebsocketListener)) {
        this.logs.syslog.removeListener('output', this._syslogWebsocketListener);
        this._syslogWebsocketListener = null;
      }

      let closeMsg = 'System logs listener web socket is closed.';

      if (!_lodash.default.isEmpty(code)) {
        closeMsg += ` Code: ${code}.`;
      }

      if (!_lodash.default.isEmpty(reason)) {
        closeMsg += ` Reason: ${reason.toString()}.`;
      }

      _logger.default.debug(closeMsg);
    });
  });
  await this.server.addWebSocketHandler(pathname, wss);
};

extensions.mobileStopLogsBroadcast = async function mobileStopLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (_lodash.default.isEmpty(await this.server.getWebSocketHandlers(pathname))) {
    return;
  }

  _logger.default.debug('Stopping the system logs broadcasting web socket server');

  await this.server.removeWebSocketHandler(pathname);
};

var _default = extensions;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJleHRlbnNpb25zIiwiV0VCU09DS0VUX0VORFBPSU5UIiwic2Vzc2lvbklkIiwiREVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVgiLCJHRVRfU0VSVkVSX0xPR1NfRkVBVFVSRSIsImV4dHJhY3RMb2dzIiwibG9nVHlwZSIsImxvZ3NDb250YWluZXIiLCJfIiwiaXNFbXB0eSIsIkVycm9yIiwibG9nT2JqZWN0IiwibG9ncyIsImdldExvZ3MiLCJzdXBwb3J0ZWRMb2dUeXBlcyIsInN5c2xvZyIsImRlc2NyaXB0aW9uIiwiZ2V0dGVyIiwic2VsZiIsImNyYXNobG9nIiwicGVyZm9ybWFuY2UiLCJzYWZhcmlDb25zb2xlIiwic2FmYXJpTmV0d29yayIsInNlcnZlciIsImVuc3VyZUZlYXR1cmVFbmFibGVkIiwibG9nIiwidW53cmFwIiwicmVjb3JkIiwibWFwIiwieCIsInRpbWVzdGFtcCIsIkRhdGUiLCJub3ciLCJsZXZlbCIsIm1lc3NhZ2UiLCJwcmVmaXgiLCJzdGFydExvZ0NhcHR1cmUiLCJpc1VuZGVmaW5lZCIsImlzQ2FwdHVyaW5nIiwid2FybiIsIklPU0NyYXNoTG9nIiwic2ltIiwib3B0cyIsImRldmljZSIsInVkaWQiLCJpc1JlYWxEZXZpY2UiLCJ1bmRlZmluZWQiLCJJT1NEZXZpY2VMb2ciLCJzaG93TG9ncyIsInNob3dJT1NMb2ciLCJJT1NTaW11bGF0b3JMb2ciLCJ4Y29kZVZlcnNpb24iLCJpb3NTaW11bGF0b3JMb2dzUHJlZGljYXRlIiwiU2FmYXJpQ29uc29sZUxvZyIsInNob3dTYWZhcmlDb25zb2xlTG9nIiwiU2FmYXJpTmV0d29ya0xvZyIsInNob3dTYWZhcmlOZXR3b3JrTG9nIiwic3RhcnRDYXB0dXJlIiwiZXJyIiwibW9iaWxlU3RhcnRMb2dzQnJvYWRjYXN0IiwicGF0aG5hbWUiLCJnZXRXZWJTb2NrZXRIYW5kbGVycyIsImRlYnVnIiwiaW5mbyIsIndzcyIsIldlYlNvY2tldCIsIlNlcnZlciIsIm5vU2VydmVyIiwib24iLCJ3cyIsInJlcSIsInJlbW90ZUlwIiwiaGVhZGVycyIsImNvbm5lY3Rpb24iLCJyZW1vdGVBZGRyZXNzIiwiX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyIiwibG9nUmVjb3JkIiwicmVhZHlTdGF0ZSIsIk9QRU4iLCJzZW5kIiwiY29kZSIsInJlYXNvbiIsInJlbW92ZUxpc3RlbmVyIiwiY2xvc2VNc2ciLCJ0b1N0cmluZyIsImFkZFdlYlNvY2tldEhhbmRsZXIiLCJtb2JpbGVTdG9wTG9nc0Jyb2FkY2FzdCIsInJlbW92ZVdlYlNvY2tldEhhbmRsZXIiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvY29tbWFuZHMvbG9nLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWCB9IGZyb20gJ2FwcGl1bS9kcml2ZXInO1xuaW1wb3J0IHsgSU9TQ3Jhc2hMb2cgfSBmcm9tICcuLi9kZXZpY2UtbG9nL2lvcy1jcmFzaC1sb2cnO1xuaW1wb3J0IHsgSU9TU2ltdWxhdG9yTG9nIH0gZnJvbSAnLi4vZGV2aWNlLWxvZy9pb3Mtc2ltdWxhdG9yLWxvZyc7XG5pbXBvcnQgeyBJT1NEZXZpY2VMb2cgfSBmcm9tICcuLi9kZXZpY2UtbG9nL2lvcy1kZXZpY2UtbG9nJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnd3MnO1xuaW1wb3J0IFNhZmFyaUNvbnNvbGVMb2cgZnJvbSAnLi4vZGV2aWNlLWxvZy9zYWZhcmktY29uc29sZS1sb2cnO1xuaW1wb3J0IFNhZmFyaU5ldHdvcmtMb2cgZnJvbSAnLi4vZGV2aWNlLWxvZy9zYWZhcmktbmV0d29yay1sb2cnO1xuXG5cbmNvbnN0IGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgV0VCU09DS0VUX0VORFBPSU5UID0gKHNlc3Npb25JZCkgPT4gYCR7REVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVh9L3Nlc3Npb24vJHtzZXNzaW9uSWR9L2FwcGl1bS9kZXZpY2Uvc3lzbG9nYDtcbmNvbnN0IEdFVF9TRVJWRVJfTE9HU19GRUFUVVJFID0gJ2dldF9zZXJ2ZXJfbG9ncyc7XG5cbmV4dGVuc2lvbnMuZXh0cmFjdExvZ3MgPSBhc3luYyBmdW5jdGlvbiBleHRyYWN0TG9ncyAobG9nVHlwZSwgbG9nc0NvbnRhaW5lciA9IHt9KSB7XG4gIC8vIG1ha2Ugc3VyZSB0aGF0IHdlIGhhdmUgbG9ncyBhdCBhbGxcbiAgLy8gb3RoZXJ3aXNlIGl0J3Mgbm90IGJlZW4gaW5pdGlhbGl6ZWRcbiAgaWYgKF8uaXNFbXB0eShsb2dzQ29udGFpbmVyKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTm8gbG9ncyBjdXJyZW50bHkgYXZhaWxhYmxlLiBJcyB0aGUgZGV2aWNlL3NpbXVsYXRvciBzdGFydGVkPycpO1xuICB9XG5cbiAgLy8gSWYgbG9ncyBjYXB0dXJlZCBzdWNjZXNzZnVsbHkgc2VuZCByZXNwb25zZSB3aXRoIGRhdGEsIGVsc2Ugc2VuZCBlcnJvclxuICBjb25zdCBsb2dPYmplY3QgPSBsb2dzQ29udGFpbmVyW2xvZ1R5cGVdO1xuICBjb25zdCBsb2dzID0gbG9nT2JqZWN0ID8gYXdhaXQgbG9nT2JqZWN0LmdldExvZ3MoKSA6IG51bGw7XG4gIGlmIChsb2dzKSB7XG4gICAgcmV0dXJuIGxvZ3M7XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBObyBsb2dzIG9mIHR5cGUgJyR7bG9nVHlwZX0nIGZvdW5kLmApO1xufTtcblxuZXh0ZW5zaW9ucy5zdXBwb3J0ZWRMb2dUeXBlcyA9IHtcbiAgc3lzbG9nOiB7XG4gICAgZGVzY3JpcHRpb246ICdTeXN0ZW0gTG9ncyAtIERldmljZSBsb2dzIGZvciBpT1MgYXBwbGljYXRpb25zIG9uIHJlYWwgZGV2aWNlcyBhbmQgc2ltdWxhdG9ycycsXG4gICAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4gYXdhaXQgc2VsZi5leHRyYWN0TG9ncygnc3lzbG9nJywgc2VsZi5sb2dzKSxcbiAgfSxcbiAgY3Jhc2hsb2c6IHtcbiAgICBkZXNjcmlwdGlvbjogJ0NyYXNoIExvZ3MgLSBDcmFzaCByZXBvcnRzIGZvciBpT1MgYXBwbGljYXRpb25zIG9uIHJlYWwgZGV2aWNlcyBhbmQgc2ltdWxhdG9ycycsXG4gICAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4gYXdhaXQgc2VsZi5leHRyYWN0TG9ncygnY3Jhc2hsb2cnLCBzZWxmLmxvZ3MpLFxuICB9LFxuICBwZXJmb3JtYW5jZToge1xuICAgIGRlc2NyaXB0aW9uOiAnUGVyZm9ybWFuY2UgTG9ncyAtIERlYnVnIFRpbWVsaW5lcyBvbiByZWFsIGRldmljZXMgYW5kIHNpbXVsYXRvcnMnLFxuICAgIGdldHRlcjogYXN5bmMgKHNlbGYpID0+IGF3YWl0IHNlbGYuZXh0cmFjdExvZ3MoJ3BlcmZvcm1hbmNlJywgc2VsZi5sb2dzKSxcbiAgfSxcbiAgc2FmYXJpQ29uc29sZToge1xuICAgIGRlc2NyaXB0aW9uOiAnU2FmYXJpIENvbnNvbGUgTG9ncyAtIGRhdGEgd3JpdHRlbiB0byB0aGUgSlMgY29uc29sZSBpbiBTYWZhcmknLFxuICAgIGdldHRlcjogYXN5bmMgKHNlbGYpID0+IGF3YWl0IHNlbGYuZXh0cmFjdExvZ3MoJ3NhZmFyaUNvbnNvbGUnLCBzZWxmLmxvZ3MpLFxuICB9LFxuICBzYWZhcmlOZXR3b3JrOiB7XG4gICAgZGVzY3JpcHRpb246ICdTYWZhcmkgTmV0d29yayBMb2dzIC0gaW5mb3JtYXRpb24gYWJvdXQgbmV0d29yayBvcGVyYXRpb25zIHVuZGVydGFrZW4gYnkgU2FmYXJpJyxcbiAgICBnZXR0ZXI6IGFzeW5jIChzZWxmKSA9PiBhd2FpdCBzZWxmLmV4dHJhY3RMb2dzKCdzYWZhcmlOZXR3b3JrJywgc2VsZi5sb2dzKSxcbiAgfSxcbiAgc2VydmVyOiB7XG4gICAgZGVzY3JpcHRpb246ICdBcHBpdW0gc2VydmVyIGxvZ3MnLFxuICAgIGdldHRlcjogKHNlbGYpID0+IHtcbiAgICAgIHNlbGYuZW5zdXJlRmVhdHVyZUVuYWJsZWQoR0VUX1NFUlZFUl9MT0dTX0ZFQVRVUkUpO1xuICAgICAgcmV0dXJuIGxvZy51bndyYXAoKS5yZWNvcmRcbiAgICAgICAgLm1hcChmdW5jdGlvbiAoeCkge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAvLyBucG1sb2cgZG9lcyBub3Qga2VlcCB0aW1lc3RhbXBzIGluIHRoZSBoaXN0b3J5XG4gICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAgICBsZXZlbDogJ0FMTCcsXG4gICAgICAgICAgICBtZXNzYWdlOiBfLmlzRW1wdHkoeC5wcmVmaXgpID8geC5tZXNzYWdlIDogYFske3gucHJlZml4fV0gJHt4Lm1lc3NhZ2V9YCxcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9LFxuICB9LFxufTtcblxuZXh0ZW5zaW9ucy5zdGFydExvZ0NhcHR1cmUgPSBhc3luYyBmdW5jdGlvbiBzdGFydExvZ0NhcHR1cmUgKCkge1xuICB0aGlzLmxvZ3MgPSB0aGlzLmxvZ3MgfHwge307XG4gIGlmICghXy5pc1VuZGVmaW5lZCh0aGlzLmxvZ3Muc3lzbG9nKSAmJiB0aGlzLmxvZ3Muc3lzbG9nLmlzQ2FwdHVyaW5nKSB7XG4gICAgbG9nLndhcm4oJ1RyeWluZyB0byBzdGFydCBpT1MgbG9nIGNhcHR1cmUgYnV0IGl0IGhhcyBhbHJlYWR5IHN0YXJ0ZWQhJyk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgaWYgKF8uaXNVbmRlZmluZWQodGhpcy5sb2dzLnN5c2xvZykpIHtcbiAgICB0aGlzLmxvZ3MuY3Jhc2hsb2cgPSBuZXcgSU9TQ3Jhc2hMb2coe1xuICAgICAgc2ltOiB0aGlzLm9wdHMuZGV2aWNlLFxuICAgICAgdWRpZDogdGhpcy5pc1JlYWxEZXZpY2UoKSA/IHRoaXMub3B0cy51ZGlkIDogdW5kZWZpbmVkLFxuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIHRoaXMubG9ncy5zeXNsb2cgPSBuZXcgSU9TRGV2aWNlTG9nKHtcbiAgICAgICAgdWRpZDogdGhpcy5vcHRzLnVkaWQsXG4gICAgICAgIHNob3dMb2dzOiB0aGlzLm9wdHMuc2hvd0lPU0xvZyxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvZ3Muc3lzbG9nID0gbmV3IElPU1NpbXVsYXRvckxvZyh7XG4gICAgICAgIHNpbTogdGhpcy5vcHRzLmRldmljZSxcbiAgICAgICAgc2hvd0xvZ3M6IHRoaXMub3B0cy5zaG93SU9TTG9nLFxuICAgICAgICB4Y29kZVZlcnNpb246IHRoaXMueGNvZGVWZXJzaW9uLFxuICAgICAgICBpb3NTaW11bGF0b3JMb2dzUHJlZGljYXRlOiB0aGlzLm9wdHMuaW9zU2ltdWxhdG9yTG9nc1ByZWRpY2F0ZSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLmxvZ3Muc2FmYXJpQ29uc29sZSA9IG5ldyBTYWZhcmlDb25zb2xlTG9nKCEhdGhpcy5vcHRzLnNob3dTYWZhcmlDb25zb2xlTG9nKTtcbiAgICB0aGlzLmxvZ3Muc2FmYXJpTmV0d29yayA9IG5ldyBTYWZhcmlOZXR3b3JrTG9nKCEhdGhpcy5vcHRzLnNob3dTYWZhcmlOZXR3b3JrTG9nKTtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IHRoaXMubG9ncy5zeXNsb2cuc3RhcnRDYXB0dXJlKCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDb250aW51aW5nIHdpdGhvdXQgY2FwdHVyaW5nIGRldmljZSBsb2dzOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICBhd2FpdCB0aGlzLmxvZ3MuY3Jhc2hsb2cuc3RhcnRDYXB0dXJlKCk7XG4gIGF3YWl0IHRoaXMubG9ncy5zYWZhcmlDb25zb2xlLnN0YXJ0Q2FwdHVyZSgpO1xuICBhd2FpdCB0aGlzLmxvZ3Muc2FmYXJpTmV0d29yay5zdGFydENhcHR1cmUoKTtcblxuICByZXR1cm4gdHJ1ZTtcbn07XG5cbi8qKlxuICogU3RhcnRzIGlPUyBzeXN0ZW0gbG9ncyBicm9hZGNhc3Qgd2Vic29ja2V0IG9uIHRoZSBzYW1lIGhvc3QgYW5kIHBvcnRcbiAqIHdoZXJlIEFwcGl1bSBzZXJ2ZXIgaXMgcnVubmluZyBhdCBgL3dzL3Nlc3Npb24vOnNlc3Npb25JZDovYXBwaXVtL3N5c2xvZ2AgZW5kcG9pbnQuIFRoZSBtZXRob2RcbiAqIHdpbGwgcmV0dXJuIGltbWVkaWF0ZWx5IGlmIHRoZSB3ZWIgc29ja2V0IGlzIGFscmVhZHkgbGlzdGVuaW5nLlxuICpcbiAqIEVhY2ggY29ubmVjdGVkIHdlYmNva2V0IGxpc3RlbmVyIHdpbGwgcmVjZWl2ZSBzeXNsb2cgbGluZXNcbiAqIGFzIHNvb24gYXMgdGhleSBhcmUgdmlzaWJsZSB0byBBcHBpdW0uXG4gKi9cbmV4dGVuc2lvbnMubW9iaWxlU3RhcnRMb2dzQnJvYWRjYXN0ID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlU3RhcnRMb2dzQnJvYWRjYXN0ICgpIHtcbiAgY29uc3QgcGF0aG5hbWUgPSBXRUJTT0NLRVRfRU5EUE9JTlQodGhpcy5zZXNzaW9uSWQpO1xuICBpZiAoIV8uaXNFbXB0eShhd2FpdCB0aGlzLnNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycyhwYXRobmFtZSkpKSB7XG4gICAgbG9nLmRlYnVnKGBUaGUgc3lzdGVtIGxvZ3MgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyIGlzIGFscmVhZHkgbGlzdGVuaW5nIGF0ICR7cGF0aG5hbWV9YCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmluZm8oYEFzc2lnbmluZyBzeXN0ZW0gbG9ncyBicm9hZGNhc3Rpbmcgd2ViIHNvY2tldCBzZXJ2ZXIgdG8gJHtwYXRobmFtZX1gKTtcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3dlYnNvY2tldHMvd3MvYmxvYi9tYXN0ZXIvZG9jL3dzLm1kXG4gIGNvbnN0IHdzcyA9IG5ldyBXZWJTb2NrZXQuU2VydmVyKHtcbiAgICBub1NlcnZlcjogdHJ1ZSxcbiAgfSk7XG4gIHdzcy5vbignY29ubmVjdGlvbicsICh3cywgcmVxKSA9PiB7XG4gICAgaWYgKHJlcSkge1xuICAgICAgY29uc3QgcmVtb3RlSXAgPSBfLmlzRW1wdHkocmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddKVxuICAgICAgICA/IHJlcS5jb25uZWN0aW9uPy5yZW1vdGVBZGRyZXNzXG4gICAgICAgIDogcmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddO1xuICAgICAgbG9nLmRlYnVnKGBFc3RhYmxpc2hlZCBhIG5ldyBzeXN0ZW0gbG9ncyBsaXN0ZW5lciB3ZWIgc29ja2V0IGNvbm5lY3Rpb24gZnJvbSAke3JlbW90ZUlwfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoJ0VzdGFibGlzaGVkIGEgbmV3IHN5c3RlbSBsb2dzIGxpc3RlbmVyIHdlYiBzb2NrZXQgY29ubmVjdGlvbicpO1xuICAgIH1cblxuICAgIGlmIChfLmlzRW1wdHkodGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIpKSB7XG4gICAgICB0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lciA9IChsb2dSZWNvcmQpID0+IHtcbiAgICAgICAgaWYgKHdzPy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikge1xuICAgICAgICAgIHdzLnNlbmQobG9nUmVjb3JkLm1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cbiAgICB0aGlzLmxvZ3Muc3lzbG9nLm9uKCdvdXRwdXQnLCB0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lcik7XG5cbiAgICB3cy5vbignY2xvc2UnLCAoY29kZSwgcmVhc29uKSA9PiB7XG4gICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lcikpIHtcbiAgICAgICAgdGhpcy5sb2dzLnN5c2xvZy5yZW1vdmVMaXN0ZW5lcignb3V0cHV0JywgdGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIpO1xuICAgICAgICB0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lciA9IG51bGw7XG4gICAgICB9XG5cbiAgICAgIGxldCBjbG9zZU1zZyA9ICdTeXN0ZW0gbG9ncyBsaXN0ZW5lciB3ZWIgc29ja2V0IGlzIGNsb3NlZC4nO1xuICAgICAgaWYgKCFfLmlzRW1wdHkoY29kZSkpIHtcbiAgICAgICAgY2xvc2VNc2cgKz0gYCBDb2RlOiAke2NvZGV9LmA7XG4gICAgICB9XG4gICAgICBpZiAoIV8uaXNFbXB0eShyZWFzb24pKSB7XG4gICAgICAgIGNsb3NlTXNnICs9IGAgUmVhc29uOiAke3JlYXNvbi50b1N0cmluZygpfS5gO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGNsb3NlTXNnKTtcbiAgICB9KTtcbiAgfSk7XG4gIGF3YWl0IHRoaXMuc2VydmVyLmFkZFdlYlNvY2tldEhhbmRsZXIocGF0aG5hbWUsIHdzcyk7XG59O1xuXG4vKipcbiAqIFN0b3BzIHRoZSBwcmV2aW91c2x5IHN0YXJ0ZWQgc3lzbG9nIGJyb2FkY2FzdGluZyB3ZXNvY2tldCBzZXJ2ZXIuXG4gKiBUaGlzIG1ldGhvZCB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiBubyBzZXJ2ZXIgaXMgcnVubmluZy5cbiAqL1xuZXh0ZW5zaW9ucy5tb2JpbGVTdG9wTG9nc0Jyb2FkY2FzdCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVN0b3BMb2dzQnJvYWRjYXN0ICgpIHtcbiAgY29uc3QgcGF0aG5hbWUgPSBXRUJTT0NLRVRfRU5EUE9JTlQodGhpcy5zZXNzaW9uSWQpO1xuICBpZiAoXy5pc0VtcHR5KGF3YWl0IHRoaXMuc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKHBhdGhuYW1lKSkpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuZGVidWcoJ1N0b3BwaW5nIHRoZSBzeXN0ZW0gbG9ncyBicm9hZGNhc3Rpbmcgd2ViIHNvY2tldCBzZXJ2ZXInKTtcbiAgYXdhaXQgdGhpcy5zZXJ2ZXIucmVtb3ZlV2ViU29ja2V0SGFuZGxlcihwYXRobmFtZSk7XG59O1xuXG5cbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4i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